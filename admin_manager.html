<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>OmniCare EIS · 관리자 페이지</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css" />

<style>
  html,body{ font-family:"Pretendard Variable", system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
  .card{
    border:1px solid #e5e7eb; border-radius:16px; background:#fff;
    box-shadow:0 8px 24px rgba(15,23,42,.06);
  }
  .muted{ color:#64748b; }
  .divider{ height:1px; background:#e5e7eb; }
  .chip{ border:1px solid #e5e7eb; border-radius:999px; padding:.25rem .6rem; font-size:.8rem; color:#334155; background:#f8fafc; }
  .btn2{ border:1px solid #e5e7eb; background:#fff; color:#0f172a; border-radius:12px; padding:.55rem .9rem; font-weight:800; }
  .small{ font-size:.85rem; }
  .kpi{
    border:1px solid #e5e7eb; border-radius:14px; padding:14px; background:linear-gradient(180deg,#fff,#f8fafc);
  }
  table{ width:100%; border-collapse:separate; border-spacing:0; }
  th,td{ padding:12px 10px; border-bottom:1px solid #e5e7eb; vertical-align:top; }
  th{ text-align:left; font-size:.85rem; color:#334155; background:#f8fafc; position:sticky; top:0; }
  td{ color:#0f172a; }
  tr.rowClickable{ cursor:pointer; }
  tr.rowClickable:hover td{ background:#f8fafc; }
  tr.rowActive td{ background:#eff6ff; }

  .pill{
    display:inline-flex; align-items:center; gap:6px;
    border:1px solid #e5e7eb; border-radius:999px;
    padding:.25rem .6rem; font-size:.8rem; background:#fff;
    white-space:nowrap;
  }
  .legendDot{ width:10px; height:10px; border-radius:999px; display:inline-block; }

  /* ===== 매출 구성 그래프(스택 바) ===== */
  .stackBarWrap{
    border:1px solid #e5e7eb;
    border-radius:14px;
    background:#fff;
    padding:12px;
  }
  .stackBar{
    width:100%;
    height:16px;
    border-radius:999px;
    overflow:hidden;
    display:flex;
    border:1px solid #e5e7eb;
    background:#f8fafc;
  }
  .seg{ height:100%; }
  .seg.a{ background:#60a5fa; }   /* 3자 */
  .seg.b{ background:#34d399; }   /* withKMI */
  .seg.c{ background:#fbbf24; }   /* 기타 */

  /* ===== 미니 브레이크다운 ===== */
  .subline{
    margin-top:6px;
    font-size:.82rem;
    color:#64748b;
    font-weight:700;
    line-height:1.25rem;
    display:flex;
    flex-wrap:wrap;
    gap:6px 10px;
  }
  .subtag{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:.15rem .55rem;
    border:1px solid #e5e7eb;
    border-radius:999px;
    background:#fff;
    white-space:nowrap;
  }

  /* ✅ 수검자 구분 전용 색상(매출 색상과 구분) */
  .exDot1{ background:#a78bfa; }  /* 종검 - violet */
  .exDot2{ background:#fb7185; }  /* 종검 외 - rose */
  .exDot3{ background:#22c55e; }  /* 국가 - green */

  /* ===== 검색/컨트롤 바 ===== */
  .controlBar{
    border:1px solid #e5e7eb;
    border-radius:16px;
    background:linear-gradient(180deg,#fff,#f8fafc);
    padding:12px;
  }
  .searchInput{
    width:100%;
    border:1px solid #e5e7eb;
    border-radius:12px;
    padding:.65rem .85rem;
    outline:none;
    background:#fff;
    font-weight:800;
  }
  .selectInput{
    border:1px solid #e5e7eb;
    border-radius:12px;
    padding:.6rem .8rem;
    outline:none;
    background:#fff;
    font-weight:800;
    min-width: 160px;
  }
  .btn3{
    border:1px solid #e5e7eb;
    background:#fff;
    color:#0f172a;
    border-radius:12px;
    padding:.6rem .9rem;
    font-weight:900;
  }
  .btn3:hover{ background:#f8fafc; }
  .hintBadge{
    display:inline-flex; align-items:center; gap:8px;
    border:1px solid #e5e7eb; border-radius:999px;
    padding:.35rem .7rem; background:#fff; font-size:.85rem;
    color:#334155; font-weight:800;
  }

  /* ===== 회의록 완료 스타일 ===== */
  tr.meetingDone td{
    background:#f0fdf4;
  }
  tr.meetingDone td .meetingTitle,
  tr.meetingDone td .meetingTask{
    color:#166534;
  }
  tr.meetingDone td .meetingTitle{
    text-decoration: line-through;
    text-decoration-thickness: 2px;
    text-decoration-color: rgba(22,101,52,.35);
  }
</style>
</head>

<body class="bg-slate-50">

<header class="sticky top-0 z-20 bg-white/90 backdrop-blur border-b border-slate-200">
  <div class="max-w-[1440px] mx-auto px-2 py-3 flex items-center gap-3">
    <a href="https://qkr3069-beep.github.io/EIS/" aria-label="메인으로 이동">
      <img src="omnicare_logo.png" alt="옴니케어 로고" class="h-12 object-contain cursor-pointer" />
    </a>
    <div class="flex-1">
      <div class="font-semibold text-slate-900">관리자 페이지</div>
      <div class="text-sm muted">관리자 회의록 · 부서별 개요 · 직원별 현황 · 선택 직원 거래처</div>
    </div>
    <button onclick="location.href='index.html'" class="btn2">메인</button>
    <button onclick="location.href='mypage_sales.html'" class="btn2">마이페이지</button>
  </div>
</header>

<main class="max-w-[1440px] mx-auto px-2 py-6 space-y-6">

  <!-- ✅✅ NEW: 관리자 회의록 (페이지 최상단) -->
  <section class="card p-5">
    <div class="flex items-start justify-between gap-3">
      <div>
        <div class="font-extrabold text-slate-900 text-lg">관리자 회의록</div>
        <div class="muted small">안건별 진행/완료 여부를 체크하여 관리합니다. (체크 상태는 브라우저에 저장됩니다)</div>
      </div>
      <span class="chip">MINUTES</span>
    </div>

    <div class="divider my-4"></div>

    <div class="overflow-auto rounded-2xl border border-slate-200">
      <table>
        <thead>
          <tr>
            <th style="min-width:90px;">완료</th>
            <th style="min-width:140px;">등록일</th>
            <th style="min-width:240px;">안건</th>
            <th style="min-width:420px;">완료 업무</th>
          </tr>
        </thead>
        <tbody id="meetingTbody"></tbody>
      </table>
    </div>

    <div class="mt-3 muted small">
      * 체크하면 완료 처리되며, 완료된 안건은 연한 초록 배경 및 취소선으로 표시됩니다.
    </div>
  </section>

  <!-- 상단: 팀 필터 + KPI(1줄 5개) + 매출구성 -->
  <section class="card p-5">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div>
        <div class="font-extrabold text-slate-900 text-lg">부서별 개요</div>
        <div class="muted small">선택한 팀 기준으로 KPI와 매출 구성이 갱신됩니다.</div>
      </div>

      <div class="flex items-center gap-2">
        <span class="chip">FILTER</span>
        <select id="deptSelect" class="btn2 px-3 py-2 font-bold">
          <option value="ALL">전체</option>
        </select>
      </div>
    </div>

    <div class="divider my-4"></div>

    <!-- ✅ 한 줄(가로) 5개 고정: xl 이상 5열, 그 이하는 반응형 -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-3" id="deptKpis"></div>

    <div class="mt-4">
      <div class="flex items-center justify-between">
        <div class="font-extrabold text-slate-900">매출 구성</div>
        <span class="chip">MIX</span>
      </div>
      <div class="muted small mt-1">3자 / withKMI / 기타 합계가 금년도 누적 매출 합계가 되도록 집계됩니다. (단위: 천원)</div>

      <div class="mt-3 stackBarWrap">
        <div class="stackBar" id="mixBar"></div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-3 text-sm">
          <div class="flex items-center justify-between rounded-xl border border-slate-200 bg-white px-3 py-2">
            <div class="flex items-center gap-2">
              <span class="legendDot" style="background:#60a5fa;"></span>
              <span class="font-bold text-slate-900">3자</span>
            </div>
            <div class="muted"><span id="mixA">0</span> · <span id="mixAp">0%</span></div>
          </div>
          <div class="flex items-center justify-between rounded-xl border border-slate-200 bg-white px-3 py-2">
            <div class="flex items-center gap-2">
              <span class="legendDot" style="background:#34d399;"></span>
              <span class="font-bold text-slate-900">withKMI</span>
            </div>
            <div class="muted"><span id="mixB">0</span> · <span id="mixBp">0%</span></div>
          </div>
          <div class="flex items-center justify-between rounded-xl border border-slate-200 bg-white px-3 py-2">
            <div class="flex items-center gap-2">
              <span class="legendDot" style="background:#fbbf24;"></span>
              <span class="font-bold text-slate-900">기타</span>
            </div>
            <div class="muted"><span id="mixC">0</span> · <span id="mixCp">0%</span></div>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-3 muted small">
      * 직원별 현황에서 체크된 직원들의 거래처가 아래에 합쳐서 노출됩니다.
    </div>
  </section>

  <!-- 직원별 현황 -->
  <section class="card p-5">
    <div class="flex items-start justify-between gap-3">
      <div>
        <div class="font-extrabold text-slate-900 text-lg">직원별 현황</div>
        <div class="muted small">검색 후 체크박스로 다중 선택 → 아래에 거래처가 합쳐져서 노출됩니다.</div>
      </div>
      <span class="chip">PEOPLE</span>
    </div>

    <div class="mt-3 controlBar">
      <div class="flex flex-col lg:flex-row lg:items-center gap-2">
        <input id="staffSearch" class="searchInput flex-1" placeholder="직원 이름 검색 (예: 김영업) — 입력 즉시 필터링" />
        <select id="staffTeamFilter" class="selectInput">
          <option value="ALL">팀 전체</option>
        </select>
        <button id="clearCheckedBtn" class="btn3">체크 해제</button>
      </div>

      <div class="mt-2 flex flex-wrap items-center gap-2">
        <span class="hintBadge">선택 직원: <span id="checkedCount">0</span>명</span>
        <span class="hintBadge">선택 거래처: <span id="checkedAccountsCount">0</span>개</span>
        <span class="hintBadge">선택 누적 수검자: <span id="checkedExamCount">0</span></span>
        <span class="hintBadge">선택 누적 매출: <span id="checkedSalesSum">0</span> (천원)</span>
      </div>
    </div>

    <div class="divider my-4"></div>

    <div class="overflow-auto max-h-[520px] rounded-2xl border border-slate-200">
      <table>
        <thead>
          <tr>
            <th style="min-width:70px;">선택</th>
            <th style="min-width:130px;">직원</th>
            <th style="min-width:110px;">팀</th>
            <th style="min-width:130px;">거래처 수</th>
            <th style="min-width:140px;">활성 거래처 수</th>
            <th style="min-width:150px;">누적 수검자 수</th>
            <th style="min-width:220px;">금년도 누적 매출(천원)</th>
          </tr>
        </thead>
        <tbody id="staffTbody"></tbody>
      </table>
    </div>

    <div class="mt-3 muted small">
      * 체크박스는 다중 선택용입니다. (행 클릭도 체크/해제를 토글합니다)
    </div>
  </section>

  <!-- ✅ 체크된 직원들의 거래처(합산) -->
  <section class="card p-5" id="accountSection" style="display:none;">
    <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
      <div>
        <div class="font-extrabold text-slate-900 text-lg" id="accountTitle">— 선택 직원 담당 거래처</div>
        <div class="muted small" id="accountSub">체크된 직원들의 거래처가 합쳐져 노출됩니다.</div>
      </div>
      <span class="chip">ACCOUNTS</span>
    </div>

    <div class="divider my-4"></div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-3" id="accountKpis"></div>

    <div class="divider my-4"></div>

    <div class="overflow-auto rounded-2xl border border-slate-200">
      <table>
        <thead>
          <tr>
            <th style="min-width:140px;">담당 직원</th>
            <th style="min-width:180px;">거래처</th>
            <th style="min-width:140px;">상태(최근 방문 기준)</th>
            <th style="min-width:160px;">계약 형태</th>
            <th style="min-width:170px;">금년도 누적 매출(천원)</th>
            <th style="min-width:170px;">누적 수검자 구분</th>
            <th style="min-width:140px;">첫 방문일</th>
            <th style="min-width:140px;">마지막 방문일</th>
          </tr>
        </thead>
        <tbody id="accountTbody"></tbody>
      </table>
    </div>

    <div class="mt-3 muted small">
      * 상태는 <b>오늘 기준</b> 마지막 방문일이 <b>2개월 이내</b>면 활성, <b>2개월 초과</b>면 비활성으로 표시합니다.
    </div>
  </section>

</main>

<script>
/* ================== 단위 설정 ================== */
const MONEY_MULTIPLIER = 1000; // 백만원 → 천원

/* ================== ✅ 관리자 회의록 데이터(샘플) ==================
   - “페이지에 업로드 되는 단어는 너가 적절하게 수정” 요청 반영: 실무형 문구로 구성
*/
const MEETING_ITEMS = [
  { id:"m_20251209_01", date:"2025-12-09", title:"영업 KPI 정의 확정", task:"매출·수검자·활성 거래처 지표 정의서 확정 및 공지" },
  { id:"m_20251205_02", date:"2025-12-05", title:"EIS 권한(직급별) 설계", task:"대표/부서장/팀장/매니저 열람 범위 표 작성 → 페이지 권한 분리 적용" },
  { id:"m_20251201_03", date:"2025-12-01", title:"거래처 활성 기준 합의", task:"최근 방문일 기준 2개월 이내=활성, 초과=비활성 정책 반영" },
  { id:"m_20251127_04", date:"2025-11-27", title:"관리자 페이지 개선안 반영", task:"회의록·부서 KPI·직원 체크 합산 구조 QA 완료" },
  { id:"m_20251120_05", date:"2025-11-20", title:"데이터 적재/업로드 정책 정리", task:"엑셀 업로드 주기·파일명 규칙·권한자 지정 운영 룰 문서화" }
];

const MEETING_LS_KEY = "omnicare_eis_admin_meeting_state_v1";

function loadMeetingState(){
  try{ return JSON.parse(localStorage.getItem(MEETING_LS_KEY) || "{}"); }
  catch(e){ return {}; }
}
function saveMeetingState(state){
  localStorage.setItem(MEETING_LS_KEY, JSON.stringify(state || {}));
}
function renderMeetings(){
  const tb = document.getElementById("meetingTbody");
  if (!tb) return;
  const state = loadMeetingState();
  tb.innerHTML = "";

  MEETING_ITEMS.forEach(item=>{
    const done = !!state[item.id];
    const tr = document.createElement("tr");
    if (done) tr.classList.add("meetingDone");

    tr.innerHTML = `
      <td>
        <label class="inline-flex items-center gap-2 font-bold">
          <input type="checkbox"
            class="w-4 h-4 accent-emerald-600"
            data-meeting="${item.id}"
            ${done ? "checked" : ""} />
          <span class="muted small">${done ? "완료" : "진행"}</span>
        </label>
      </td>
      <td class="font-bold">${item.date}</td>
      <td class="font-extrabold meetingTitle">${item.title}</td>
      <td class="meetingTask">${item.task}</td>
    `;

    tr.querySelector("input[type='checkbox']").addEventListener("change", (e)=>{
      const id = e.target.getAttribute("data-meeting");
      const st = loadMeetingState();
      st[id] = e.target.checked;
      saveMeetingState(st);
      renderMeetings();
    });

    tb.appendChild(tr);
  });

  if (MEETING_ITEMS.length === 0){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="4" class="muted">회의록 안건이 없습니다.</td>`;
    tb.appendChild(tr);
  }
}

/* ================== 샘플 데이터 ================== */
const ACCOUNTS = [
  { staffName:"김영업", name:"KMI 강남",   contractType:"withKMI",
    salesYTD:1800, salesMix:{ a:900, b:700, c:200 },
    examBreakdown:{ general:220, nonGeneral:120, national:80 },
    firstVisit:"2024-02-13", lastVisit:"2025-12-10"
  },
  { staffName:"김영업", name:"○○병원",    contractType:"3자",
    salesYTD:600,  salesMix:{ a:200, b:250, c:150 },
    examBreakdown:{ general:60, nonGeneral:55, national:25 },
    firstVisit:"2024-07-01", lastVisit:"2025-10-02"
  },
  { staffName:"김영업", name:"△△센터",    contractType:"기타",
    salesYTD:120,  salesMix:{ a:30,  b:40,  c:50  },
    examBreakdown:{ general:10, nonGeneral:8, national:7 },
    firstVisit:"2023-11-20", lastVisit:"2025-03-18"
  },

  { staffName:"박세일", name:"KMI 여의도", contractType:"withKMI",
    salesYTD:1100, salesMix:{ a:450, b:500, c:150 },
    examBreakdown:{ general:140, nonGeneral:70, national:50 },
    firstVisit:"2024-01-08", lastVisit:"2025-12-05"
  },
  { staffName:"박세일", name:"□□건강센터", contractType:"기타",
    salesYTD:420,  salesMix:{ a:120, b:200, c:100 },
    examBreakdown:{ general:35, nonGeneral:40, national:15 },
    firstVisit:"2024-05-16", lastVisit:"2025-09-21"
  },

  { staffName:"최리드", name:"KMI 광화문", contractType:"withKMI",
    salesYTD:1500, salesMix:{ a:700, b:650, c:150 },
    examBreakdown:{ general:190, nonGeneral:110, national:60 },
    firstVisit:"2024-03-02", lastVisit:"2025-12-12"
  },
  { staffName:"최리드", name:"☆☆검진기관", contractType:"3자",
    salesYTD:980,  salesMix:{ a:300, b:500, c:180 },
    examBreakdown:{ general:120, nonGeneral:90, national:30 },
    firstVisit:"2024-09-09", lastVisit:"2025-11-28"
  },

  { staffName:"정컨설", name:"KMI 수원",   contractType:"withKMI",
    salesYTD:980,  salesMix:{ a:360, b:520, c:100 },
    examBreakdown:{ general:130, nonGeneral:60, national:40 },
    firstVisit:"2024-04-10", lastVisit:"2025-12-01"
  },
  { staffName:"정컨설", name:"◇◇병원",    contractType:"3자",
    salesYTD:360,  salesMix:{ a:80,  b:160, c:120 },
    examBreakdown:{ general:25, nonGeneral:30, national:15 },
    firstVisit:"2024-08-22", lastVisit:"2025-08-30"
  },

  { staffName:"이세일", name:"△△의료재단", contractType:"기타",
    salesYTD:520, salesMix:{ a:150, b:250, c:120 },
    examBreakdown:{ general:55, nonGeneral:35, national:20 },
    firstVisit:"2024-06-03", lastVisit:"2025-10-14"
  },

  { staffName:"한파트", name:"KMI 부산",   contractType:"withKMI",
    salesYTD:1250, salesMix:{ a:520, b:600, c:130 },
    examBreakdown:{ general:170, nonGeneral:90, national:50 },
    firstVisit:"2024-02-19", lastVisit:"2025-12-09"
  },

  { staffName:"오제휴", name:"제휴A",      contractType:"기타",
    salesYTD:700,  salesMix:{ a:420, b:0,   c:280 },
    examBreakdown:{ general:80, nonGeneral:70, national:30 },
    firstVisit:"2024-10-01", lastVisit:"2025-12-03"
  },
];

/* ================== 전역 상태 ================== */
let STAFF = [];
const checkedStaff = new Set();
let selectedRowStaffName = null;

/* ================== 유틸 ================== */
function fmt(n){ return (n ?? 0).toLocaleString(); }
function moneyThousandWon(x){ return Math.round((x ?? 0) * MONEY_MULTIPLIER); }
function fmtMoney(x){ return fmt(moneyThousandWon(x)); }
function pillDot(color){ return `<span class="w-2 h-2 rounded-full ${color}"></span>`; }

function contractPill(type){
  const t = (type||"-").trim();
  if (t === "withKMI") return `<span class="pill">${pillDot("bg-emerald-500")}withKMI</span>`;
  if (t === "3자")     return `<span class="pill">${pillDot("bg-sky-500")}3자</span>`;
  if (t === "기타")    return `<span class="pill">${pillDot("bg-amber-500")}기타</span>`;
  return `<span class="pill">${pillDot("bg-slate-400")}${t}</span>`;
}

function examSum(ex){
  if (!ex) return 0;
  return (ex.general||0) + (ex.nonGeneral||0) + (ex.national||0);
}

function examBreakdownLikeSales(ex){
  const g = ex?.general || 0;
  const ng = ex?.nonGeneral || 0;
  const nat = ex?.national || 0;

  return `
    <div class="subline">
      <span class="subtag"><span class="legendDot exDot1"></span>종검 ${fmt(g)}</span>
      <span class="subtag"><span class="legendDot exDot2"></span>종검 외 ${fmt(ng)}</span>
      <span class="subtag"><span class="legendDot exDot3"></span>국가 ${fmt(nat)}</span>
    </div>
  `;
}

function parseYmd(ymd){
  if (!ymd) return null;
  const [y,m,d] = ymd.split("-").map(Number);
  if (!y || !m || !d) return null;
  return new Date(y, m-1, d);
}
function addMonths(date, months){
  const d = new Date(date);
  d.setMonth(d.getMonth() + months);
  return d;
}
function isActiveByLastVisit(lastVisitYmd){
  const dt = parseYmd(lastVisitYmd);
  if (!dt) return false;
  const today = new Date();
  const cutoff = addMonths(today, -2);
  return dt >= cutoff;
}
function visitStatusPill(lastVisitYmd){
  const active = isActiveByLastVisit(lastVisitYmd);
  if (active) return `<span class="pill">${pillDot("bg-sky-500")}활성</span>`;
  return `<span class="pill">${pillDot("bg-slate-500")}비활성</span>`;
}

/* ================== 직원 집계 ================== */
function buildStaffFromAccounts(){
  const map = new Map();
  const teamByName = {
    "김영업":"A팀", "박세일":"A팀", "최리드":"A팀",
    "정컨설":"B팀", "이세일":"B팀", "한파트":"B팀",
    "오제휴":"제휴팀", "윤운영":"운영팀"
  };

  ACCOUNTS.forEach(a=>{
    if (!map.has(a.staffName)){
      map.set(a.staffName, {
        name: a.staffName,
        team: teamByName[a.staffName] || "미지정",
        accounts: 0,
        activeAccounts: 0,
        examineesYTD: 0,
        salesYTD: 0,
        salesMix: { a:0, b:0, c:0 },
      });
    }
    const s = map.get(a.staffName);
    s.accounts += 1;
    if (isActiveByLastVisit(a.lastVisit)) s.activeAccounts += 1;

    s.examineesYTD += examSum(a.examBreakdown);
    s.salesYTD += (a.salesYTD || 0);
    s.salesMix.a += (a.salesMix?.a ?? 0);
    s.salesMix.b += (a.salesMix?.b ?? 0);
    s.salesMix.c += (a.salesMix?.c ?? 0);
  });

  Array.from(map.values()).forEach(s=>{
    const mixSum = s.salesMix.a + s.salesMix.b + s.salesMix.c;
    if (mixSum !== s.salesYTD) s.salesMix.c += (s.salesYTD - mixSum);
  });

  return Array.from(map.values());
}

/* ================== 필터 초기화 ================== */
function initDeptSelect(){
  const sel = document.getElementById("deptSelect");
  const teams = Array.from(new Set(STAFF.map(s=>s.team))).sort();
  teams.forEach(t=>{
    const opt = document.createElement("option");
    opt.value = t;
    opt.textContent = t;
    sel.appendChild(opt);
  });
  sel.addEventListener("change", () => renderAll());
}
function initStaffTeamFilter(){
  const sel = document.getElementById("staffTeamFilter");
  const teams = Array.from(new Set(STAFF.map(s=>s.team))).sort();
  teams.forEach(t=>{
    const opt = document.createElement("option");
    opt.value = t;
    opt.textContent = t;
    sel.appendChild(opt);
  });
  sel.addEventListener("change", renderStaffTable);
}

/* ================== 부서(팀) KPI/매출구성 ================== */
function calcDeptAgg(team){
  const staffRows = (team==="ALL") ? STAFF : STAFF.filter(s=>s.team===team);
  const headcount = staffRows.length;

  const staffNames = new Set(staffRows.map(s=>s.name));
  const accRows = ACCOUNTS.filter(a => staffNames.has(a.staffName));

  const deptAccounts = accRows.length;
  const activeAccounts = accRows.filter(a=>isActiveByLastVisit(a.lastVisit)).length;

  const sumSales = staffRows.reduce((a,b)=>a+(b.salesYTD||0),0);
  const sumExaminees = accRows.reduce((a,b)=>a+examSum(b.examBreakdown),0);

  const mix = accRows.reduce((m, r)=>{
    m.a += (r.salesMix?.a ?? 0);
    m.b += (r.salesMix?.b ?? 0);
    m.c += (r.salesMix?.c ?? 0);
    return m;
  }, {a:0,b:0,c:0});

  const mixSum = mix.a + mix.b + mix.c;
  if (mixSum !== sumSales) mix.c += (sumSales - mixSum);

  return { headcount, deptAccounts, activeAccounts, sumSales, sumExaminees, mix };
}

function renderDeptKpis(){
  const team = document.getElementById("deptSelect").value;
  const a = calcDeptAgg(team);

  document.getElementById("deptKpis").innerHTML = `
    <div class="kpi">
      <div class="muted small font-semibold">인원</div>
      <div class="text-2xl font-extrabold text-slate-900 mt-1">${fmt(a.headcount)}</div>
      <div class="muted small mt-1">선택 팀</div>
    </div>

    <div class="kpi">
      <div class="muted small font-semibold">부서 거래처</div>
      <div class="text-2xl font-extrabold text-slate-900 mt-1">${fmt(a.deptAccounts)}</div>
      <div class="muted small mt-1">전체</div>
    </div>

    <div class="kpi">
      <div class="muted small font-semibold">활성 거래처</div>
      <div class="text-2xl font-extrabold text-slate-900 mt-1">${fmt(a.activeAccounts)}</div>
      <div class="muted small mt-1">최근 2개월</div>
    </div>

    <div class="kpi">
      <div class="muted small font-semibold">누적 매출(천원)</div>
      <div class="text-2xl font-extrabold text-slate-900 mt-1">${fmtMoney(a.sumSales)}</div>
      <div class="muted small mt-1">YTD</div>
    </div>

    <div class="kpi">
      <div class="muted small font-semibold">누적 수검자</div>
      <div class="text-2xl font-extrabold text-slate-900 mt-1">${fmt(a.sumExaminees)}</div>
      <div class="muted small mt-1">합산</div>
    </div>
  `;
}

function renderSalesMixBar(){
  const team = document.getElementById("deptSelect").value;
  const a = calcDeptAgg(team);

  const total = (a.mix.a + a.mix.b + a.mix.c) || 0;
  const pa = total ? a.mix.a / total : 0;
  const pb = total ? a.mix.b / total : 0;
  const pc = total ? a.mix.c / total : 0;

  document.getElementById("mixBar").innerHTML = `
    <div class="seg a" style="width:${(pa*100).toFixed(2)}%"></div>
    <div class="seg b" style="width:${(pb*100).toFixed(2)}%"></div>
    <div class="seg c" style="width:${(pc*100).toFixed(2)}%"></div>
  `;

  document.getElementById("mixA").textContent = fmtMoney(a.mix.a);
  document.getElementById("mixB").textContent = fmtMoney(a.mix.b);
  document.getElementById("mixC").textContent = fmtMoney(a.mix.c);

  document.getElementById("mixAp").textContent = total ? `${Math.round(pa*100)}%` : "0%";
  document.getElementById("mixBp").textContent = total ? `${Math.round(pb*100)}%` : "0%";
  document.getElementById("mixCp").textContent = total ? `${Math.round(pc*100)}%` : "0%";
}

/* ================== 직원 테이블 ================== */
function getFilteredStaffRows(){
  const pageTeam = document.getElementById("deptSelect").value;
  const teamFilter = document.getElementById("staffTeamFilter").value;
  const q = (document.getElementById("staffSearch").value || "").trim();

  let rows = [...STAFF];
  if (pageTeam !== "ALL") rows = rows.filter(s=>s.team===pageTeam);
  if (teamFilter !== "ALL") rows = rows.filter(s=>s.team===teamFilter);
  if (q) rows = rows.filter(s=>s.name.includes(q));

  rows.sort((a,b)=>{
    if ((b.salesYTD||0) !== (a.salesYTD||0)) return (b.salesYTD||0) - (a.salesYTD||0);
    return (b.activeAccounts||0) - (a.activeAccounts||0);
  });
  return rows;
}

function renderStaffTable(){
  const rows = getFilteredStaffRows();
  const tb = document.getElementById("staffTbody");
  tb.innerHTML = "";

  rows.forEach(r=>{
    const tr = document.createElement("tr");
    tr.className = "rowClickable";
    tr.dataset.staffName = r.name;

    const checked = checkedStaff.has(r.name);

    tr.innerHTML = `
      <td>
        <input type="checkbox" class="w-4 h-4 accent-slate-900" data-check="${r.name}" ${checked ? "checked":""} />
      </td>
      <td class="font-extrabold">${r.name}</td>
      <td><span class="chip">${r.team}</span></td>
      <td class="font-bold">${fmt(r.accounts)}</td>
      <td class="font-bold">${fmt(r.activeAccounts)}</td>
      <td class="font-bold">${fmt(r.examineesYTD)}</td>
      <td>
        <div class="font-extrabold">${fmtMoney(r.salesYTD)}</div>
        <div class="subline">
          <span class="subtag"><span class="legendDot" style="background:#60a5fa;"></span>3자 ${fmtMoney(r.salesMix.a)}</span>
          <span class="subtag"><span class="legendDot" style="background:#34d399;"></span>withKMI ${fmtMoney(r.salesMix.b)}</span>
          <span class="subtag"><span class="legendDot" style="background:#fbbf24;"></span>기타 ${fmtMoney(r.salesMix.c)}</span>
        </div>
      </td>
    `;

    tr.querySelector("input[type='checkbox']").addEventListener("click", (e)=>{
      e.stopPropagation();
      toggleCheckStaff(r.name);
    });

    tr.addEventListener("click", ()=>{
      selectedRowStaffName = r.name;
      toggleCheckStaff(r.name);
      applySelectedRowHighlight();
    });

    tb.appendChild(tr);
  });

  if (rows.length === 0){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="7" class="muted">검색/필터 결과가 없습니다.</td>`;
    tb.appendChild(tr);
  }

  applySelectedRowHighlight();
}

function applySelectedRowHighlight(){
  const tb = document.getElementById("staffTbody");
  [...tb.querySelectorAll("tr")].forEach(tr=>{
    if (tr.dataset.staffName && tr.dataset.staffName === selectedRowStaffName) tr.classList.add("rowActive");
    else tr.classList.remove("rowActive");
  });
}

function toggleCheckStaff(name){
  if (checkedStaff.has(name)) checkedStaff.delete(name);
  else checkedStaff.add(name);

  syncVisibleCheckboxes();
  renderAccountsForCheckedStaff();
  renderCheckedSummaryBadges();
}

function syncVisibleCheckboxes(){
  const tb = document.getElementById("staffTbody");
  tb.querySelectorAll("input[type='checkbox'][data-check]").forEach(cb=>{
    const name = cb.getAttribute("data-check");
    cb.checked = checkedStaff.has(name);
  });
}

function clearCheckedStaff(){
  checkedStaff.clear();
  selectedRowStaffName = null;
  syncVisibleCheckboxes();
  applySelectedRowHighlight();
  renderAccountsForCheckedStaff();
  renderCheckedSummaryBadges();
}

/* ================== 체크 요약 뱃지 ================== */
function renderCheckedSummaryBadges(){
  const names = Array.from(checkedStaff);
  document.getElementById("checkedCount").textContent = fmt(names.length);

  if (names.length === 0){
    document.getElementById("checkedAccountsCount").textContent = "0";
    document.getElementById("checkedExamCount").textContent = "0";
    document.getElementById("checkedSalesSum").textContent = "0";
    return;
  }

  const rows = ACCOUNTS.filter(a => checkedStaff.has(a.staffName));
  const accountCount = rows.length;
  const examTotal = rows.reduce((s,r)=>s+examSum(r.examBreakdown),0);
  const salesSum = rows.reduce((s,r)=>s+(r.salesYTD||0),0);

  document.getElementById("checkedAccountsCount").textContent = fmt(accountCount);
  document.getElementById("checkedExamCount").textContent = fmt(examTotal);
  document.getElementById("checkedSalesSum").textContent = fmtMoney(salesSum);
}

/* ================== 체크된 직원들의 거래처(합산) ================== */
function renderAccountsForCheckedStaff(){
  const sec = document.getElementById("accountSection");
  const names = Array.from(checkedStaff);

  if (names.length === 0){
    sec.style.display = "none";
    document.getElementById("accountTbody").innerHTML = "";
    document.getElementById("accountKpis").innerHTML = "";
    return;
  }

  const rows = ACCOUNTS.filter(a => checkedStaff.has(a.staffName));
  sec.style.display = "block";

  document.getElementById("accountTitle").textContent = `선택 직원(${names.length}명) · 담당 거래처`;
  document.getElementById("accountSub").textContent = `${names.join(", ")} · 거래처 ${fmt(rows.length)}개 (합산)`;

  const active = rows.filter(r=>isActiveByLastVisit(r.lastVisit)).length;
  const inactive = rows.length - active;
  const sumSales = rows.reduce((a,b)=>a+(b.salesYTD||0),0);

  const ex = rows.reduce((m,r)=>{
    m.general += (r.examBreakdown?.general || 0);
    m.nonGeneral += (r.examBreakdown?.nonGeneral || 0);
    m.national += (r.examBreakdown?.national || 0);
    return m;
  }, {general:0, nonGeneral:0, national:0});

  const ct = rows.reduce((m,r)=>{
    const k = (r.contractType||"기타");
    m[k] = (m[k]||0) + 1;
    return m;
  }, {});

  document.getElementById("accountKpis").innerHTML = `
    <div class="kpi">
      <div class="muted small font-semibold">거래처 수</div>
      <div class="text-2xl font-extrabold text-slate-900 mt-1">${fmt(rows.length)}</div>
      <div class="muted small mt-1">활성 ${fmt(active)} · 비활성 ${fmt(inactive)}</div>
    </div>

    <div class="kpi">
      <div class="muted small font-semibold">금년도 누적 매출(천원)</div>
      <div class="text-2xl font-extrabold text-slate-900 mt-1">${fmtMoney(sumSales)}</div>
      <div class="muted small mt-1">선택 직원 합산</div>
    </div>

    <div class="kpi">
      <div class="muted small font-semibold">누적 수검자(합계)</div>
      <div class="text-2xl font-extrabold text-slate-900 mt-1">${fmt(ex.general + ex.nonGeneral + ex.national)}</div>
      <div class="muted small mt-1">종검 ${fmt(ex.general)} · 종검 외 ${fmt(ex.nonGeneral)} · 국가 ${fmt(ex.national)}</div>
    </div>

    <div class="kpi">
      <div class="muted small font-semibold">계약 형태 분포</div>
      <div class="text-2xl font-extrabold text-slate-900 mt-1">${fmt((ct["3자"]||0))} / ${fmt((ct["withKMI"]||0))} / ${fmt((ct["기타"]||0))}</div>
      <div class="muted small mt-1">3자 / withKMI / 기타 (거래처 수)</div>
    </div>
  `;

  const tb = document.getElementById("accountTbody");
  tb.innerHTML = "";

  rows.sort((a,b)=>{
    const aa = isActiveByLastVisit(a.lastVisit) ? 0 : 1;
    const bb = isActiveByLastVisit(b.lastVisit) ? 0 : 1;
    if (aa !== bb) return aa - bb;
    return (b.salesYTD||0) - (a.salesYTD||0);
  });

  rows.forEach(rw=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="font-extrabold">${rw.staffName}</td>
      <td class="font-extrabold">${rw.name}</td>
      <td>${visitStatusPill(rw.lastVisit)}</td>
      <td>${contractPill(rw.contractType)}</td>
      <td class="font-extrabold">${fmtMoney(rw.salesYTD)}</td>
      <td>
        <div class="font-extrabold">${fmt(examSum(rw.examBreakdown))}</div>
        ${examBreakdownLikeSales(rw.examBreakdown)}
      </td>
      <td class="font-bold">${rw.firstVisit || "-"}</td>
      <td class="font-bold">${rw.lastVisit || "-"}</td>
    `;
    tb.appendChild(tr);
  });

  sec.scrollIntoView({ behavior:"smooth", block:"start" });
}

/* ================== 이벤트 바인딩 ================== */
function bindStaffControls(){
  document.getElementById("staffSearch").addEventListener("input", renderStaffTable);
  document.getElementById("clearCheckedBtn").addEventListener("click", clearCheckedStaff);
}

/* ================== 전체 렌더 ================== */
function renderAll(){
  STAFF = buildStaffFromAccounts();
  renderDeptKpis();
  renderSalesMixBar();
  renderStaffTable();
  renderAccountsForCheckedStaff();
  renderCheckedSummaryBadges();
}

/* ================== 초기 실행 ================== */
renderMeetings();               // ✅ 회의록 먼저 렌더
STAFF = buildStaffFromAccounts();
initDeptSelect();
initStaffTeamFilter();
bindStaffControls();
renderAll();
</script>

</body>
</html>
