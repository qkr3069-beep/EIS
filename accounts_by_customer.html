<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>OmniCare EIS · 거래처별 정보</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css" />

<style>
  html,body{ font-family:"Pretendard Variable", system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
  .card{
    border:1px solid #e5e7eb; border-radius:16px; background:#fff;
    box-shadow:0 8px 24px rgba(15,23,42,.06);
  }
  .muted{ color:#64748b; }
  .divider{ height:1px; background:#e5e7eb; }
  .chip{ border:1px solid #e5e7eb; border-radius:999px; padding:.25rem .6rem; font-size:.8rem; color:#334155; background:#f8fafc; }
  .btn2{ border:1px solid #e5e7eb; background:#fff; color:#0f172a; border-radius:12px; padding:.55rem .9rem; font-weight:800; }
  .btnDark{ border:1px solid #0f172a; background:#0f172a; color:#fff; border-radius:12px; padding:.55rem .9rem; font-weight:900; }
  .small{ font-size:.85rem; }

  /* ===== 현황 KPI ===== */
  .kpiGrid{
    display:grid;
    grid-template-columns: repeat(2, minmax(0,1fr));
    gap:10px;
  }
  @media (min-width: 768px){
    .kpiGrid{ grid-template-columns: repeat(6, minmax(0,1fr)); }
  }
  .kpiBox{
    border:1px solid #e5e7eb; border-radius:16px; padding:12px; background:#fff;
  }
  .kpiLabel{ color:#64748b; font-size:.82rem; font-weight:800; }
  .kpiValue{ font-size:1.25rem; font-weight:900; color:#0f172a; margin-top:6px; }
  .kpiSub{ color:#64748b; font-size:.78rem; margin-top:6px; }

  .kpiSpan2{ grid-column: span 2 / span 2; }
  @media (max-width: 767px){
    .kpiSpan2{ grid-column: span 2 / span 2; }
  }
  .mgrWrap{ margin-top:6px; display:flex; flex-direction:column; gap:6px; }
  .mgrRow{ display:flex; gap:8px; align-items:flex-start; flex-wrap:wrap; }
  .mgrTag{
    display:inline-flex; align-items:center;
    border:1px solid #e5e7eb; border-radius:999px;
    padding:.18rem .55rem; font-size:.78rem; font-weight:900;
    color:#334155; background:#f8fafc;
    white-space:nowrap;
  }
  .mgrVal{
    font-weight:900; color:#0f172a;
    font-size:1.02rem;
    word-break:break-word;
  }
  .mgrVal a{ color:#0f172a; text-decoration:none; }
  .mgrVal a:hover{ text-decoration:underline; }

  /* ===== 재무현황 2x2 + 세로막대 ===== */
  .finGrid{
    display:grid;
    grid-template-columns: 1fr;
    gap:12px;
  }
  @media (min-width: 1024px){
    .finGrid{ grid-template-columns: repeat(2, 1fr); }
  }
  .finCard{
    border:1px solid #e5e7eb;
    border-radius:16px;
    background:#f8fafc;
    padding:14px;
  }
  .finHead{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .finTitle{
    font-weight:900;
    color:#0f172a;
  }
  .finUnit{
    font-size:.78rem;
    font-weight:900;
    color:#334155;
  }
  .barsArea{
    margin-top:12px;
    height:170px;
    display:flex;
    align-items:flex-end;
    justify-content:center;
    gap:14px;
  }
  .vbarCol{
    width:74px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:8px;
  }
  .vbarWrap{
    width:100%;
    height:130px;
    border:1px solid #e5e7eb;
    background:#ffffff;
    border-radius:14px;
    display:flex;
    align-items:flex-end;
    justify-content:center;
    overflow:hidden;
  }
  .vbar{
    width:60%;
    border-radius:12px 12px 0 0;
  }
  .y1{ background:#93c5fd; }
  .y2{ background:#1e3a8a; }
  .yearTag{
    font-size:.78rem;
    font-weight:900;
    color:#334155;
  }
  .valTag{
    font-size:.8rem;
    font-weight:900;
    color:#0f172a;
  }
  .finFoot{
    margin-top:10px;
    color:#64748b;
    font-size:.78rem;
    font-weight:800;
  }

  /* ===== 뉴스/공시 ===== */
  .item{
    border:1px solid #e5e7eb;
    background:#f8fafc;
    border-radius:14px;
    padding:12px 12px;
  }
  .itemTitle{ font-weight:900; color:#0f172a; }
  .itemMeta{ color:#64748b; font-size:.8rem; margin-top:4px; }
  .link{ color:#0f172a; text-decoration:none; }
  .link:hover{ text-decoration:underline; }

  .hintBox{
    border:1px dashed #e5e7eb;
    background:#fff;
    border-radius:16px;
    padding:16px;
  }

  .toast{
    border:1px solid #e5e7eb; background:#fff; border-radius:14px;
    padding:10px 12px; font-size:.85rem; color:#0f172a;
  }
</style>
</head>

<body class="bg-slate-50">

<header class="sticky top-0 z-20 bg-white/90 backdrop-blur border-b border-slate-200">
  <div class="max-w-[1440px] mx-auto px-2 py-3 flex items-center gap-3">
    <a href="index.html" aria-label="메인으로 이동">
      <img src="omnicare_logo.png" alt="옴니케어 로고" class="h-12 object-contain cursor-pointer" />
    </a>
    <div class="flex-1">
      <div class="font-semibold text-slate-900">OmniCare Intelligence Hub</div>
      <div class="text-sm muted">거래처별 정보 · 현황 · 재무 · 뉴스/공시</div>
    </div>

    <div class="flex items-center gap-2">
      <button onclick="location.href='index.html'" class="btn2">메인</button>
      <button onclick="location.href='mypage_sales.html'" class="btn2">마이페이지</button>
    </div>
  </div>
</header>

<main class="max-w-[1440px] mx-auto px-2 py-6 space-y-6">

  <!-- 1행: 검색 -->
  <section class="card p-5">
    <div class="flex items-start justify-between gap-3 flex-wrap">
      <div>
        <div class="text-lg font-extrabold text-slate-900">거래처별 정보</div>
        <div class="muted small">거래처명을 검색하면 “거래 현황 + 재무(2개년도) + 뉴스 + 공시”가 노출됩니다.</div>
      </div>
      <span class="chip">accounts_by_customer</span>
    </div>

    <div class="divider my-4"></div>

    <div class="flex items-center gap-2 flex-wrap">
      <input id="q"
             class="border border-slate-200 rounded-xl px-3 py-2 bg-white w-[320px]"
             placeholder="거래처 검색 (예: 삼성전자, GC케어)" />
      <button class="btnDark" onclick="applySearch()">조회</button>

      <div class="ml-auto muted small">
        선택: <span id="selectedName" class="font-extrabold text-slate-900">-</span>
      </div>
    </div>

    <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-2">
      <div class="toast">
        <div class="font-extrabold">구글시트 연동</div>
        <div class="muted small" id="sheetStatus">로딩 중…</div>
      </div>
      <div class="toast">
        <div class="font-extrabold">검색 데이터</div>
        <div class="muted small">omnicare_customer 시트 (A: name, B: corp_code)</div>
      </div>
      <div class="toast">
        <div class="font-extrabold">DART 연동</div>
        <div class="muted small">공시(/dart/list) + 재무(/dart/fin)</div>
      </div>
    </div>
  </section>

  <!-- 검색 전 안내 -->
  <section id="emptyState" class="hintBox">
    <div class="font-extrabold text-slate-900">거래처를 검색해주세요.</div>
    <div class="muted small mt-1">
      예: <span class="font-extrabold text-slate-900">삼성전자</span>, <span class="font-extrabold text-slate-900">GC케어</span>
    </div>
  </section>

  <!-- 검색 후 영역 -->
  <div id="resultArea" class="space-y-6 hidden">

    <!-- 2행: 거래 현황 -->
    <section class="card p-5">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-lg font-extrabold text-slate-900">거래 현황 (우리 ↔ 거래처)</div>
          <div class="muted small" id="statusSub">-</div>
        </div>
        <span class="chip">STATUS</span>
      </div>

      <div class="divider my-4"></div>

      <div class="kpiGrid">
        <div class="kpiBox">
          <div class="kpiLabel">금년도 누적 매출</div>
          <div class="kpiValue" id="kpiRevenue">-</div>
          <div class="kpiSub">단위: 천원(샘플)</div>
        </div>

        <div class="kpiBox">
          <div class="kpiLabel">금년도 누적 수검자</div>
          <div class="kpiValue" id="kpiExaminees">-</div>
          <div class="kpiSub">단위: 명(샘플)</div>
        </div>

        <div class="kpiBox">
          <div class="kpiLabel">첫 방문일</div>
          <div class="kpiValue" id="kpiFirstVisit">-</div>
          <div class="kpiSub">접속/방문 기준(샘플)</div>
        </div>

        <div class="kpiBox">
          <div class="kpiLabel">마지막 방문일</div>
          <div class="kpiValue" id="kpiLastVisit">-</div>
          <div class="kpiSub">접속/방문 기준(샘플)</div>
        </div>

        <div class="kpiBox kpiSpan2">
          <div class="kpiLabel">담당자 정보</div>
          <div class="mgrWrap" id="kpiManager">
            <div class="muted small">-</div>
          </div>
          <div class="kpiSub">이름 · 이메일 · 연락처</div>
        </div>
      </div>
    </section>

    <!-- 3행: 재무현황(2x2 + 세로막대) -->
    <section class="card p-5">
      <div class="flex items-start justify-between gap-3 flex-wrap">
        <div>
          <div class="text-lg font-extrabold text-slate-900">재무현황 (거래처)</div>
          <div class="muted small">
            DART 기반(별도재무제표 OFS) · <span id="financeYears">-</span> 비교
          </div>
        </div>
        <span class="chip">FINANCE</span>
      </div>

      <div class="divider my-4"></div>

      <div id="finGrid" class="finGrid"></div>

      <div class="mt-3 muted small" id="financeNote">
        * 정기보고서(사업보고서) 기반 자동화: /dart/fin (현재 regular 경로)
      </div>
    </section>

    <!-- 4행: 뉴스 + 공시 -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <div class="card p-5">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-lg font-extrabold text-slate-900">거래처 뉴스</div>
            <div class="muted small" id="newsSub">조회일: -</div>
          </div>
          <a href="#" id="newsMore" class="chip hover:bg-slate-100">더보기</a>
        </div>

        <div class="divider my-4"></div>
        <div id="newsList" class="space-y-2"></div>
      </div>

      <div class="card p-5">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-lg font-extrabold text-slate-900">거래처 공시자료 (DART)</div>
            <div class="muted small" id="filingsSub">-</div>
          </div>
          <a href="#" id="filingsMore" class="chip hover:bg-slate-100">더보기</a>
        </div>

        <div class="divider my-4"></div>
        <div id="filingsList" class="space-y-2"></div>
      </div>
    </section>

  </div>

  <footer class="text-center muted small py-6">
    샘플 화면입니다. 실제 서비스에서는 로그인/권한/거래/공시/뉴스 수집 로직이 연결됩니다.
  </footer>
</main>

<script>
/* =========================================================
   ✅ Cloudflare Worker API Base
========================================================= */
const API_BASE = "https://accounts-by-customer.qkr3069.workers.dev";

/* =========================================================
   ✅ Google Sheet (omnicare_customer)
   - A: name
   - B: corp_code (8자리)
========================================================= */
const SHEET_ID   = "1kKsPK5Kxplgoutz4pkS8QqXTdC7Ai1jeaeaOJsZVgnI";
const SHEET_NAME = "omnicare_customer";

/* ===== 고객 DB (구글시트 로딩 후 채움) ===== */
let CUSTOMER_DB = [];   // [{ name, corpCode, status(샘플), more(샘플) }, ... ]

/* ===== 샘플 status (거래 현황은 지금은 샘플 유지) ===== */
function defaultStatusSample(){
  const now = new Date();
  const y = now.getFullYear();
  return {
    ytdRevenue: 0,
    ytdExaminees: 0,
    firstVisitDate: `${y}-01-01`,
    lastVisitDate: `${y}-12-31`,
    manager: { name:"-", email:"-", phone:"-" }
  };
}

const fmt = (n) => (n ?? 0).toLocaleString("ko-KR");

/* =========================================================
   ✅ Finance 2x2 Render (기존 그대로)
========================================================= */
function renderFinance2x2(fin){
  const wrap = document.getElementById("finGrid");
  wrap.innerHTML = "";

  const years = fin.years;
  const unit = fin.unit;

  const metrics = [
    { key:"revenue", title:"매출액", vals: fin.revenue },
    { key:"op",      title:"영업이익", vals: fin.op },
    { key:"net",     title:"당기순이익", vals: fin.net },
    { key:"capital", title:"자본금", vals: fin.capital },
  ];

  metrics.forEach(m=>{
    const maxV = Math.max(m.vals?.[0] ?? 0, m.vals?.[1] ?? 0, 1);
    const h1 = Math.round(((m.vals?.[0] ?? 0)/maxV)*100);
    const h2 = Math.round(((m.vals?.[1] ?? 0)/maxV)*100);

    const card = document.createElement("div");
    card.className = "finCard";
    card.innerHTML = `
      <div class="finHead">
        <div class="finTitle">${m.title}</div>
        <div class="finUnit">단위: ${unit}</div>
      </div>

      <div class="barsArea">
        <div class="vbarCol">
          <div class="valTag">${fmt(m.vals?.[0] ?? 0)}</div>
          <div class="vbarWrap">
            <div class="vbar y1" style="height:${h1}%"></div>
          </div>
          <div class="yearTag">${years[0]}</div>
        </div>

        <div class="vbarCol">
          <div class="valTag">${fmt(m.vals?.[1] ?? 0)}</div>
          <div class="vbarWrap">
            <div class="vbar y2" style="height:${h2}%"></div>
          </div>
          <div class="yearTag">${years[1]}</div>
        </div>
      </div>

      <div class="finFoot">
        ${years[0]} → ${years[1]} 변화:
        <span style="color:#0f172a; font-weight:900;">
          ${(m.vals?.[1] ?? 0)-(m.vals?.[0] ?? 0) >= 0 ? "+" : ""}${fmt((m.vals?.[1] ?? 0)-(m.vals?.[0] ?? 0))}
        </span>
      </div>
    `;
    wrap.appendChild(card);
  });
}

/* =========================================================
   ✅ News RSS (기존 유지)
========================================================= */
async function fetchRSS2JSON(rssUrl){
  const r = await fetch("https://api.rss2json.com/v1/api.json?rss_url=" + encodeURIComponent(rssUrl));
  return r.json();
}
function stripHtml(s){
  return (s || "").replace(/<[^>]*>/g, " ").replace(/\s+/g, " ").trim();
}
function toYMD(dateStr){
  const d = new Date(dateStr);
  if (Number.isNaN(d.getTime())) return "-";
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${dd}`;
}
async function loadKeywordNews(keyword, limit=5){
  const rss = `https://news.google.com/rss/search?q=${encodeURIComponent(keyword)}&hl=ko&gl=KR&ceid=KR:ko`;
  const data = await fetchRSS2JSON(rss);

  const items = (data.items || []).slice(0, limit).map(it => ({
    title: it.title,
    date: toYMD(it.pubDate),
    summary: stripHtml(it.description).slice(0, 80) + (stripHtml(it.description).length > 80 ? "..." : ""),
    link: it.link
  }));

  const wrap = document.getElementById("newsList");
  wrap.innerHTML = "";

  if (!items.length){
    wrap.innerHTML = `<div class="muted small">관련 뉴스가 없습니다.</div>`;
    return;
  }

  items.forEach(it=>{
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <a class="link itemTitle" href="${it.link}" target="_blank" rel="noopener">${it.title}</a>
      <div class="itemMeta">${it.date} · ${it.summary}</div>
    `;
    wrap.appendChild(div);
  });
}

/* =========================================================
   ✅ DART 공시 (corp_code 기반 /dart/list)
========================================================= */
function ymdNow(){
  const t = new Date();
  const y = t.getFullYear();
  const m = String(t.getMonth()+1).padStart(2,"0");
  const d = String(t.getDate()).padStart(2,"0");
  return `${y}${m}${d}`;
}
function ymdOneYearAgo(){
  const t = new Date();
  t.setFullYear(t.getFullYear()-1);
  const y = t.getFullYear();
  const m = String(t.getMonth()+1).padStart(2,"0");
  const d = String(t.getDate()).padStart(2,"0");
  return `${y}${m}${d}`;
}

async function apiGet(path, params={}){
  const url = new URL(API_BASE + path);
  Object.entries(params).forEach(([k,v])=>{
    if (v !== undefined && v !== null && String(v).trim() !== "") url.searchParams.set(k, String(v));
  });
  const res = await fetch(url.toString(), { method:"GET" });
  const ct = res.headers.get("content-type") || "";
  if (!res.ok){
    const txt = await res.text().catch(()=> "");
    throw new Error(`HTTP ${res.status} ${res.statusText} ${txt ? `· ${txt.slice(0,160)}` : ""}`);
  }
  if (ct.includes("application/json")) return res.json();
  const txt = await res.text();
  try { return JSON.parse(txt); } catch { return { raw: txt }; }
}

async function fetchDartListViaWorker(corpCode, pageCount=5){
  const data = await apiGet("/dart/list", {
    corp_code: corpCode,
    page_count: pageCount,
    bgn_de: ymdOneYearAgo(),
    end_de: ymdNow()
  });

  // DART 원 응답 형태 {status, message, list:[...]}
  if (data?.status && data.status !== "000"){
    return { status: data.status, message: data.message || "조회 실패", list: [] };
  }
  if (Array.isArray(data?.list)) return { status: "000", message: "OK", list: data.list };
  return { status:"999", message:"응답 파싱 실패", list: [] };
}

function renderDartFilings(items){
  const wrap = document.getElementById("filingsList");
  wrap.innerHTML = "";

  if (!items.length){
    wrap.innerHTML = `<div class="muted small">최근 공시가 없습니다.</div>`;
    return;
  }

  items.forEach(it=>{
    const dartUrl = `https://dart.fss.or.kr/dsaf001/main.do?rcpNo=${it.rcept_no}`;
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <a class="link itemTitle" href="${dartUrl}" target="_blank" rel="noopener">${it.report_nm}</a>
      <div class="itemMeta">${it.rcept_dt} · ${it.corp_name || ""}</div>
    `;
    wrap.appendChild(div);
  });
}

async function loadDartFilingsByCorpCode(corpName, corpCode){
  const wrap = document.getElementById("filingsList");
  wrap.innerHTML = `<div class="muted small">불러오는 중…</div>`;
  document.getElementById("filingsSub").textContent = `조회 기업: ${corpName}`;

  if (!corpCode){
    wrap.innerHTML = `
      <div class="item">
        <div class="itemTitle">corp_code가 없어 공시 조회가 불가합니다.</div>
        <div class="itemMeta">구글시트에 corp_code(8자리)를 채워주세요.</div>
      </div>
    `;
    return;
  }

  try{
    const out = await fetchDartListViaWorker(corpCode, 5);
    if (out.status !== "000"){
      wrap.innerHTML = `
        <div class="item">
          <div class="itemTitle">최근 공시가 없습니다.</div>
          <div class="itemMeta">사유: ${out.status} · ${out.message || ""}</div>
        </div>
        <div class="item">
          <a class="link itemTitle" href="https://dart.fss.or.kr/" target="_blank" rel="noopener">DART에서 직접 검색하기</a>
          <div class="itemMeta">키워드: ${corpName}</div>
        </div>
      `;
      document.getElementById("filingsSub").textContent = `조회 기업: ${corpName} · corp_code: ${corpCode}`;
      return;
    }

    document.getElementById("filingsSub").textContent = `조회 기업: ${corpName} · corp_code: ${corpCode}`;
    renderDartFilings(out.list);

  }catch(err){
    wrap.innerHTML = `
      <div class="item">
        <div class="itemTitle">공시 불러오기 실패</div>
        <div class="itemMeta">사유: ${String(err.message || err)}</div>
      </div>
      <div class="item">
        <a class="link itemTitle" href="https://dart.fss.or.kr/" target="_blank" rel="noopener">DART에서 직접 검색하기</a>
        <div class="itemMeta">키워드: ${corpName}</div>
      </div>
    `;
  }
}

/* =========================================================
   ✅ Finance: Worker /dart/fin 연동
========================================================= */
function twoYearsForFinance(){
  const cur = new Date().getFullYear();
  return [cur - 2, cur - 1]; // 예: 2023,2024 (현재연도 기준 -2, -1)
}

async function loadFinanceFromWorker(corpCode){
  const [y1, y2] = twoYearsForFinance();
  document.getElementById("financeYears").textContent = `${y1} vs ${y2}`;
  document.getElementById("finGrid").innerHTML = `<div class="muted small">재무 불러오는 중…</div>`;

  if (!corpCode){
    document.getElementById("financeNote").textContent = "* corp_code가 없어 재무 조회가 불가합니다.";
    // 빈값 렌더
    renderFinance2x2({ years:[y1,y2], unit:"천원", revenue:[0,0], op:[0,0], net:[0,0], capital:[0,0] });
    return;
  }

  const finRes = await apiGet("/dart/fin", {
    corp_code: corpCode,
    years: `${y1},${y2}`,
    fs_div: "OFS"
  });

  if (!finRes?.ok || !finRes?.items) {
    throw new Error("재무 API 응답이 비정상입니다.");
  }

  // Worker는 '원' 단위로 줌. 화면은 '천원'으로 보기 좋게 변환.
  const toThousandWon = (v) => (typeof v === "number" ? Math.round(v / 1000) : 0);

  const f = {
    years: finRes.years || [y1, y2],
    unit: "천원",
    revenue: (finRes.items.revenue || []).map(toThousandWon),
    op:      (finRes.items.op || []).map(toThousandWon),
    net:     (finRes.items.net || []).map(toThousandWon),
    capital: (finRes.items.capital || []).map(toThousandWon),
  };

  // NOTE 문구 갱신
  const p1 = finRes?.perYear?.[String(y1)];
  const p2 = finRes?.perYear?.[String(y2)];
  const s1 = p1?.ok ? "OK" : (p1?.dart_status || p1?.error || "FAIL");
  const s2 = p2?.ok ? "OK" : (p2?.dart_status || p2?.error || "FAIL");
  document.getElementById("financeNote").textContent =
    `* /dart/fin(별도 OFS) · ${y1}: ${s1} · ${y2}: ${s2} (정기보고서 기반)`;

  renderFinance2x2(f);
}

/* =========================================================
   ✅ 담당자 정보 렌더(샘플)
========================================================= */
function renderManagerBox(mgr){
  const box = document.getElementById("kpiManager");
  if (!mgr){
    box.innerHTML = `<div class="muted small">-</div>`;
    return;
  }
  const name = mgr.name || "-";
  const email = mgr.email || "-";
  const phone = mgr.phone || "-";

  box.innerHTML = `
    <div class="mgrRow">
      <span class="mgrTag">이름</span>
      <span class="mgrVal">${name}</span>
    </div>
    <div class="mgrRow">
      <span class="mgrTag">이메일</span>
      <span class="mgrVal">${email === "-" ? "-" : `<a href="mailto:${email}">${email}</a>`}</span>
    </div>
    <div class="mgrRow">
      <span class="mgrTag">연락처</span>
      <span class="mgrVal">${phone === "-" ? "-" : `<a href="tel:${phone.replace(/[^0-9+]/g,'')}">${phone}</a>`}</span>
    </div>
  `;
}

/* =========================================================
   ✅ Google Sheet 로딩: name + corp_code
   - gviz JSON 포맷 파싱
========================================================= */
function gvizUrl(){
  // gviz는 CORS 이슈가 상대적으로 적고, 공개 시트면 잘 동작
  // A:B 전체 (name, corp_code)
  return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}&range=A:B`;
}

function parseGviz(text){
  // gviz는 JSON 앞뒤에 자바스크립트 래퍼가 붙음
  const m = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*?)\);\s*$/);
  if (!m) throw new Error("GVIZ 포맷 파싱 실패(공개/권한 확인 필요)");
  return JSON.parse(m[1]);
}

function normalizeCorpCode(v){
  const s = (v ?? "").toString().trim();
  const digits = s.replace(/\D/g, "");
  if (!digits) return "";
  return digits.padStart(8, "0").slice(-8);
}

async function loadCustomersFromSheet(){
  const el = document.getElementById("sheetStatus");
  try{
    const res = await fetch(gvizUrl(), { method:"GET" });
    const text = await res.text();
    const json = parseGviz(text);

    const rows = json?.table?.rows || [];
    const out = [];

    for (const r of rows){
      const c0 = r?.c?.[0]?.v;
      const c1 = r?.c?.[1]?.v;
      const name = (c0 ?? "").toString().trim();
      const corpCode = normalizeCorpCode(c1);

      if (!name) continue;

      out.push({
        name,
        corpCode,
        status: defaultStatusSample(),
        more: {
          news: `customer_news_all.html?c=${encodeURIComponent(name)}`,
          filings: `customer_filings_all.html?c=${encodeURIComponent(name)}`
        }
      });
    }

    if (!out.length) throw new Error("시트에서 읽은 거래처가 0건입니다. A열(name) 채워졌는지 확인!");

    CUSTOMER_DB = out;
    el.textContent = `연동완료 · ${out.length}개 거래처 로딩됨`;
  }catch(err){
    console.warn("시트 연동 실패:", err);
    el.textContent = `연동 실패 · ${String(err.message || err)}`;

    // 최소 fallback: 삼성전자만이라도 남겨서 테스트 가능하게
    CUSTOMER_DB = [{
      name: "삼성전자",
      corpCode: "00126380",
      status: {
        ytdRevenue: 38000,
        ytdExaminees: 420,
        firstVisitDate: "2025-01-10",
        lastVisitDate: "2025-12-14",
        manager: { name:"김담당", email:"manager@samsung.com", phone:"010-1234-5678" },
      },
      more: {
        news: "customer_news_all.html?c=삼성전자",
        filings: "customer_filings_all.html?c=삼성전자"
      }
    }];
  }
}

/* =========================================================
   ✅ 검색 + 로딩
========================================================= */
function findCustomerByQuery(q){
  const qq = (q || "").trim().toLowerCase();
  if (!qq) return null;
  return CUSTOMER_DB.find(c => c.name.toLowerCase() === qq || c.name.toLowerCase().includes(qq)) || null;
}

async function loadCustomer(c){
  document.getElementById("emptyState").classList.add("hidden");
  document.getElementById("resultArea").classList.remove("hidden");

  document.getElementById("selectedName").textContent = c.name;

  // 거래 현황(샘플)
  const s = c.status || defaultStatusSample();
  document.getElementById("statusSub").textContent = `거래처: ${c.name} · (샘플) 올해 누적 기준`;
  document.getElementById("kpiRevenue").textContent = `${fmt(s.ytdRevenue)} 천원`;
  document.getElementById("kpiExaminees").textContent = `${fmt(s.ytdExaminees)} 명`;
  document.getElementById("kpiFirstVisit").textContent = s.firstVisitDate || "-";
  document.getElementById("kpiLastVisit").textContent  = s.lastVisitDate || "-";
  renderManagerBox(s.manager);

  // ✅ 재무(실데이터): /dart/fin 연동
  try{
    await loadFinanceFromWorker(c.corpCode);
  }catch(err){
    console.warn("재무 연동 실패:", err);
    document.getElementById("financeNote").textContent = `* 재무 연동 실패: ${String(err.message || err)}`;
    const [y1,y2] = twoYearsForFinance();
    renderFinance2x2({ years:[y1,y2], unit:"천원", revenue:[0,0], op:[0,0], net:[0,0], capital:[0,0] });
  }

  // 뉴스
  const today = new Date();
  const y = today.getFullYear(), m = String(today.getMonth()+1).padStart(2,"0"), d = String(today.getDate()).padStart(2,"0");
  document.getElementById("newsSub").textContent = `조회일: ${y}-${m}-${d}`;

  document.getElementById("newsMore").setAttribute("href", c.more?.news || "#");
  document.getElementById("filingsMore").setAttribute("href", c.more?.filings || "#");

  await loadKeywordNews(c.name, 5);

  // 공시(DART): corp_code로 바로
  await loadDartFilingsByCorpCode(c.name, c.corpCode);
}

async function applySearch(){
  const q = document.getElementById("q").value;
  const c = findCustomerByQuery(q);

  if (!c){
    document.getElementById("selectedName").textContent = "-";
    document.getElementById("resultArea").classList.add("hidden");
    document.getElementById("emptyState").classList.remove("hidden");
    document.getElementById("emptyState").innerHTML = `
      <div class="font-extrabold text-slate-900">검색 결과가 없습니다.</div>
      <div class="muted small mt-1">구글시트(omnicare_customer)에 등록된 이름과 동일하게 입력해주세요.</div>
    `;
    return;
  }

  document.getElementById("emptyState").innerHTML = `
    <div class="font-extrabold text-slate-900">거래처를 검색해주세요.</div>
    <div class="muted small mt-1">예: <span class="font-extrabold text-slate-900">삼성전자</span>, <span class="font-extrabold text-slate-900">GC케어</span></div>
  `;

  await loadCustomer(c);
}

document.getElementById("q").addEventListener("keydown", (e)=>{
  if (e.key === "Enter") applySearch();
});

/* =========================================================
   ✅ 초기화: 시트 로딩
========================================================= */
(async function init(){
  await loadCustomersFromSheet();
})();
</script>
</body>
</html>
