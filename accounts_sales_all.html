<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>OmniCare EIS · Accounts (Sales · All)</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css" />

<style>
  html,body{ font-family:"Pretendard Variable", system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
  .card{ border:1px solid #e5e7eb; border-radius:16px; background:#fff; box-shadow:0 8px 24px rgba(15,23,42,.06); }
  .muted{ color:#64748b; }
  .divider{ height:1px; background:#e5e7eb; }
  .chip{ border:1px solid #e5e7eb; border-radius:999px; padding:.25rem .6rem; font-size:.8rem; color:#334155; background:#f8fafc; }
  .btn2{ border:1px solid #e5e7eb; background:#fff; color:#0f172a; border-radius:12px; padding:.55rem .9rem; font-weight:800; }
  .btnDark{ border:1px solid #0f172a; background:#0f172a; color:#fff; border-radius:12px; padding:.55rem .9rem; font-weight:800; }
  .small{ font-size:.85rem; }

  .kpiBox{ border:1px solid #e5e7eb; border-radius:16px; padding:14px; background:#fff; }
  .kpiLabel{ color:#64748b; font-size:.85rem; font-weight:700; }
  .kpiValue{ font-size:1.6rem; font-weight:900; color:#0f172a; margin-top:4px; }
  .kpiSub{ color:#64748b; font-size:.8rem; margin-top:4px; }

  table{ width:100%; border-collapse:collapse; }
  thead th{ text-align:left; font-size:.85rem; color:#334155; padding:10px 10px; border-bottom:1px solid #e5e7eb; white-space:nowrap; }
  tbody td{ padding:12px 10px; border-bottom:1px solid #eef2f7; vertical-align:top; font-size:.92rem; color:#0f172a; }
  tbody tr:hover{ background:#f8fafc; }
  .num{ text-align:right; font-variant-numeric: tabular-nums; white-space:nowrap; }
  .link{ color:#0f172a; text-decoration:none; font-weight:900; }
  .link:hover{ text-decoration:underline; }

  .pill{
    display:inline-flex; align-items:center; gap:.35rem;
    border:1px solid #e5e7eb; border-radius:999px;
    padding:.2rem .55rem; font-size:.78rem; font-weight:900;
    background:#fff;
    white-space:nowrap;
  }
  .pill-blue{ color:#1e3a8a; border-color:#bfdbfe; background:#eff6ff; }
  .pill-indigo{ color:#312e81; border-color:#c7d2fe; background:#eef2ff; }
  .pill-slate{ color:#334155; border-color:#e2e8f0; background:#f8fafc; }

  .statusPill{
    display:inline-flex; align-items:center; gap:6px;
    border:1px solid #e5e7eb;
    border-radius:999px;
    padding:.2rem .55rem;
    font-size:.78rem;
    font-weight:900;
    background:#fff;
    white-space:nowrap;
  }
  .statusPill i{ width:8px; height:8px; border-radius:999px; display:inline-block; }
  .status-on{ color:#0f172a; border-color:#bae6fd; background:#f0f9ff; }
  .status-on i{ background:#0ea5e9; }
  .status-off{ color:#334155; border-color:#e2e8f0; background:#f8fafc; }
  .status-off i{ background:#64748b; }

  .iconBtn{
    display:inline-flex; align-items:center; justify-content:center;
    width:36px; height:36px; border-radius:12px;
    border:1px solid #e5e7eb; background:#fff;
    transition: transform .12s ease, background .12s ease;
  }
  .iconBtn:hover{ background:#f8fafc; transform: translateY(-1px); }

  .input{
    border:1px solid #e5e7eb; border-radius:14px;
    padding:.6rem .8rem; background:#fff; color:#0f172a;
    outline:none;
  }
  .input:focus{ border-color:#94a3b8; box-shadow:0 0 0 3px rgba(148,163,184,.25); }

  .select{
    border:1px solid #e5e7eb; border-radius:14px;
    padding:.6rem .8rem; background:#fff; color:#0f172a;
  }

  .hintBox{
    border:1px dashed #e5e7eb; border-radius:16px;
    padding:12px 14px; background:#f8fafc; color:#334155;
  }
</style>
</head>

<body class="bg-slate-50">

<header class="sticky top-0 z-20 bg-white/90 backdrop-blur border-b border-slate-200">
  <div class="max-w-[1440px] mx-auto px-2 py-3 flex items-center gap-3">
    <a href="https://qkr3069-beep.github.io/EIS/" aria-label="메인으로 이동">
      <img src="omnicare_logo.png" alt="옴니케어 로고" class="h-12 object-contain cursor-pointer" />
    </a>
    <div class="flex-1">
      <div class="font-semibold text-slate-900">OmniCare Intelligence Hub</div>
      <div class="text-sm muted">거래처 현황 · 전체보기 (영업자)</div>
    </div>
    <button onclick="location.href='https://qkr3069-beep.github.io/EIS/'" class="btn2">메인</button>
    <button onclick="location.href='mypage_sales.html'" class="btn2">마이페이지</button>
  </div>
</header>

<main class="max-w-[1440px] mx-auto px-2 py-6 space-y-6">

  <!-- 개요 -->
  <section class="card p-5">
    <div class="flex items-start justify-between gap-3 flex-wrap">
      <div>
        <div class="text-lg font-extrabold text-slate-900">개요</div>
        <div class="muted small" id="userLine">-</div>
      </div>
      <div class="flex items-center gap-2 flex-wrap">
        <span class="chip">Summary</span>
        <span class="chip" id="countChip">-</span>
      </div>
    </div>

    <div class="divider my-4"></div>

    <!-- ✅ 변경: 내 담당 거래처 폭 축소 + 총누적매출/총누적수검자 동일 폭 -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-12 gap-3">
      <div class="kpiBox lg:col-span-2">
        <div class="kpiLabel">내 담당 거래처</div>
        <div class="kpiValue" id="kpiTotal">-</div>
        <div class="kpiSub">검색과 무관 · 내 담당 전체</div>
      </div>

      <div class="kpiBox lg:col-span-2">
        <div class="kpiLabel">활성 거래처 수</div>
        <div class="kpiValue" id="kpiActive">-</div>
        <div class="kpiSub">마지막 방문일 2개월 이내</div>
      </div>

      <div class="kpiBox lg:col-span-2">
        <div class="kpiLabel">비활성 거래처 수</div>
        <div class="kpiValue" id="kpiInactive">-</div>
        <div class="kpiSub">마지막 방문일 2개월 초과</div>
      </div>

      <div class="kpiBox lg:col-span-3">
        <div class="kpiLabel">총 누적 매출</div>
        <div class="kpiValue" id="kpiRevSum">-</div>
        <div class="kpiSub">검색과 무관 · 내 담당 합계(천원)</div>
      </div>

      <div class="kpiBox lg:col-span-3">
        <div class="kpiLabel">총 누적 수검자 수</div>
        <div class="kpiValue" id="kpiExamSum">-</div>
        <div class="kpiSub">검색과 무관 · 내 담당 합계(명)</div>
      </div>
    </div>
  </section>

  <!-- 거래처 현황 전체보기(검색/정렬) -->
  <section class="card p-5">
    <div class="flex items-start justify-between gap-3 flex-wrap">
      <div>
        <div class="text-lg font-extrabold text-slate-900">거래처 현황 전체보기</div>
        <div class="muted small">검색/정렬은 아래 “목록”에만 적용됩니다. (개요 KPI는 고정)</div>
      </div>
      <span class="chip">Accounts</span>
    </div>

    <div class="divider my-4"></div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-3 items-center">
      <div class="lg:col-span-8">
        <input id="q" class="input w-full" placeholder="거래처 검색 (이름)" />
      </div>

      <div class="lg:col-span-3">
        <select id="sortSel" class="select w-full">
          <option value="REV_DESC">정렬: 누적 매출 높은 순</option>
          <option value="EXAM_DESC">정렬: 누적 수검자 높은 순</option>
          <option value="LASTVISIT_DESC">정렬: 마지막 방문일 최신 순</option>
          <option value="FIRSTVISIT_ASC">정렬: 첫 방문일 오래된 순</option>
          <option value="NAME_ASC">정렬: 거래처명 A→Z</option>
        </select>
      </div>

      <div class="lg:col-span-1 flex items-center justify-end gap-2">
        <button class="iconBtn" id="scrollTopBtn" title="위로">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
          </svg>
        </button>
      </div>
    </div>

    <div class="mt-3 hintBox small">
      ✅ 계약 형태(3자/withKMI/기타), 검진 구분(종검/종검 외/국가), 방문일(최초/최근), 상태(최근 방문 2개월 기준) 컬럼이 포함됩니다.
    </div>
  </section>

  <!-- 거래처 목록 -->
  <section class="card p-5">
    <div class="flex items-center justify-between gap-3 flex-wrap">
      <div>
        <div class="font-extrabold text-slate-900">거래처 목록</div>
        <div class="muted small" id="scopeHint">-</div>
      </div>

      <div class="flex items-center gap-2">
        <select id="showCountSel" class="select">
          <option value="10">10개 노출</option>
          <option value="25" selected>25개 노출</option>
          <option value="50">50개 노출</option>
          <option value="100">100개 노출</option>
        </select>
        <button id="exportBtn" class="btnDark">CSV</button>
      </div>
    </div>

    <div class="divider my-4"></div>

    <div class="overflow-auto">
      <table>
        <thead>
          <tr>
            <th style="min-width:240px;">거래처명</th>
            <th style="min-width:110px;">상태</th>
            <th style="min-width:120px;">계약 형태</th>
            <th class="num" style="min-width:150px;">금년도 누적 매출</th>
            <th class="num" style="min-width:140px;">금년도 누적 수검자</th>
            <th style="min-width:220px;">검진 구분</th>
            <th style="min-width:140px;">첫 방문일</th>
            <th style="min-width:140px;">마지막 방문일</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="mt-4 muted small" id="pagingHint">-</div>
  </section>

  <footer class="text-center muted small py-6">
    샘플 화면입니다. 실제 서비스에서는 DB/권한/ERP/방문로그 연동으로 대체됩니다.
  </footer>
</main>

<script>
/** =========================
 *  로그인 사용자(샘플)
 * ========================= */
const CURRENT_USER = { id:"u1", name:"김영업", team:"A팀", role:"sales" };
const NOW_YM = "2025-12";

/** =========================
 *  유틸
 * ========================= */
const fmt = (n) => (n ?? 0).toLocaleString("ko-KR");

function parseDateYMD(ymd){
  const d = new Date(ymd + "T00:00:00");
  return Number.isNaN(d.getTime()) ? null : d;
}
function toYMD(d){
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const dd=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${dd}`;
}
function addDays(base, days){
  const d=new Date(base);
  d.setDate(d.getDate()+days);
  return d;
}
function addMonths(date, months){
  const d = new Date(date);
  d.setMonth(d.getMonth() + months);
  return d;
}
function seededRand(i){
  const x = Math.sin(i * 999) * 10000;
  return x - Math.floor(x);
}

/** 상태 판정: 마지막 방문일이 "오늘 기준 2개월 이내"면 활성 */
function isActiveByLastVisitYMD(lastVisitYMD){
  const dt = parseDateYMD(lastVisitYMD);
  if (!dt) return false;
  const today = new Date();
  const cutoff = addMonths(today, -2);
  return dt >= cutoff;
}
function statusPillHTML(lastVisitYMD){
  const on = isActiveByLastVisitYMD(lastVisitYMD);
  if (on) return `<span class="statusPill status-on"><i></i>활성</span>`;
  return `<span class="statusPill status-off"><i></i>비활성</span>`;
}

/** =========================
 *  샘플 거래처 생성 (천원)
 * ========================= */
function makeSampleAccounts(n=100){
  const owners = ["김영업","박영업","이영업","최영업"];
  const prefixes = ["메디컬","종합","헬스","케어","바이오","메디","건강","연구","검진","파트너"];
  const cities = ["대구","수성","달서","동구","서구","중구","수원","부산","광주","제주","여의도","강남","광화문"];
  const contractTypes = ["3자","withKMI","기타"];

  const base = new Date("2025-12-15T00:00:00");
  const out = [];

  for(let i=1;i<=n;i++){
    const r1 = seededRand(i);
    const r2 = seededRand(i+100);
    const r3 = seededRand(i+200);
    const r4 = seededRand(i+300);

    const owner = owners[Math.floor(r1*owners.length)];
    const name = `${cities[Math.floor(r2*cities.length)]}${prefixes[Math.floor(r3*prefixes.length)]}센터 ${String(i).padStart(3,"0")}`;

    // 매출(천원)
    const ytdRevenue = Math.round( (20000 + r1*480000) / 10 ) * 10;

    // 누적 수검자
    const ytdExaminees = Math.round( 20 + r3*980 );

    // 검진 구분(합=누적수검자)
    const 종검 = Math.max(0, Math.round(ytdExaminees * (0.35 + r2*0.35)));
    const 국가 = Math.max(0, Math.round(ytdExaminees * (0.10 + r4*0.30)));
    const 종검외 = Math.max(0, ytdExaminees - 종검 - 국가);

    // 계약 형태
    const contractType = contractTypes[
      r2 < 0.45 ? 0 : (r2 < 0.80 ? 1 : 2)
    ];

    // 방문일
    const firstVisit = addDays(base, -(30 + Math.floor(r3*320)));
    const lastVisit  = addDays(base, -(Math.floor(r1*45)));
    const fv = firstVisit.getTime() <= lastVisit.getTime() ? firstVisit : addDays(lastVisit, -Math.floor(20 + r2*80));

    out.push({
      id:`a${i}`,
      name,
      owner,
      contractType,
      ytdRevenue,
      ytdExaminees,
      examSplit: { 종검, 종검외, 국가 },
      firstVisitDate: toYMD(fv),
      lastVisitDate: toYMD(lastVisit),
    });
  }
  return out;
}
const ACCOUNTS = makeSampleAccounts(100);

/** =========================
 *  스코프(내 담당)
 * ========================= */
function scopedAccounts(){
  return ACCOUNTS.filter(a => a.owner === CURRENT_USER.name);
}

/** =========================
 *  필터/정렬 (목록 전용)
 * ========================= */
function getFilteredList(){
  const all = scopedAccounts();
  const q = (document.getElementById("q").value || "").trim().toLowerCase();
  const sort = document.getElementById("sortSel").value;

  let list = all.slice();

  if (q){
    list = list.filter(a => a.name.toLowerCase().includes(q));
  }

  list.sort((a,b)=>{
    if (sort === "REV_DESC") return (b.ytdRevenue||0) - (a.ytdRevenue||0);
    if (sort === "EXAM_DESC") return (b.ytdExaminees||0) - (a.ytdExaminees||0);
    if (sort === "LASTVISIT_DESC"){
      const ad = parseDateYMD(a.lastVisitDate) || new Date(0);
      const bd = parseDateYMD(b.lastVisitDate) || new Date(0);
      return bd - ad;
    }
    if (sort === "FIRSTVISIT_ASC"){
      const ad = parseDateYMD(a.firstVisitDate) || new Date(8640000000000000);
      const bd = parseDateYMD(b.firstVisitDate) || new Date(8640000000000000);
      return ad - bd;
    }
    if (sort === "NAME_ASC") return (a.name||"").localeCompare(b.name||"", "ko");
    return 0;
  });

  return { all, list, q, sort };
}

function contractPill(t){
  if (t === "3자") return `<span class="pill pill-blue">3자</span>`;
  if (t === "withKMI") return `<span class="pill pill-indigo">withKMI</span>`;
  return `<span class="pill pill-slate">기타</span>`;
}
function examSplitPills(split){
  const a = split?.종검 ?? 0;
  const b = split?.종검외 ?? 0;
  const c = split?.국가 ?? 0;
  return `
    <span class="pill pill-blue">종검 ${fmt(a)}</span>
    <span class="pill pill-slate">종검 외 ${fmt(b)}</span>
    <span class="pill pill-indigo">국가 ${fmt(c)}</span>
  `;
}

/** =========================
 *  개요 KPI (항상 "내 담당 전체" 기준 / 검색 무관)
 * ========================= */
function renderSummaryFixed(){
  const all = scopedAccounts();
  const total = all.length;

  const active = all.filter(a => isActiveByLastVisitYMD(a.lastVisitDate)).length;
  const inactive = Math.max(0, total - active);

  const revSum = all.reduce((s,a)=> s + (a.ytdRevenue||0), 0);
  const examSum = all.reduce((s,a)=> s + (a.ytdExaminees||0), 0);

  document.getElementById("kpiTotal").textContent = `${fmt(total)}`;
  document.getElementById("kpiActive").textContent = `${fmt(active)}`;
  document.getElementById("kpiInactive").textContent = `${fmt(inactive)}`;
  document.getElementById("kpiRevSum").textContent = `${fmt(revSum)} 천원`;
  document.getElementById("kpiExamSum").textContent = `${fmt(examSum)} 명`;

  document.getElementById("userLine").textContent = `${CURRENT_USER.name} · ${CURRENT_USER.team} · ${NOW_YM} 기준`;
  document.getElementById("countChip").textContent = `내 담당 ${fmt(total)}곳`;
}

/** =========================
 *  목록 렌더 (검색/정렬/노출수 반영)
 * ========================= */
function getShowCount(){
  const v = parseInt(document.getElementById("showCountSel").value, 10);
  return Number.isFinite(v) ? v : 25;
}

function renderList(){
  const tbody = document.getElementById("tbody");
  const { list, q } = getFilteredList();
  const showCount = getShowCount();

  const shown = list.slice(0, showCount);

  tbody.innerHTML = "";
  if (!shown.length){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="8" class="muted" style="padding:14px;">표시할 거래처가 없습니다.</td>`;
    tbody.appendChild(tr);
  }else{
    shown.forEach(a=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="font-weight:900;">
          <a class="link" href="accounts_by_customer.html?q=${encodeURIComponent(a.name)}">${a.name}</a>
          <div class="muted small mt-1">담당: ${a.owner}</div>
        </td>
        <td>${statusPillHTML(a.lastVisitDate)}</td>
        <td>${contractPill(a.contractType)}</td>
        <td class="num">${fmt(a.ytdRevenue)} 천원</td>
        <td class="num">${fmt(a.ytdExaminees)} 명</td>
        <td>${examSplitPills(a.examSplit)}</td>
        <td>${a.firstVisitDate || "-"}</td>
        <td>${a.lastVisitDate || "-"}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  document.getElementById("scopeHint").textContent =
    q ? `현재 필터 · 검색: “${q}”` : "현재 필터 없음 · 내 담당 전체";

  document.getElementById("pagingHint").textContent =
    `표시: 검색 결과 ${fmt(list.length)}건 중 상위 ${fmt(Math.min(showCount, list.length))}건 노출 · CSV도 동일 수량으로 다운로드`;
}

/** =========================
 *  CSV Export (현재 노출 수량만)
 * ========================= */
function downloadCSV(){
  const { list } = getFilteredList();
  const showCount = getShowCount();
  const shown = list.slice(0, showCount);

  const header = [
    "거래처명","상태","계약 형태","금년도 누적 매출(천원)","금년도 누적 수검자(명)",
    "종검(명)","종검 외(명)","국가(명)","첫 방문일","마지막 방문일"
  ];

  const rows = shown.map(a => ([
    a.name,
    isActiveByLastVisitYMD(a.lastVisitDate) ? "활성" : "비활성",
    a.contractType,
    a.ytdRevenue ?? 0,
    a.ytdExaminees ?? 0,
    a.examSplit?.종검 ?? 0,
    a.examSplit?.종검외 ?? 0,
    a.examSplit?.국가 ?? 0,
    a.firstVisitDate ?? "",
    a.lastVisitDate ?? ""
  ]));

  const csv = [header, ...rows]
    .map(r => r.map(v => {
      const s = String(v ?? "");
      return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    }).join(","))
    .join("\n");

  const blob = new Blob([csv], { type:"text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `accounts_${CURRENT_USER.name}_${NOW_YM}_top${showCount}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/** =========================
 *  이벤트
 * ========================= */
document.getElementById("q").addEventListener("input", renderList);
document.getElementById("sortSel").addEventListener("change", renderList);
document.getElementById("showCountSel").addEventListener("change", renderList);
document.getElementById("exportBtn").addEventListener("click", downloadCSV);

document.getElementById("scrollTopBtn").addEventListener("click", ()=>{
  window.scrollTo({ top:0, behavior:"smooth" });
});

/** 초기 렌더 */
renderSummaryFixed(); // ✅ 개요는 고정
renderList();         // ✅ 목록만 검색/정렬로 갱신
</script>

</body>
</html>
