<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>OmniCare EIS · Omni Sales Overview</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css" />
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
  html,body{ font-family:"Pretendard Variable", system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
  :root{
    --card:#fff;
    --muted:#64748b;
    --divider:#e5e7eb;
    --shadow:0 8px 24px rgba(15,23,42,.06);
    --radius:16px;
  }
  .card{ background:var(--card); border:1px solid var(--divider); border-radius:var(--radius); box-shadow:var(--shadow); }
  .muted{ color:var(--muted); }
  .divider{ height:1px; background:var(--divider); }

  .chip{ border:1px solid var(--divider); border-radius:999px; padding:.25rem .6rem; font-size:.8rem; color:#334155; background:#f8fafc; font-weight:900; }
  .btn2{ border:1px solid var(--divider); background:#fff; color:#0f172a; border-radius:12px; padding:.55rem .9rem; font-weight:900; }
  .btn2:hover{ background:#f8fafc; }

  .input{
    border:1px solid var(--divider);
    border-radius:12px;
    padding:.6rem .8rem;
    background:#fff;
    width:100%;
    outline:none;
    font-weight:900;
    color:#0f172a;
  }
  .input:focus{ border-color:#c7d2fe; box-shadow:0 0 0 4px rgba(31,79,255,.08); }

  .kpiRow{ display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; }
  .kpi{
    border:1px solid var(--divider);
    border-radius:14px;
    background:#fff;
    padding:10px 12px;
  }
  .kpi .t{ font-size:.78rem; color:var(--muted); font-weight:900; }
  .kpi .v{ font-size:1.15rem; font-weight:900; color:#0f172a; margin-top:2px; }
  .kpi .s{ font-size:.78rem; color:var(--muted); margin-top:2px; font-weight:800; }

  .kpiGrid{
    display:grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap:10px;
  }
  @media (min-width: 1024px){
    .kpiGrid{ grid-template-columns: repeat(5, minmax(0, 1fr)); }
  }

  .chart-equal{
    display:grid;
    gap:12px;
    align-items:end;
    overflow:hidden;
    padding-bottom:6px;
  }
  .bar-col{ display:flex; flex-direction:column; align-items:center; gap:6px; min-width:0; }
  .bar-area{ position:relative; width:100%; height:250px; display:flex; align-items:flex-end; }

  .bar-stack{
    position:absolute;
    bottom:0;
    left:50%;
    transform:translateX(-50%);
    width:56%;
    border-radius:10px;
    overflow:hidden;
    display:flex;
    flex-direction:column;
    justify-content:flex-end;
    background:transparent;
  }
  .segV{ width:100%; }
  .segV-third{ background:#93c5fd; }
  .segV-with { background:#fca5a5; }
  .segV-etc  {
    background:#22c55e !important;
    box-shadow: inset 0 0 0 1px rgba(15,23,42,.18);
  }

  .top-num{ font-size:.72rem; color:#374151; font-weight:900; }
  .bottom-num{ font-size:.72rem; color:#0f172a; font-weight:900; }
  .bar-label{
    font-size:.82rem; font-weight:900; color:#0f172a; text-align:center;
    max-width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
  }

  .stack{
    width:100%;
    border:1px solid var(--divider);
    border-radius:14px;
    overflow:hidden;
    background:#f8fafc;
    height:14px;
    display:flex;
  }
  .seg{ height:100%; display:block; flex:0 0 auto; }
  .seg-third{ background:#93c5fd; }
  .seg-with{  background:#fca5a5; }
  .seg-etc{
    background:#22c55e !important;
    box-shadow: inset 0 0 0 1px rgba(15,23,42,.18);
  }
  .legend{
    display:flex; flex-wrap:wrap; gap:10px; margin-top:8px;
    font-size:.82rem; color:#334155; font-weight:900;
  }
  .dot{ width:10px; height:10px; border-radius:3px; display:inline-block; margin-right:6px; vertical-align:middle; }
  .dot-third{ background:#93c5fd; }
  .dot-with{ background:#fca5a5; }
  .dot-etc{ background:#22c55e; }

  .table-wrap{ overflow:auto; border-radius:14px; border:1px solid var(--divider); }
  table{ width:100%; border-collapse:separate; border-spacing:0; }
  th, td{ padding:12px 12px; border-bottom:1px solid var(--divider); }
  th{
    position:sticky; top:0;
    background:#f8fafc;
    text-align:left;
    font-size:.85rem;
    color:#475569;
    z-index:1;
    user-select:none;
    white-space:nowrap;
    font-weight:900;
  }
  tr:hover td{ background:#fbfdff; }
  .right{ text-align:right; }
  .mono{ font-variant-numeric:tabular-nums; }

  .badge{
    font-size:.75rem;
    padding:.2rem .55rem;
    border-radius:999px;
    border:1px solid var(--divider);
    background:#fff;
    white-space:nowrap;
    font-weight:900;
  }
  .badge-ok{ background:#ecfeff; border-color:#a5f3fc; color:#155e75; }
  .badge-warn{ background:#fffbeb; border-color:#fde68a; color:#92400e; }
  .badge-bad{ background:#fef2f2; border-color:#fecaca; color:#991b1b; }

  .secTitle{ font-weight:900; color:#0f172a; font-size:1.05rem; }
  .secSub{ font-size:.85rem; color:var(--muted); font-weight:900; margin-top:2px; }

  .miniUpload{
    display:flex;
    align-items:center;
    gap:10px;
  }
  .miniUpload .miniBtn{
    border:1px solid var(--divider);
    border-radius:999px;
    padding:.25rem .6rem;
    font-size:.78rem;
    font-weight:900;
    background:#fff;
    color:#0f172a;
    cursor:pointer;
    user-select:none;
  }
  .miniUpload .miniBtn:hover{ background:#f8fafc; }
  .miniUpload input[type="file"]{ display:none; }
  .miniPill{
    border:1px solid #e2e8f0;
    background:#f8fafc;
    color:#334155;
    border-radius:999px;
    padding:.25rem .6rem;
    font-size:.72rem;
    font-weight:900;
  }
</style>
</head>

<body class="bg-slate-50">

<header class="sticky top-0 z-20 bg-white/90 backdrop-blur border-b border-slate-200">
  <div class="max-w-[1440px] mx-auto px-2 py-3 flex items-center gap-3">
    <a href="https://qkr3069-beep.github.io/EIS/" aria-label="메인으로 이동">
      <img src="omnicare_logo.png" alt="옴니케어 로고" class="h-12 object-contain cursor-pointer" />
    </a>
    <div class="flex-1">
      <div class="font-semibold text-slate-900">Omni Sales Overview</div>
      <div class="text-sm muted">옴니케어 매출 · 전체 → 영업부 상세(구성/직원 기여)</div>
    </div>

    <button onclick="location.href='index.html'" class="btn2">메인</button>
    <button onclick="location.href='admin_manager.html'" class="btn2">관리자 페이지</button>
    <button onclick="location.href='mypage_sales.html'" class="btn2">마이페이지</button>
  </div>
</header>

<main class="max-w-[1440px] mx-auto px-2 py-6 space-y-6">

  <!-- 1) 상단: 전체 누계 -->
  <section class="card p-5">
    <div class="flex items-start justify-between gap-3">
      <div>
        <div class="font-extrabold text-slate-900 text-lg">옴니케어 · 전체 누계 매출</div>
        <div class="muted text-sm font-semibold">3자 / WITH KMI / 기타 구성 포함 · 단위: 천원</div>
      </div>
      <span class="chip">단위: 천원</span>
    </div>

    <div class="kpiRow">
      <div class="kpi">
        <div class="t">2025년 예상(합계)</div>
        <div class="v mono" id="omniExpectedTotal">-</div>
        <div class="s">3자 + WITH KMI + 기타</div>
      </div>
      <div class="kpi">
        <div class="t">현재 누계(합계)</div>
        <div class="v mono" id="omniCurrentTotal">-</div>
        <div class="s">3자 + WITH KMI + 기타</div>
      </div>
    </div>

    <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
      <div class="p-4 rounded-2xl border border-slate-200 bg-slate-50">
        <div class="font-extrabold text-slate-900">예상 구성</div>
        <div class="stack mt-2" aria-label="예상 매출 구성">
          <span class="seg seg-third" id="expThird" style="width:0%"></span>
          <span class="seg seg-with"  id="expWith"  style="width:0%"></span>
          <span class="seg seg-etc"   id="expEtc"   style="width:0%"></span>
        </div>
        <div class="legend">
          <span><i class="dot dot-third"></i>3자: <span id="expThirdTxt">-</span></span>
          <span><i class="dot dot-with"></i>WITH KMI: <span id="expWithTxt">-</span></span>
          <span><i class="dot dot-etc"></i>기타: <span id="expEtcTxt">-</span></span>
        </div>
      </div>

      <div class="p-4 rounded-2xl border border-slate-200 bg-slate-50">
        <div class="font-extrabold text-slate-900">현재 구성</div>
        <div class="stack mt-2" aria-label="현재 매출 구성">
          <span class="seg seg-third" id="curThird" style="width:0%"></span>
          <span class="seg seg-with"  id="curWith"  style="width:0%"></span>
          <span class="seg seg-etc"   id="curEtc"   style="width:0%"></span>
        </div>
        <div class="legend">
          <span><i class="dot dot-third"></i>3자: <span id="curThirdTxt">-</span></span>
          <span><i class="dot dot-with"></i>WITH KMI: <span id="curWithTxt">-</span></span>
          <span><i class="dot dot-etc"></i>기타: <span id="curEtcTxt">-</span></span>
        </div>
      </div>
    </div>
  </section>

  <!-- 2) 본부/지사별 총합 차트 -->
  <section class="card p-5">
    <div class="flex items-start justify-between gap-3">
      <div>
        <div class="font-extrabold text-slate-900 text-lg">본부/지사별 매출(총합)</div>
        <div class="muted text-sm font-semibold">각 영업부 총합(3자+WITH+기타) · 단위: 천원</div>
      </div>

      <div class="flex items-center gap-2">
        <span class="chip">ORG</span>
        <div class="miniUpload" title="엑셀 수동 업로드(.xlsx/.xls)">
          <label class="miniBtn" for="excelFileInputMini">엑셀 업로드</label>
          <input id="excelFileInputMini" type="file" accept=".xlsx,.xls" />
          <span class="miniPill" id="excelMiniStatus">자동 로드</span>
        </div>
      </div>
    </div>

    <div class="mt-4 chart-equal" id="omniChartByOrg"></div>

    <div class="mt-3 muted text-xs font-semibold">
      ※ ✅ 하단=3자 → 중단=WITH KMI → 상단=기타
    </div>
    <div class="legend mt-3">
      <span><i class="dot dot-third"></i>3자</span>
      <span><i class="dot dot-with"></i>WITH KMI</span>
      <span><i class="dot dot-etc"></i>기타</span>
    </div>

    <div class="mt-3 text-xs muted font-semibold" id="excelHint">-</div>
  </section>

  <!-- 3) 영업부 선택 + 상세 -->
  <section class="card p-5">
    <div class="flex items-start justify-between gap-3">
      <div>
        <div class="secTitle">영업부 상세</div>
        <div class="secSub" id="orgSubtitle">본부/지사를 선택하면 상세(구성/직원 기여)가 표시됩니다.</div>
      </div>
      <span class="chip" id="orgChip">ORG</span>
    </div>

    <div class="divider my-4"></div>

    <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
      <div class="text-xs muted font-extrabold">본부/지사 선택</div>
      <select id="orgSel" class="input mt-2"></select>

      <div class="mt-3 kpiGrid">
        <div class="kpi">
          <div class="t">선택 영업부 총 매출</div>
          <div class="v mono" id="orgTotalSales">-</div>
          <div class="s">3자 + WITH + 기타 (현재 기준)</div>
        </div>

        <div class="kpi">
          <div class="t">누적 검진자 수</div>
          <div class="v mono" id="orgExamCount">-</div>
          <div class="s">엑셀에 없으면 “-”</div>
        </div>

        <div class="kpi">
          <div class="t">3자 매출</div>
          <div class="v mono" id="orgThirdSales">-</div>
          <div class="s">현재 3자 합</div>
        </div>

        <div class="kpi">
          <div class="t">WITH KMI 매출</div>
          <div class="v mono" id="orgWithSales">-</div>
          <div class="s">현재 withKMI 합</div>
        </div>

        <div class="kpi">
          <div class="t">기타 매출</div>
          <div class="v mono" id="orgEtcSales">-</div>
          <div class="s">엑셀에 없으면 0</div>
        </div>
      </div>
    </div>

    <div class="mt-4 p-4 rounded-2xl border border-slate-200 bg-slate-50">
      <div class="font-extrabold text-slate-900">매출 형태 구성 (3자 / WITH KMI / 기타)</div>
      <div class="stack mt-2">
        <span class="seg seg-third" id="orgSegThird" style="width:0%"></span>
        <span class="seg seg-with"  id="orgSegWith"  style="width:0%"></span>
        <span class="seg seg-etc"   id="orgSegEtc"   style="width:0%"></span>
      </div>
      <div class="legend">
        <span><i class="dot dot-third"></i>3자: <span id="orgThirdTxt">-</span></span>
        <span><i class="dot dot-with"></i>WITH KMI: <span id="orgWithTxt">-</span></span>
        <span><i class="dot dot-etc"></i>기타: <span id="orgEtcTxt">-</span></span>
      </div>
    </div>

    <div class="mt-4 p-4 rounded-2xl border border-slate-200 bg-white">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="font-extrabold text-slate-900">직원별 기여도</div>
          <div class="muted text-sm font-semibold mt-1">기여 매출(천원) 기준 · (현재 기준)</div>
        </div>
        <span class="chip">STAFF</span>
      </div>

      <div class="divider my-4"></div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>직원</th>
              <th>팀</th>
              <th class="right">3자(현재/천원)</th>
              <th class="right">withKMI(현재/천원)</th>
              <th class="right">기여 매출(현재/천원)</th>
              <th class="right">기여율(현재)</th>
              <th>평가</th>
            </tr>
          </thead>
          <tbody id="staffTbody"></tbody>
        </table>
      </div>

      <div class="mt-3 muted text-xs font-semibold" id="staffFoot">-</div>
    </div>
  </section>

  <footer class="text-center muted text-sm py-6 font-semibold">
    ※ 본 페이지는 엑셀 기반 집계 데모입니다.
  </footer>
</main>

<script>
/* =========================================================
   ✅ 설정
   ========================================================= */
const EXCEL_FILE_NAME = "EIS_사원별 매출_샘플.xlsx"; // 같은 폴더에 있어야 함
const WON_TO_TH = 1000;

/* =========================================================
   유틸
   ========================================================= */
const $ = (id)=>document.getElementById(id);

function safeSetText(id, text){
  const el = $(id);
  if (!el) return;
  el.textContent = text;
}
function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
function fmtNum(n){ return (Number(n)||0).toLocaleString("ko-KR"); }
function fmtTh(n){ return fmtNum(n) + "천원"; }
function pct(x){ return (x*100).toFixed(1) + "%"; }

function parseMoney(v){
  if (v == null) return 0;
  if (typeof v === "number") return v;
  const s = String(v).trim().replaceAll(",","");
  const num = Number(s);
  return Number.isFinite(num) ? num : 0;
}
function toThousandWon(v){ return Math.round(parseMoney(v) / WON_TO_TH); }

function applyStack3(ids, values, minPct=1.2){
  const [idA,idB,idC] = ids;
  const [a,b,c] = values.map(v=>Number(v)||0);
  const total = a+b+c;

  const elA = $(idA), elB = $(idB), elC = $(idC);
  if (!elA || !elB || !elC) return;

  if (total <= 0){
    elA.style.width="0%"; elB.style.width="0%"; elC.style.width="0%";
    return;
  }

  let pA=(a/total)*100, pB=(b/total)*100, pC=(c/total)*100;
  if (a>0 && pA<minPct) pA=minPct;
  if (b>0 && pB<minPct) pB=minPct;
  if (c>0 && pC<minPct) pC=minPct;

  const sum=pA+pB+pC;
  if (sum>100){
    const scale=100/sum;
    pA*=scale; pB*=scale; pC*=scale;
  }
  pA=clamp(pA,0,100);
  pB=clamp(pB,0,100);
  pC=clamp(100-pA-pB,0,100);

  elA.style.width=pA.toFixed(4)+"%";
  elB.style.width=pB.toFixed(4)+"%";
  elC.style.width=pC.toFixed(4)+"%";
}

function badgeByShare(share){
  if (share >= 0.45) return { cls:"badge badge-bad", label:"핵심" };
  if (share >= 0.25) return { cls:"badge badge-warn", label:"주요" };
  return { cls:"badge badge-ok", label:"기여" };
}

/* ===== 차트용 ===== */
function stackPctsWithMin(third, withKmi, etc, minPct=1.6){
  const total = (third||0) + (withKmi||0) + (etc||0);
  if (total <= 0) return { pThird:0, pWith:0, pEtc:0 };

  let pThird = (third/total)*100;
  let pWith  = (withKmi/total)*100;
  let pEtc   = (etc/total)*100;

  if (third>0 && pThird < minPct) pThird = minPct;
  if (withKmi>0 && pWith < minPct) pWith = minPct;
  if (etc>0 && pEtc < minPct) pEtc = minPct;

  const sum = pThird + pWith + pEtc;
  const scale = sum>0 ? (100/sum) : 1;
  pThird *= scale; pWith *= scale; pEtc *= scale;

  const fixed3 = Math.max(0, pThird);
  const fixedW = Math.max(0, pWith);
  const fixedE = Math.max(0, 100 - fixed3 - fixedW);
  return { pThird:fixed3, pWith:fixedW, pEtc:fixedE };
}

function renderOrgStackedBars_EqualCols(data, wrapId){
  const wrap = $(wrapId);
  if (!wrap) return;

  wrap.classList.add("chart-equal");
  wrap.style.gridTemplateColumns = `repeat(${data.length}, minmax(0, 1fr))`;
  wrap.innerHTML = "";

  const maxTotal = Math.max(...data.map(d=>d.total||0), 1);

  data.forEach(d=>{
    const totalH = (d.total/maxTotal)*100;
    const { pThird, pWith, pEtc } = stackPctsWithMin(d.third, d.with, d.etc, 1.6);

    const col = document.createElement("div");
    col.className = "bar-col";
    col.innerHTML = `
      <div class="top-num">${fmtNum(d.total||0)}</div>
      <div class="bar-area">
        <div class="bar-stack" style="height:${totalH}%">
          <div class="segV segV-etc"   style="height:${pEtc}%;"></div>
          <div class="segV segV-with"  style="height:${pWith}%;"></div>
          <div class="segV segV-third" style="height:${pThird}%;"></div>
        </div>
      </div>
      <div class="bottom-num">${fmtNum(d.total||0)}</div>
      <div class="bar-label" title="${d.name||"-"}">${d.name||"-"}</div>
    `;
    wrap.appendChild(col);
  });
}

/* =========================================================
   ✅ 엑셀 읽기: 헤더 가진 시트 자동 탐지
   ========================================================= */
const REQUIRED_HEADERS = ["직원","부서","팀","3자(현재)","withKMI(현재)","3자(예상)","withKMI(예상)"];
function normalizeKey(k){ return String(k||"").trim().replace(/\s+/g,""); }
function rowKeys(rowObj){ return Object.keys(rowObj||{}).map(normalizeKey); }
function hasRequiredHeaders(keys){
  const set = new Set(keys);
  return REQUIRED_HEADERS.every(h => set.has(normalizeKey(h)));
}
function pickSheetByHeaders(workbook){
  const names = workbook.SheetNames || [];
  for (const name of names){
    const sheet = workbook.Sheets[name];
    if (!sheet) continue;
    const rows = XLSX.utils.sheet_to_json(sheet, { defval:"" });
    if (!rows || rows.length === 0) continue;
    const keys = rowKeys(rows[0]);
    if (hasRequiredHeaders(keys)){
      return { name, sheet, rows };
    }
  }
  return null;
}

/* =========================================================
   ✅ 모델 생성 (현재/예상)
   ========================================================= */
function buildModelFromRows(rows){
  const staffByOrg = {};
  const orgAgg = {};

  let curThird=0, curWith=0, curEtc=0;
  let expThird=0, expWith=0, expEtc=0;

  for (const r of rows){
    const emp  = String(r["직원"] ?? "").trim();
    const org  = String(r["부서"] ?? "").trim();
    const team = String(r["팀"] ?? "").trim();
    if (!org) continue;

    // ✅ 현재
    const curThirdTh = toThousandWon(r["3자(현재)"]);
    const curWithTh  = toThousandWon(r["withKMI(현재)"]);
    const curEtcTh   = 0;

    // ✅ 예상
    const expThirdTh = toThousandWon(r["3자(예상)"]);
    const expWithTh  = toThousandWon(r["withKMI(예상)"]);
    const expEtcTh   = 0;

    const curSalesTh = curThirdTh + curWithTh + curEtcTh;
    const expSalesTh = expThirdTh + expWithTh + expEtcTh;

    curThird += curThirdTh; curWith += curWithTh; curEtc += curEtcTh;
    expThird += expThirdTh; expWith += expWithTh; expEtc += expEtcTh;

    if (!orgAgg[org]) {
      orgAgg[org] = {
        curThirdTh:0, curWithTh:0, curEtcTh:0, curTotalTh:0,
        expThirdTh:0, expWithTh:0, expEtcTh:0, expTotalTh:0
      };
    }

    orgAgg[org].curThirdTh += curThirdTh;
    orgAgg[org].curWithTh  += curWithTh;
    orgAgg[org].curEtcTh   += curEtcTh;
    orgAgg[org].curTotalTh += curSalesTh;

    orgAgg[org].expThirdTh += expThirdTh;
    orgAgg[org].expWithTh  += expWithTh;
    orgAgg[org].expEtcTh   += expEtcTh;
    orgAgg[org].expTotalTh += expSalesTh;

    if (!staffByOrg[org]) staffByOrg[org] = [];
    staffByOrg[org].push({
      name: emp || "(이름없음)",
      team: team || "-",

      // 현재
      curThirdTh, curWithTh, curEtcTh,
      curSalesTh,
      curShare: 0,

      // 예상
      expThirdTh, expWithTh, expEtcTh,
      expSalesTh,
      expShare: 0
    });
  }

  // 기여율 계산(현재/예상 각각)
  for (const org of Object.keys(staffByOrg)){
    const list = staffByOrg[org];

    const curSum = list.reduce((s,x)=>s + (x.curSalesTh||0), 0);
    list.forEach(x => x.curShare = curSum>0 ? x.curSalesTh/curSum : 0);

    const expSum = list.reduce((s,x)=>s + (x.expSalesTh||0), 0);
    list.forEach(x => x.expShare = expSum>0 ? x.expSalesTh/expSum : 0);

    // 기본 정렬: 현재 기준
    list.sort((a,b)=> (b.curSalesTh||0) - (a.curSalesTh||0));
  }

  const orgList = Object.keys(orgAgg)
    .map(name => ({ name, ...orgAgg[name] }))
    .sort((a,b)=> (b.curTotalTh||0) - (a.curTotalTh||0));

  return {
    totals: {
      curThirdTh: curThird,
      curWithTh:  curWith,
      curEtcTh:   curEtc,
      curTotalTh: curThird + curWith + curEtc,

      expThirdTh: expThird,
      expWithTh:  expWith,
      expEtcTh:   expEtc,
      expTotalTh: expThird + expWith + expEtc
    },
    orgList,
    staffByOrg
  };
}

/* =========================================================
   ✅ 렌더
   ========================================================= */
function renderTopTotals(model){
  const t = model.totals;

  // 합계
  safeSetText("omniCurrentTotal",  fmtTh(t.curTotalTh));
  safeSetText("omniExpectedTotal", fmtTh(t.expTotalTh));

  // 예상 구성
  applyStack3(["expThird","expWith","expEtc"], [t.expThirdTh, t.expWithTh, t.expEtcTh], 1.2);
  safeSetText("expThirdTxt", fmtTh(t.expThirdTh));
  safeSetText("expWithTxt",  fmtTh(t.expWithTh));
  safeSetText("expEtcTxt",   fmtTh(t.expEtcTh));

  // 현재 구성
  applyStack3(["curThird","curWith","curEtc"], [t.curThirdTh, t.curWithTh, t.curEtcTh], 1.2);
  safeSetText("curThirdTxt", fmtTh(t.curThirdTh));
  safeSetText("curWithTxt",  fmtTh(t.curWithTh));
  safeSetText("curEtcTxt",   fmtTh(t.curEtcTh));
}

function renderOrgChart_Current(model){
  // ✅ ORG 차트는 "현재" 기준
  const bars = (model.orgList||[]).map(o=>({
    name: o.name,
    total: o.curTotalTh,
    third: o.curThirdTh,
    with:  o.curWithTh,
    etc:   o.curEtcTh
  }));
  renderOrgStackedBars_EqualCols(bars, "omniChartByOrg");
}

function setOrgOptions(orgNames){
  const sel = $("orgSel");
  if (!sel) return;
  sel.innerHTML = "";
  orgNames.forEach(n=>{
    const opt = document.createElement("option");
    opt.value = n;
    opt.textContent = n;
    sel.appendChild(opt);
  });
}

function renderOrgDetail_Current(orgName, model){
  safeSetText("orgChip", orgName);

  const agg = (model.orgList||[]).find(x=>x.name===orgName);
  const thirdTh = agg?.curThirdTh || 0;
  const withTh  = agg?.curWithTh  || 0;
  const etcTh   = agg?.curEtcTh   || 0;
  const totalTh = agg?.curTotalTh || 0;

  safeSetText("orgSubtitle", `${orgName} · 총 ${fmtTh(totalTh)} (3자 ${fmtTh(thirdTh)} / WITH ${fmtTh(withTh)} / 기타 ${fmtTh(etcTh)})`);
  safeSetText("orgTotalSales", fmtTh(totalTh));
  safeSetText("orgThirdSales", fmtTh(thirdTh));
  safeSetText("orgWithSales",  fmtTh(withTh));
  safeSetText("orgEtcSales",   fmtTh(etcTh));

  // 검진자 수 컬럼이 없으니 "-"
  safeSetText("orgExamCount", "-");

  applyStack3(["orgSegThird","orgSegWith","orgSegEtc"], [thirdTh, withTh, etcTh], 1.2);
  safeSetText("orgThirdTxt", fmtTh(thirdTh));
  safeSetText("orgWithTxt",  fmtTh(withTh));
  safeSetText("orgEtcTxt",   fmtTh(etcTh));

  // 직원별 (현재 기준)
  const list = (model.staffByOrg[orgName] || []).slice();
  const tb = $("staffTbody");
  if (tb) tb.innerHTML = "";

  list.forEach(s=>{
    const share = s.curShare || 0;
    const b = badgeByShare(share);

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="font-extrabold text-slate-900">${s.name}</td>
      <td class="muted font-semibold">${s.team}</td>
      <td class="right mono font-extrabold">${fmtNum(s.curThirdTh)}</td>
      <td class="right mono font-extrabold">${fmtNum(s.curWithTh)}</td>
      <td class="right mono font-extrabold">${fmtNum(s.curSalesTh)}</td>
      <td class="right mono font-extrabold">${pct(share)}</td>
      <td><span class="${b.cls}">${b.label}</span></td>
    `;
    tb && tb.appendChild(tr);
  });

  const top = list[0];
  safeSetText("staffFoot",
    top
      ? `Top 기여자: ${top.name} (${top.team}) · 기여매출 ${fmtNum(top.curSalesTh)}천원 · 기여율 ${pct(top.curShare||0)}`
      : "기여 데이터 없음"
  );
}

/* =========================================================
   ✅ 엑셀 로드 (자동 fetch + 수동 업로드)
   ========================================================= */
async function loadWorkbookFromFetch(){
  const url = encodeURI(EXCEL_FILE_NAME) + "?t=" + Date.now();
  safeSetText("excelHint", `엑셀: ${EXCEL_FILE_NAME} · 요청: ${url}`);
  const res = await fetch(url, { cache:"no-store" });
  if (!res.ok) throw new Error(`fetch 실패: HTTP ${res.status} (${res.statusText})`);
  const buf = await res.arrayBuffer();
  return XLSX.read(buf, { type:"array" });
}

async function loadWorkbookFromFile(file){
  const buf = await file.arrayBuffer();
  return XLSX.read(buf, { type:"array" });
}

function setMiniStatus(text, ok=true){
  const el = $("excelMiniStatus");
  if (!el) return;
  el.textContent = text;
  el.style.borderColor = ok ? "#cbd5e1" : "#fecaca";
  el.style.background = ok ? "#f8fafc" : "#fef2f2";
  el.style.color = ok ? "#334155" : "#991b1b";
}

function applyModel(model, sourceLabel, sheetName){
  // 상단 / 차트 / 셀렉트 / 상세
  renderTopTotals(model);
  renderOrgChart_Current(model);

  const orgNames = (model.orgList||[]).map(o=>o.name);
  setOrgOptions(orgNames);

  const sel = $("orgSel");
  if (sel){
    sel.onchange = (e)=> renderOrgDetail_Current(e.target.value, model);
    sel.value = orgNames[0] || "";
  }
  if (orgNames[0]) renderOrgDetail_Current(orgNames[0], model);

  setMiniStatus(sourceLabel, true);
  safeSetText("excelHint", `${sourceLabel} · 시트: ${sheetName} · ORG/상세는 현재 기준(상단은 현재+예상)`);
}

async function applyWorkbook(wb, sourceLabel){
  const picked = pickSheetByHeaders(wb);
  if (!picked){
    const names = (wb.SheetNames||[]).join(", ");
    throw new Error(`필수 헤더 시트를 찾지 못했습니다.\n필요: ${REQUIRED_HEADERS.join(", ")}\n현재 시트: ${names}`);
  }

  console.log("[Excel] source:", sourceLabel);
  console.log("[Excel] sheet used:", picked.name);
  console.log("[Excel] rows:", picked.rows.length);

  const model = buildModelFromRows(picked.rows);
  applyModel(model, sourceLabel, picked.name);
}

async function loadExcelAuto(){
  try{
    setMiniStatus("자동 로딩…", true);
    const wb = await loadWorkbookFromFetch();
    await applyWorkbook(wb, "자동 로드");
  }catch(err){
    console.warn("[Excel] auto load failed:", err);
    setMiniStatus("자동 실패(업로드)", false);
    safeSetText("excelHint", `자동 로드 실패: ${String(err?.message||err)} · 우측 상단에서 업로드로 대체하세요.`);
  }
}

/* =========================================================
   init
   ========================================================= */
(function init(){
  const inpMini = $("excelFileInputMini");
  if (inpMini){
    inpMini.onchange = async (e)=>{
      const file = e.target.files?.[0];
      if (!file) return;
      try{
        setMiniStatus("업로드 로딩…", true);
        safeSetText("excelHint", `업로드 파일: ${file.name}`);
        const wb = await loadWorkbookFromFile(file);
        await applyWorkbook(wb, "업로드 적용");
        setMiniStatus("업로드 적용", true);
      }catch(err){
        console.error("[Excel] upload failed:", err);
        setMiniStatus("업로드 실패", false);
        safeSetText("excelHint", `업로드 실패: ${String(err?.message||err)}`);
      }finally{
        inpMini.value = "";
      }
    };
  }

  loadExcelAuto();
})();
</script>

</body>
</html>
