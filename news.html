<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>옴니케어 뉴스 브리핑</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css" />
  <style>
    html,body{ font-family:"Pretendard Variable", Pretendard, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .card { border:1px solid #e5e7eb; border-radius:16px; background:#fff; box-shadow:0 8px 24px rgba(15,23,42,.06); }
    .chip { border:1px solid #e5e7eb; border-radius:999px; padding:.25rem .6rem; font-size:.8rem; color:#334155; background:#f8fafc; }
    .muted{ color:#64748b; }
    .btn { border:1px solid #e5e7eb; background:#0f172a; color:#fff; border-radius:12px; padding:.55rem .9rem; font-weight:700; }
    .btn2 { border:1px solid #e5e7eb; background:#fff; color:#0f172a; border-radius:12px; padding:.55rem .9rem; font-weight:700; }
    .divider{ height:1px; background:#e5e7eb; }
    .small { font-size:.85rem; }
    input[type="date"]{ color:#0f172a; }
    .news-link{ color:#0f172a; font-weight:800; }
    .news-link:hover{ text-decoration:underline; }

    .badge-load{ border:1px solid #e5e7eb; background:#f8fafc; color:#334155; border-radius:999px; padding:.15rem .55rem; font-size:.75rem; font-weight:800; }
    .badge-ok{ border:1px solid #bbf7d0; background:#ecfdf5; color:#065f46; border-radius:999px; padding:.15rem .55rem; font-size:.75rem; font-weight:800; }
    .badge-err{ border:1px solid #fecaca; background:#fff1f2; color:#9f1239; border-radius:999px; padding:.15rem .55rem; font-size:.75rem; font-weight:800; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 min-h-screen">
  <header class="sticky top-0 z-20 bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="max-w-[1440px] mx-auto px-2 py-3 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
      <div class="flex items-center gap-3">
        <a href="https://qkr3069-beep.github.io/EIS/" aria-label="메인으로 이동" class="shrink-0">
          <img src="omnicare_logo.png" alt="옴니케어 로고" class="h-12 md:h-14 object-contain cursor-pointer" />
        </a>
        <div>
          <div class="font-semibold text-slate-900">OmniCare News Briefing</div>
          <div class="text-sm muted">업계/경쟁/센터/헬스케어 소식을 한 화면에</div>
        </div>
      </div>

      <div class="flex items-center gap-2 flex-wrap justify-end">
        <a href="https://www.korea.kr/" target="_blank" rel="noopener" class="btn2 text-sm">정책브리핑</a>
        <div class="flex items-center gap-2">
          <input type="date" id="datePicker" class="border border-slate-200 rounded-xl px-3 py-2 bg-white" />
          <button id="btnLoad" class="btn">조회</button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-[1440px] mx-auto px-2 py-6 space-y-6">
    <div class="card p-4">
      <div class="flex items-start justify-between gap-4 flex-wrap">
        <div>
          <div class="font-semibold text-slate-900">오늘의 브리핑</div>
          <div class="muted small">선택한 날짜 기준(±1일) 최신 기사 5건씩 노출</div>
        </div>
        <div class="chip">SOURCE: Google News RSS (via Cloudflare Worker)</div>
      </div>
      <div class="divider my-3"></div>
      <div id="news-container" class="space-y-5"></div>
      <div id="debugBox" class="mt-4 text-xs muted"></div>
    </div>
  </main>

<script>
/** ✅ Cloudflare Worker 주소(끝에 슬래시 없이) */
const PROXY_BASE = "https://eis.qkr3069.workers.dev";

/* ===================== FEEDS ===================== */
const feeds = {
  "건강검진": "https://news.google.com/rss/search?q=건강검진&hl=ko&gl=KR&ceid=KR:ko",
  "검진센터 소식": "https://news.google.com/rss/search?q=KMI+OR+한국의학연구소+OR+건강관리협회+OR+하나로의료재단+OR+메디플러스+OR+메디피아+OR+SCL+OR+세종365의원+OR+대청병원+OR+천안우리병원&hl=ko&gl=KR&ceid=KR:ko",
  "경쟁사 소식": "https://news.google.com/rss/search?q=GC케어+OR+어떠케어+OR+에임매드+OR+착한의사+OR+비바이노베이션+OR+케어링크+OR+케어랩스+OR+레몬헬스케어+OR+유비케어+OR+살루스케어+OR+카카오헬스케어&hl=ko&gl=KR&ceid=KR:ko",
  "헬스케어": "https://news.google.com/rss/search?q=헬스케어&hl=ko&gl=KR&ceid=KR:ko",
  "웰니스": "https://news.google.com/rss/search?q=웰니스&hl=ko&gl=KR&ceid=KR:ko",
  "웨어러블": "https://news.google.com/rss/search?q=갤럭시워치+OR+애플워치+OR+스마트워치+OR+핏빗+OR+워치&hl=ko&gl=KR&ceid=KR:ko",
  "주요 소식(국내)": "https://news.google.com/rss?hl=ko&gl=KR&ceid=KR:ko",
  "주요 소식(국외)": "https://news.google.com/rss?hl=en-US&gl=US&ceid=US:en"
};

function stripHtml(s){
  return (s || "").replace(/<[^>]+>/g, " ").replace(/\s+/g, " ").trim();
}
function debug(msg){
  const box = document.getElementById("debugBox");
  if(!box) return;
  box.innerHTML += `<div>• ${msg}</div>`;
}

/* ===================== DATE FILTER ===================== */
function parseYMD(v){
  const [a,b,c] = (v||"").split("-").map(Number);
  if(!a || !b || !c) return null;
  return new Date(a, b-1, c, 0,0,0,0);
}
function parseItemDate(dt){
  if(!dt) return null;
  const d = new Date(dt);
  if(!Number.isNaN(d.getTime())) return d;
  return null;
}
function passDateFilter(pubDate, sel){
  const selD = parseYMD(sel);
  if(!selD) return true;
  const itemD = parseItemDate(pubDate);
  if(!itemD) return true;
  const a = new Date(selD.getFullYear(), selD.getMonth(), selD.getDate()).getTime();
  const b = new Date(itemD.getFullYear(), itemD.getMonth(), itemD.getDate()).getTime();
  return Math.abs(a - b) <= 86400000;
}

/* ===================== RSS via Worker (XML) ===================== */
async function fetchRSSRaw(rssUrl){
  const proxy = `${PROXY_BASE}/rss?url=` + encodeURIComponent(rssUrl);
  const r = await fetch(proxy, { cache: "no-store" });
  if(!r.ok) throw new Error("proxy failed: " + r.status);
  return r.text();
}

function textOf(parent, selector){
  const el = parent.querySelector(selector);
  return el ? (el.textContent || "").trim() : "";
}

function firstLinkOfItem(itemEl){
  // RSS: <link>https://...</link> or Atom: <link href="..."/>
  const atomLink = itemEl.querySelector('link[href]');
  if(atomLink && atomLink.getAttribute("href")) return atomLink.getAttribute("href").trim();

  const rssLink = textOf(itemEl, "link");
  if(rssLink) return rssLink;

  const guid = textOf(itemEl, "guid");
  if(guid && /^https?:\/\//i.test(guid)) return guid;

  return "";
}

function parseRSSItems(xmlText){
  const parser = new DOMParser();
  const doc = parser.parseFromString(xmlText, "text/xml");

  // 파싱 에러 체크
  const errNode = doc.querySelector("parsererror");
  if(errNode) throw new Error("XML parse error");

  // RSS 2.0: <item>, Atom: <entry>
  const items = [];

  const rssItems = Array.from(doc.querySelectorAll("item"));
  if(rssItems.length){
    for(const it of rssItems){
      const title = textOf(it, "title");
      const link = firstLinkOfItem(it);
      const pubDate = textOf(it, "pubDate") || textOf(it, "date");
      const description = textOf(it, "description") || textOf(it, "content\\:encoded");
      if(title || link){
        items.push({ title, link, pubDate, description });
      }
    }
    return items;
  }

  const atomEntries = Array.from(doc.querySelectorAll("entry"));
  for(const en of atomEntries){
    const title = textOf(en, "title");
    let link = "";
    const l = en.querySelector('link[rel="alternate"][href]') || en.querySelector('link[href]');
    if(l) link = (l.getAttribute("href") || "").trim();
    const pubDate = textOf(en, "updated") || textOf(en, "published");
    const description = textOf(en, "summary") || textOf(en, "content");
    if(title || link){
      items.push({ title, link, pubDate, description });
    }
  }
  return items;
}

async function fetchRssItems(rssUrl){
  const xml = await fetchRSSRaw(rssUrl);
  const items = parseRSSItems(xml);
  return { items };
}

/* ===================== UI ===================== */
function makeSection(cat){
  const sec = document.createElement("section");
  sec.className = "card p-4";
  sec.innerHTML = `
    <div class="flex items-center justify-between gap-3 flex-wrap">
      <div class="flex items-center gap-2">
        <div class="font-semibold text-slate-900">${cat}</div>
        <span class="chip">TOP 5</span>
      </div>
      <span class="badge-load" data-badge>LOADING</span>
    </div>
    <div class="divider my-3"></div>
    <div class="space-y-3" data-items>
      <div class="p-3 rounded-2xl bg-slate-50 border border-slate-200 muted small">불러오는 중…</div>
    </div>
    <div class="mt-3 muted small" data-empty style="display:none;">해당 날짜 소식 없음</div>
    <div class="mt-2 muted small" data-error style="display:none;"></div>
  `;
  return sec;
}

function setBadge(sec, kind, text){
  const b = sec.querySelector("[data-badge]");
  b.className = kind === "ok" ? "badge-ok" : kind === "err" ? "badge-err" : "badge-load";
  b.textContent = text;
}

function renderOK(sec, items, selDate){
  const listWrap = sec.querySelector("[data-items]");
  const emptyEl = sec.querySelector("[data-empty]");
  const errEl = sec.querySelector("[data-error]");
  listWrap.innerHTML = "";
  emptyEl.style.display = "none";
  errEl.style.display = "none";

  let num = 0;
  for(const it of items){
    if(num >= 5) break;
    if(!passDateFilter(it.pubDate, selDate)) continue;

    const clean = stripHtml(it.description).slice(0, 90);
    const row = document.createElement("div");
    row.className = "p-3 rounded-2xl bg-slate-50 border border-slate-200";
    row.innerHTML = `
      <a class="news-link block" href="${it.link || "#"}" target="_blank" rel="noopener">${it.title || "(제목 없음)"}</a>
      <div class="muted small mt-1">${clean ? clean + "…" : ""}</div>
    `;
    listWrap.appendChild(row);
    num++;
  }

  if(num === 0) emptyEl.style.display = "";
  setBadge(sec, "ok", "OK");
}

function renderERR(sec, msg){
  const listWrap = sec.querySelector("[data-items]");
  const emptyEl = sec.querySelector("[data-empty]");
  const errEl = sec.querySelector("[data-error]");
  listWrap.innerHTML = "";
  emptyEl.style.display = "none";
  errEl.style.display = "";
  errEl.textContent = "불러오기에 실패했습니다: " + msg;
  setBadge(sec, "err", "ERROR");
}

/* ===================== 동시성 제한 ===================== */
async function runWithLimit(tasks, limit){
  const results = new Array(tasks.length);
  let i = 0;
  async function worker(){
    while(i < tasks.length){
      const cur = i++;
      try{ results[cur] = { ok:true, val: await tasks[cur]() }; }
      catch(e){ results[cur] = { ok:false, err:e }; }
    }
  }
  await Promise.all(Array.from({length: Math.min(limit, tasks.length)}, worker));
  return results;
}

/* ===================== LOAD ===================== */
let loadToken = 0;
async function loadAllNews(){
  const token = ++loadToken;
  document.getElementById("debugBox").innerHTML = "";

  const selDate = document.getElementById("datePicker").value;
  const c = document.getElementById("news-container");
  c.innerHTML = "";

  const entries = Object.entries(feeds);
  const secMap = new Map();

  for(const [cat] of entries){
    const sec = makeSection(cat);
    secMap.set(cat, sec);
    c.appendChild(sec);
  }

  const tasks = entries.map(([cat, url]) => async () => {
    const data = await fetchRssItems(url);
    return { cat, items: data.items };
  });

  // ✅ 너무 많이 동시에 때리면 구글이/프록시가 불안정할 수 있어서 2~3 권장
  const results = await runWithLimit(tasks, 2);
  if(token !== loadToken) return;

  results.forEach((r, idx) => {
    const cat = entries[idx][0];
    const sec = secMap.get(cat);

    if(r.ok){
      renderOK(sec, r.val.items, selDate);
      debug(`${cat}: OK items=${r.val.items.length}`);
    } else {
      renderERR(sec, r.err?.message || String(r.err));
      debug(`${cat}: FAIL ${r.err?.message || r.err}`);
    }
  });
}

window.onload = () => {
  document.getElementById("datePicker").value = new Date().toISOString().slice(0,10);
  document.getElementById("btnLoad").addEventListener("click", loadAllNews);
  loadAllNews();
};
</script>
</body>
</html>
