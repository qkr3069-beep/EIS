<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>옴니케어 뉴스 브리핑</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css" />
  <style>
    html,body{ font-family:"Pretendard Variable", Pretendard, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .card { border:1px solid #e5e7eb; border-radius:16px; background:#fff; box-shadow:0 8px 24px rgba(15,23,42,.06); }
    .chip { border:1px solid #e5e7eb; border-radius:999px; padding:.25rem .6rem; font-size:.8rem; color:#334155; background:#f8fafc; }
    .muted{ color:#64748b; }
    .btn { border:1px solid #e5e7eb; background:#0f172a; color:#fff; border-radius:12px; padding:.55rem .9rem; font-weight:700; }
    .btn2 { border:1px solid #e5e7eb; background:#fff; color:#0f172a; border-radius:12px; padding:.55rem .9rem; font-weight:700; }
    .divider{ height:1px; background:#e5e7eb; }
    .small { font-size:.85rem; }
    input[type="date"]{ color:#0f172a; }
    .news-link{ color:#0f172a; font-weight:800; }
    .news-link:hover{ text-decoration:underline; }
    .badge-ok{ border:1px solid #bbf7d0; background:#ecfdf5; color:#065f46; border-radius:999px; padding:.15rem .55rem; font-size:.75rem; font-weight:800; }
    .badge-err{ border:1px solid #fecaca; background:#fff1f2; color:#9f1239; border-radius:999px; padding:.15rem .55rem; font-size:.75rem; font-weight:800; }
    .badge-load{ border:1px solid #e5e7eb; background:#f8fafc; color:#334155; border-radius:999px; padding:.15rem .55rem; font-size:.75rem; font-weight:800; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 min-h-screen">

  <header class="sticky top-0 z-20 bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="max-w-[1440px] mx-auto px-2 py-3 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
      <div class="flex items-center gap-3">
        <a href="https://qkr3069-beep.github.io/EIS/" aria-label="메인으로 이동" class="shrink-0">
          <img src="omnicare_logo.png" alt="옴니케어 로고" class="h-12 md:h-14 object-contain cursor-pointer" />
        </a>

        <div>
          <div class="font-semibold text-slate-900">OmniCare News Briefing</div>
          <div class="text-sm muted">업계/경쟁/센터/헬스케어 소식을 한 화면에</div>
        </div>
      </div>

      <div class="flex items-center gap-2 flex-wrap justify-end">
        <a href="https://www.korea.kr/" target="_blank" rel="noopener" class="btn2 text-sm">정책브리핑</a>
        <div class="flex items-center gap-2">
          <input type="date" id="datePicker" class="border border-slate-200 rounded-xl px-3 py-2 bg-white" />
          <button id="btnLoad" class="btn">조회</button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-[1440px] mx-auto px-2 py-6 space-y-6">
    <div class="card p-4">
      <div class="flex items-start justify-between gap-4 flex-wrap">
        <div>
          <div class="font-semibold text-slate-900">오늘의 브리핑</div>
          <div class="muted small">선택한 날짜 기준(±1일) 최신 기사 5건씩 노출</div>
        </div>
        <div class="chip">SOURCE: Google News RSS</div>
      </div>
      <div class="divider my-3"></div>
      <div id="news-container" class="space-y-5"></div>

      <!-- ✅ 디버그(필요하면 숨겨도 됨) -->
      <div id="debugBox" class="mt-4 text-xs muted"></div>
    </div>

    <footer class="text-center muted small py-6">
      샘플 화면입니다. 실제 서비스에서는 사내 크롤러/권한/저장소를 연동하는 것을 권장합니다.
    </footer>
  </main>

<script>
/* ===================== FEEDS ===================== */
const feeds = {
  "건강검진": "https://news.google.com/rss/search?q=건강검진&hl=ko&gl=KR&ceid=KR:ko",
  "검진센터 소식": "https://news.google.com/rss/search?q=KMI+OR+한국의학연구소+OR+건강관리협회+OR+하나로의료재단+OR+메디플러스+OR+메디피아+OR+SCL+OR+세종365의원+OR+대청병원+OR+천안우리병원&hl=ko&gl=KR&ceid=KR:ko",
  "경쟁사 소식": "https://news.google.com/rss/search?q=GC케어+OR+어떠케어+OR+에임매드+OR+착한의사+OR+비바이노베이션+OR+케어링크+OR+케어랩스+OR+레몬헬스케어+OR+유비케어+OR+살루스케어+OR+카카오헬스케어&hl=ko&gl=KR&ceid=KR:ko",
  "헬스케어": "https://news.google.com/rss/search?q=헬스케어&hl=ko&gl=KR&ceid=KR:ko",
  "웰니스": "https://news.google.com/rss/search?q=웰니스&hl=ko&gl=KR&ceid=KR:ko",
  "웨어러블": "https://news.google.com/rss/search?q=갤럭시워치+OR+애플워치+OR+스마트워치+OR+핏빗+OR+워치&hl=ko&gl=KR&ceid=KR:ko",
  "주요 소식(국내)": "https://news.google.com/rss?hl=ko&gl=KR&ceid=KR:ko",
  "주요 소식(국외)": "https://news.google.com/rss?hl=en-US&gl=US&ceid=US:en"
};

const CATEGORY_KEYWORDS = {
  "건강검진": ["건강검진","종합검진","대장내시경","암검진"],
  "검진센터 소식": ["KMI","한국의학연구소","건강관리협회","하나로의료재단","메디플러스","메디피아","SCL","세종365의원","대청병원","천안우리병원"],
  "경쟁사 소식": ["GC케어","어떠케어","에임매드","착한의사","비바이노베이션","케어링크","케어랩스","레몬헬스케어","유비케어","살루스케어","카카오헬스케어"],
  "헬스케어": ["헬스케어","디지털헬스","원격의료"],
  "웰니스": ["웰니스","비만","영양관리","운동습관"],
  "웨어러블": ["갤럭시워치","애플워치","스마트워치","핏빗","웨어러블기기"]
};

const TOP_PAGE = {
  "주요 소식(국내)": "https://news.google.com/topstories?hl=ko&gl=KR&ceid=KR:ko",
  "주요 소식(국외)": "https://news.google.com/topstories?hl=en-US&gl=US&ceid=US:en"
};

function buildMoreLink(cat){
  if (TOP_PAGE[cat]) return TOP_PAGE[cat];
  const terms = CATEGORY_KEYWORDS[cat];
  if (!terms) return "#";
  const q = terms.map(t=>`%22${encodeURIComponent(t)}%22`).join("%20OR%20");
  return `https://news.google.com/search?q=${q}&hl=ko&gl=KR&ceid=KR%3Ako`;
}

/* ===================== DATE FILTER (안전형) ===================== */
function parseYMD(v){
  const [a,b,c] = (v||"").split("-").map(Number);
  if(!a || !b || !c) return null;
  return new Date(a, b-1, c, 0,0,0,0);
}
function parseItemDate(dt){
  if(!dt) return null;
  const d = new Date(dt);
  if(!Number.isNaN(d.getTime())) return d;
  const fixed = String(dt).replace(" ", "T");
  const d2 = new Date(fixed);
  if(!Number.isNaN(d2.getTime())) return d2;
  return null;
}
function passDateFilter(pubDate, sel){
  const selD = parseYMD(sel);
  if(!selD) return true;
  const itemD = parseItemDate(pubDate);
  if(!itemD) return true; // 파싱 실패시 노출(안 뜨는 문제 방지)
  const a = new Date(selD.getFullYear(), selD.getMonth(), selD.getDate()).getTime();
  const b = new Date(itemD.getFullYear(), itemD.getMonth(), itemD.getDate()).getTime();
  return Math.abs(a - b) <= 86400000;
}

/* ===================== FETCH HELPERS ===================== */
function stripHtml(s){
  return (s || "").replace(/<[^>]+>/g, " ").replace(/\s+/g, " ").trim();
}
function debug(msg){
  const box = document.getElementById("debugBox");
  if(!box) return;
  box.innerHTML = (box.innerHTML + `<div>• ${msg}</div>`).slice(-4000);
}

/* ===== 1) rss2json (메인 방식) ===== */
async function fetchViaRss2Json(rssUrl){
  const cacheKey = "rsscache2json:" + rssUrl;
  const ttlMs = 10 * 60 * 1000;

  try{
    const cached = JSON.parse(localStorage.getItem(cacheKey) || "null");
    if(cached && cached.t && (Date.now()-cached.t) < ttlMs && Array.isArray(cached.items)){
      return { ok:true, source:"rss2json-cache", items: cached.items };
    }
  }catch(e){}

  const endpoint = "https://api.rss2json.com/v1/api.json?rss_url=" + encodeURIComponent(rssUrl);
  const res = await fetch(endpoint, { cache:"no-store" });
  const j = await res.json();

  if(!res.ok){
    throw new Error(`rss2json HTTP ${res.status}`);
  }
  if(j.status && j.status !== "ok"){
    // rss2json 자체 에러(쿼터/차단 등)
    throw new Error(`rss2json status=${j.status} message=${j.message || "-"}`);
  }

  const items = (j.items || []).map(it => ({
    title: it.title || "",
    link: it.link || "",
    pubDate: it.pubDate || "",
    description: it.description || ""
  }));

  try{
    localStorage.setItem(cacheKey, JSON.stringify({ t: Date.now(), items }));
  }catch(e){}

  return { ok:true, source:"rss2json", items };
}

/* ===== 2) allorigins 폴백: RSS 원문 XML 파싱 ===== */
async function fetchViaAllOrigins(rssUrl){
  const cacheKey = "rsscachexml:" + rssUrl;
  const ttlMs = 10 * 60 * 1000;

  try{
    const cached = JSON.parse(localStorage.getItem(cacheKey) || "null");
    if(cached && cached.t && (Date.now()-cached.t) < ttlMs && typeof cached.text === "string"){
      return { ok:true, source:"allorigins-cache", items: parseRssXmlToItems(cached.text) };
    }
  }catch(e){}

  // raw가 막히는 경우가 있어서 get(JSON) 사용
  const proxy = "https://api.allorigins.win/get?url=" + encodeURIComponent(rssUrl);
  const res = await fetch(proxy, { cache:"no-store" });
  if(!res.ok) throw new Error(`allorigins HTTP ${res.status}`);
  const j = await res.json();
  const text = j && j.contents;
  if(!text) throw new Error("allorigins empty contents");

  try{
    localStorage.setItem(cacheKey, JSON.stringify({ t: Date.now(), text }));
  }catch(e){}

  return { ok:true, source:"allorigins", items: parseRssXmlToItems(text) };
}

function parseRssXmlToItems(text){
  const xml = new DOMParser().parseFromString(text, "text/xml");
  const items = Array.from(xml.querySelectorAll("item")).map(it => ({
    title: it.querySelector("title")?.textContent || "",
    link: it.querySelector("link")?.textContent || "",
    pubDate: it.querySelector("pubDate")?.textContent || "",
    description: it.querySelector("description")?.textContent || ""
  }));
  return items;
}

/* ===== 최종: rss2json → 실패시 allorigins ===== */
async function fetchFeedSmart(rssUrl){
  try{
    const a = await fetchViaRss2Json(rssUrl);
    return a;
  }catch(e1){
    debug(`rss2json fail: ${String(e1.message || e1)} → fallback`);
    const b = await fetchViaAllOrigins(rssUrl);
    return b;
  }
}

/* ===================== UI (섹션 렌더) ===================== */
function makeSection(cat){
  const sec = document.createElement("section");
  sec.className = "card p-4";
  sec.dataset.cat = cat;
  sec.innerHTML = `
    <div class="flex items-center justify-between gap-3 flex-wrap">
      <div class="flex items-center gap-2">
        <div class="font-semibold text-slate-900">${cat}</div>
        <span class="chip">TOP 5</span>
      </div>
      <span class="badge-load" data-badge>LOADING</span>
    </div>
    <div class="divider my-3"></div>

    <div class="space-y-3" data-items>
      <div class="p-3 rounded-2xl bg-slate-50 border border-slate-200 muted small">불러오는 중…</div>
    </div>

    <div class="mt-3 muted small" data-empty style="display:none;">해당 날짜 소식 없음</div>
    <div class="mt-2 muted small" data-error style="display:none;"></div>
  `;
  return sec;
}

function setBadge(sec, type, text){
  const b = sec.querySelector("[data-badge]");
  if(!b) return;
  b.className = type === "ok" ? "badge-ok" : type === "err" ? "badge-err" : "badge-load";
  b.textContent = text;
}

function ensureMoreBtn(sec, cat){
  const head = sec.querySelector(".flex.items-center.justify-between");
  if(!head) return;
  head.querySelectorAll("a[data-more]").forEach(a=>a.remove());
  const more = document.createElement("a");
  more.href = buildMoreLink(cat);
  more.target = "_blank";
  more.rel = "noopener";
  more.className = "btn2 text-sm";
  more.textContent = "더보기";
  more.setAttribute("data-more","1");
  head.appendChild(more);
}

function renderItems(sec, cat, items, selDate, sourceLabel){
  const listWrap = sec.querySelector("[data-items]");
  const emptyEl = sec.querySelector("[data-empty]");
  const errEl = sec.querySelector("[data-error]");
  listWrap.innerHTML = "";
  emptyEl.style.display = "none";
  errEl.style.display = "none";
  errEl.textContent = "";

  let num = 0;
  for(const it of (items || [])){
    if(num >= 5) break;
    if(!passDateFilter(it.pubDate, selDate)) continue;

    const clean = stripHtml(it.description).slice(0, 90);
    const row = document.createElement("div");
    row.className = "p-3 rounded-2xl bg-slate-50 border border-slate-200";
    row.innerHTML = `
      <a class="news-link block" href="${it.link}" target="_blank" rel="noopener">${it.title}</a>
      <div class="muted small mt-1">${clean ? clean + "…" : ""}</div>
    `;
    listWrap.appendChild(row);
    num++;
  }

  ensureMoreBtn(sec, cat);

  if(num === 0){
    emptyEl.style.display = "";
  }

  setBadge(sec, "ok", sourceLabel || "OK");
}

function renderError(sec, cat, message){
  const listWrap = sec.querySelector("[data-items]");
  const emptyEl = sec.querySelector("[data-empty]");
  const errEl = sec.querySelector("[data-error]");

  listWrap.innerHTML = "";
  emptyEl.style.display = "none";

  errEl.style.display = "";
  errEl.textContent = `불러오기에 실패했습니다: ${message}`;

  ensureMoreBtn(sec, cat);
  setBadge(sec, "err", "ERROR");
}

/* ===================== CONCURRENCY LIMIT (2개씩) ===================== */
async function runWithLimit(tasks, limit){
  const results = new Array(tasks.length);
  let i = 0;

  async function worker(){
    while(i < tasks.length){
      const cur = i++;
      try{
        results[cur] = { status:"fulfilled", value: await tasks[cur]() };
      }catch(e){
        results[cur] = { status:"rejected", reason: e };
      }
    }
  }

  const workers = Array.from({length: Math.min(limit, tasks.length)}, () => worker());
  await Promise.all(workers);
  return results;
}

/* ===================== LOAD ===================== */
let loadToken = 0;

async function loadAllNews(){
  const token = ++loadToken;
  document.getElementById("debugBox").innerHTML = "";

  const selDate = document.getElementById("datePicker").value;
  const c = document.getElementById("news-container");
  c.innerHTML = "";

  const entries = Object.entries(feeds);
  const secMap = new Map();

  // 섹션 먼저 깔기
  for(const [cat] of entries){
    const sec = makeSection(cat);
    secMap.set(cat, sec);
    c.appendChild(sec);
  }

  // 태스크 준비(각 카테고리 fetch)
  const tasks = entries.map(([cat, url]) => async () => {
    const r = await fetchFeedSmart(url);
    return { cat, url, ...r };
  });

  // ✅ 동시 2개 제한(깃헙에서 쿼터/차단 회피)
  const results = await runWithLimit(tasks, 2);

  if(token !== loadToken) return;

  results.forEach((res, idx) => {
    const cat = entries[idx][0];
    const sec = secMap.get(cat);

    if(res.status === "fulfilled"){
      const v = res.value;
      renderItems(sec, cat, v.items, selDate, v.source.toUpperCase());
      debug(`${cat}: OK (${v.source}) items=${(v.items||[]).length}`);
    }else{
      const msg = String(res.reason?.message || res.reason || "unknown");
      renderError(sec, cat, msg);
      debug(`${cat}: FAIL (${msg})`);
      console.warn("[NEWS] fail:", cat, res.reason);
    }
  });
}

/* ===================== INIT ===================== */
window.onload = () => {
  document.getElementById("datePicker").value = new Date().toISOString().slice(0,10);
  document.getElementById("btnLoad").addEventListener("click", loadAllNews);
  loadAllNews();
};
</script>
</body>
</html>
