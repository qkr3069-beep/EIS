<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>OmniCare EIS · Main</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css" />

<style>
html,body{ font-family:"Pretendard Variable", system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
.card{
  border:1px solid #e5e7eb; border-radius:16px; background:#fff;
  box-shadow:0 8px 24px rgba(15,23,42,.06);
}
.muted{ color:#64748b; }
.divider{ height:1px; background:#e5e7eb; }
.chip{ border:1px solid #e5e7eb; border-radius:999px; padding:.25rem .6rem; font-size:.8rem; color:#334155; background:#f8fafc; }
.btn2{ border:1px solid #e5e7eb; background:#fff; color:#0f172a; border-radius:12px; padding:.55rem .9rem; font-weight:700; }
.small{ font-size:.85rem; }

/* ===== Overlay Bar Chart (기본: 스크롤형) ===== */
.chart-wrap{
  display:grid;
  grid-auto-flow: column;
  grid-auto-columns: 64px;
  gap:12px;
  align-items:end;
  overflow-x:auto;
  padding-bottom:6px;
}
.chart-wrap::-webkit-scrollbar{ height:6px; }
.chart-wrap::-webkit-scrollbar-thumb{ background:#cbd5f5; border-radius:999px; }
.chart-wrap::-webkit-scrollbar-track{ background:#f1f5f9; }

.bar-col{ display:flex; flex-direction:column; align-items:center; gap:6px; min-width:0; }
.bar-area{ position:relative; width:100%; height:250px; display:flex; align-items:flex-end; }

.bar-goal{
  width:100%;
  background:#e5e7eb;
  border-radius:8px;
  position:absolute;
  bottom:0;
}
.bar-actual{
  width:56%;
  position:absolute;
  bottom:0;
  left:50%;
  transform:translateX(-50%);
  border-radius:6px;
}

.kmi-actual{ background:#0f172a; }
.omni-goal{ background:#bfdbfe; }
.omni-actual{ background:#1e3a8a; }

.top-num{ font-size:.75rem; color:#374151; font-weight:800; }
.bottom-num{ font-size:.75rem; color:#0f172a; font-weight:900; }
.bar-label{
  font-size:.8rem; font-weight:800; color:#0f172a; text-align:center;
  max-width:100%;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

/* ✅ Omni 오른쪽(본부/지사) "균등" 전용 */
.chart-equal{
  display:grid;
  gap:12px;
  align-items:end;
  overflow:hidden;       /* 스크롤 제거 */
  padding-bottom:6px;
}
.chart-equal .bar-col{ width:100%; }
.chart-equal .bar-area{ height:250px; }
.chart-equal .top-num,
.chart-equal .bottom-num{ font-size:.70rem; }
.chart-equal .bar-label{ font-size:.78rem; }

/* ===== Omni stacked bar ===== */
.stack{
  width:100%;
  border:1px solid #e5e7eb;
  border-radius:14px;
  overflow:hidden;
  background:#f8fafc;
  height:14px;
}
.seg{ height:100%; display:inline-block; }
.seg-third{ background:#93c5fd; }  /* 3자 */
.seg-with{  background:#fca5a5; }  /* WITH KMI */
.seg-etc{
  background:#22c55e !important; /* 진한 초록 */
  box-shadow: inset 0 0 0 1px rgba(15,23,42,.18);
}

.legend{
  display:flex; flex-wrap:wrap; gap:10px; margin-top:8px;
  font-size:.82rem; color:#334155; font-weight:800;
}
.dot{ width:10px; height:10px; border-radius:3px; display:inline-block; margin-right:6px; vertical-align:middle; }
.dot-third{ background:#93c5fd; }
.dot-with{ background:#fca5a5; }
.dot-etc{ background:#22c55e; }

.metaLine{ font-size:.82rem; color:#64748b; margin-top:6px; }
.moneyStrong{ font-weight:900; color:#0f172a; }

/* ✅ Omni KPI 2분할(가득) */
.omniKpiRow{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:12px;
  margin-top:12px;
}
.omniKpi{
  border:1px solid #e5e7eb;
  border-radius:16px;
  background:#fff;
  padding:16px 18px;
  min-height:92px;
  display:flex;
  flex-direction:column;
  justify-content:center;
}
.omniKpi .t{
  font-size:.86rem;
  color:#64748b;
  font-weight:800;
}
.omniKpi .v{
  margin-top:6px;
  font-size:2.1rem;
  line-height:1.1;
  font-weight:900;
  letter-spacing:-0.02em;
  color:#0f172a;
  word-break:keep-all;
}
@media (min-width: 1024px){
  .omniKpi .v{ font-size:2.6rem; }
}
.omniKpi .s{
  margin-top:6px;
  font-size:.82rem;
  color:#64748b;
  font-weight:700;
}

/* ===== KPI (KMI) ===== */
.kpiRow{ display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; }
.kpi{
  border:1px solid #e5e7eb; border-radius:14px; background:#fff;
  padding:10px 12px;
}
.kpi .t{ font-size:.78rem; color:#64748b; font-weight:700; }
.kpi .v{ font-size:1.05rem; font-weight:900; color:#0f172a; margin-top:2px; }
.kpi .s{ font-size:.78rem; color:#64748b; margin-top:2px; }

/* ===== 뉴스 ===== */
.newsItem{
  padding:10px 12px;
  border:1px solid #e5e7eb;
  border-radius:14px;
  background:#f8fafc;
}
.newsTitle{ font-weight:800; color:#0f172a; }
.newsMeta{ color:#64748b; font-size:.8rem; margin-top:2px; }
.newsLink{ color:#0f172a; text-decoration:none; }
.newsLink:hover{ text-decoration:underline; }

/* ===== 국보급 이야기 ===== */
.kbBox{
  background:linear-gradient(180deg,#ffffff, #f8fafc);
  border:1px solid #e5e7eb;
  border-radius:16px;
  padding:16px;
}
.quote{
  font-size:1.05rem;
  font-weight:900;
  color:#0f172a;
  line-height:1.4;
}
</style>
</head>

<body class="bg-slate-50">

<header class="sticky top-0 z-20 bg-white/90 backdrop-blur border-b border-slate-200">
  <div class="max-w-[1440px] mx-auto px-2 py-3 flex items-center gap-3">
    <a href="https://qkr3069-beep.github.io/EIS/" aria-label="메인으로 이동">
      <img src="omnicare_logo.png" alt="옴니케어 로고" class="h-12 object-contain cursor-pointer" />
    </a>
    <div class="flex-1">
      <div class="font-semibold text-slate-900">OmniCare Intelligence Hub</div>
      <div class="text-sm muted">매출 현황 · 대표 메시지 · 업계 소식</div>
    </div>

    <!-- ✅ 요청 반영: CEO 페이지 버튼 추가 -->
    <button onclick="location.href='ceo.html'" class="btn2">CEO 페이지</button>
    <button onclick="location.href='admin_manager.html'" class="btn2">관리자 페이지</button>
    <button onclick="location.href='mypage_sales.html'" class="btn2">마이페이지</button>
  </div>
</header>

<main class="max-w-[1440px] mx-auto px-2 py-6 space-y-6">

  <!-- 1행: 옴니케어 누계 매출 (2분할) -->
  <section class="card p-5">
    <div class="flex items-start justify-between gap-3">
      <div>
        <div class="font-extrabold text-slate-900 text-lg">옴니케어 누계 매출</div>
        <div class="muted small">좌: 총괄(합계+구성) / 우: 본부·지사별</div>
      </div>

      <a href="overview_sales.html"
         class="text-sm font-semibold text-slate-700 hover:text-slate-900 transition flex items-center gap-1 whitespace-nowrap">
        더보기
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </a>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-4">
      <!-- 좌: 총괄 + 구성 -->
      <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
        <div class="font-extrabold text-slate-900 mb-2">총괄(예상 vs 현재) · 구성</div>

        <div class="omniKpiRow">
          <div class="omniKpi">
            <div class="t">2025년 예상 매출 합계</div>
            <div class="v" id="omniExpectedTotal">-</div>
            <div class="s">3자 + WITH KMI + 그 외</div>
          </div>
          <div class="omniKpi">
            <div class="t">현재 누계 매출 합계</div>
            <div class="v" id="omniCurrentTotal">-</div>
            <div class="s">3자 + WITH KMI + 그 외</div>
          </div>
        </div>

        <!-- 예상 구성 -->
        <div class="mt-4">
          <div class="metaLine"><b class="moneyStrong">예상</b> 구성 (3자 / WITH KMI / 그 외)</div>
          <div class="stack mt-2" aria-label="예상 매출 구성">
            <span class="seg seg-third" id="expThird" style="width:0%"></span>
            <span class="seg seg-with"  id="expWith"  style="width:0%"></span>
            <span class="seg seg-etc"   id="expEtc"   style="width:0%"></span>
          </div>
          <div class="legend">
            <span><i class="dot dot-third"></i>3자: <span id="expThirdTxt">-</span></span>
            <span><i class="dot dot-with"></i>WITH KMI: <span id="expWithTxt">-</span></span>
            <span><i class="dot dot-etc"></i>그 외: <span id="expEtcTxt">-</span></span>
          </div>
        </div>

        <!-- 현재 구성 -->
        <div class="mt-4">
          <div class="metaLine"><b class="moneyStrong">현재</b> 구성 (3자 / WITH KMI / 그 외)</div>
          <div class="stack mt-2" aria-label="현재 매출 구성">
            <span class="seg seg-third" id="curThird" style="width:0%"></span>
            <span class="seg seg-with"  id="curWith"  style="width:0%"></span>
            <span class="seg seg-etc"   id="curEtc"   style="width:0%"></span>
          </div>
          <div class="legend">
            <span><i class="dot dot-third"></i>3자: <span id="curThirdTxt">-</span></span>
            <span><i class="dot dot-with"></i>WITH KMI: <span id="curWithTxt">-</span></span>
            <span><i class="dot dot-etc"></i>그 외: <span id="curEtcTxt">-</span></span>
          </div>
        </div>
      </div>

      <!-- 우: 본부/지사별 (균등 7개) -->
      <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
        <div class="font-extrabold text-slate-900 mb-2">본부/지사별 매출(총합)</div>
        <div class="chart-equal" id="omniChartByOrg"></div>
      </div>
    </div>
  </section>

  <!-- 2행: KMI 검진 누계 매출 -->
  <section class="card p-5">
    <div class="flex items-start justify-between gap-3">
      <div>
        <div class="font-extrabold text-slate-900 text-lg">KMI 검진 누계 매출</div>
        <div class="muted small">목표(회색) 대비 누계(검은색) · 전체 지점 한 차트</div>
      </div>

      <a href="overview_center.html"
         class="text-sm font-semibold text-slate-700 hover:text-slate-900 transition flex items-center gap-1 whitespace-nowrap">
        더보기
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </a>
    </div>

    <div class="kpiRow">
      <div class="kpi">
        <div class="t">누계매출 합계</div>
        <div class="v" id="kmiSumSales">-</div>
        <div class="s">전년대비/증감률 표시는 생략</div>
      </div>
      <div class="kpi">
        <div class="t">누적 예약 건수</div>
        <div class="v" id="kmiTotalReserv">-</div>
        <div class="s">KMI: <span id="kmiReserv">-</span> · 타센터: <span id="otherReserv">-</span></div>
      </div>
    </div>

    <div class="chart-equal mt-4" id="kmiChart"></div>
  </section>

  <!-- 국보급 이야기 -->
  <section class="card p-6">
    <div class="flex items-start justify-between gap-3">
      <div>
        <div class="font-extrabold text-slate-900 text-lg">국보급 이야기</div>
        <div class="muted small">대표님 한 말씀 (Google Sheet 자동 반영)</div>
      </div>
      <span class="chip">MESSAGE</span>
    </div>

    <div class="divider my-4"></div>

    <div class="kbBox">
      <div class="quote" id="ceoQuote">“불러오는 중…”</div>
      <div class="mt-3 text-slate-900 leading-relaxed" id="ceoBody"></div>
      <div class="mt-4 muted small font-semibold" id="ceoSign">—</div>
      <div class="mt-2 muted text-xs" id="ceoUpdatedAt" style="display:none;"></div>
    </div>
  </section>

  <!-- Industry News -->
  <section class="card p-4">
    <div class="mb-3 flex items-start justify-between gap-4">
      <div>
        <div class="font-semibold text-slate-900">오늘의 브리핑</div>
        <div class="muted small">주요 카테고리별 핵심 이슈 (각 3건 · 자동 불러오기)</div>
      </div>

      <a href="news.html"
         class="text-sm font-semibold text-slate-700 hover:text-slate-900 transition flex items-center gap-1">
        더보기
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4"
             fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 5l7 7-7 7" />
        </svg>
      </a>
    </div>

    <div class="divider mb-4"></div>

    <div class="mb-4 p-5 rounded-2xl border border-slate-200 bg-white">
      <div class="flex items-center justify-between mb-3">
        <div class="font-extrabold text-slate-900">
          국보급 소식 <span class="muted text-sm font-semibold">· 대표님 추천</span>
        </div>
        <span class="chip">EDITOR’S PICK</span>
      </div>
      <div id="executiveNews" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
      <div class="mt-2 muted text-xs" id="executiveNewsMeta"></div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="p-4 rounded-2xl border border-slate-200 bg-slate-50">
        <div class="flex items-center justify-between mb-2">
          <div class="font-semibold">건강검진</div>
          <span class="chip">TREND</span>
        </div>
        <ul id="industry-healthcheck" class="space-y-2 text-sm"></ul>
      </div>

      <div class="p-4 rounded-2xl border border-slate-200 bg-slate-50">
        <div class="flex items-center justify-between mb-2">
          <div class="font-semibold">검진센터</div>
          <span class="chip">CENTER</span>
        </div>
        <ul id="industry-center" class="space-y-2 text-sm"></ul>
      </div>

      <div class="p-4 rounded-2xl border border-slate-200 bg-slate-50">
        <div class="flex items-center justify-between mb-2">
          <div class="font-semibold">경쟁사</div>
          <span class="chip">COMPETITOR</span>
        </div>
        <ul id="industry-competitor" class="space-y-2 text-sm"></ul>
      </div>

      <div class="p-4 rounded-2xl border border-slate-200 bg-slate-50">
        <div class="flex items-center justify-between mb-2">
          <div class="font-semibold">헬스케어</div>
          <span class="chip">HEALTHCARE</span>
        </div>
        <ul id="industry-healthcare" class="space-y-2 text-sm"></ul>
      </div>
    </div>
  </section>

  <footer class="text-center muted small py-6">
    샘플 화면입니다. 실제 서비스에서는 DB/권한/감사로그/매출 집계/뉴스 수집이 추가됩니다.
  </footer>
</main>

<script>
/* ================== (A) 국보급 이야기: Google Sheet 연동 ================== */
const CEO_SHEET_API = "https://script.google.com/macros/s/AKfycbxr21XZFn6w2peGaslTCT7UBR2hZpvXOEGV7YhbTr0DH1rKWpldXK1Fc5VV79FsCfs/exec";

/* ================== (A-2) 국보급 소식(대표님 추천): news_ceo 시트 연동 ================== */
const EXEC_NEWS_API = "https://script.google.com/macros/s/AKfycbwgDbjAC90L_0M_muN31QM1n-UbBCG5wXnvM7t0EQh3aGwCEbQd_5W05gSl7OuQ9Ds/exec";

const CEO_FALLBACK = {
  quote: "“숫자는 과거를 말하고, 실행은 내일을 만든다.”",
  body: [
    "오늘은 누계보다 속도를 봅시다.",
    "우리가 이기는 포인트는 ‘단가’가 아니라 ‘운영 편의성’과 ‘전환 정밀도’입니다.",
    "각 조직은 상위 3개 레버(리드→미팅→계약, 정산, 재구매)를 ‘매주 하나’만 개선해도 누계는 자연히 따라옵니다."
  ],
  sign: "— 대표"
};

/* ✅ 저장된 시간 그대로(yyyy-MM-dd HH:mm) 표시 */
function formatUpdatedAtKST(updatedAt){
  if(!updatedAt) return "";
  const d = new Date(updatedAt);
  if (Number.isNaN(d.getTime())) return "";
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  const hh = String(d.getHours()).padStart(2,"0");
  const mm = String(d.getMinutes()).padStart(2,"0");
  return `${y}-${m}-${dd} ${hh}:${mm}`;
}

function renderCEOFromData(data){
  const quoteEl = document.getElementById("ceoQuote");
  const bodyEl  = document.getElementById("ceoBody");
  const signEl  = document.getElementById("ceoSign");
  const updEl   = document.getElementById("ceoUpdatedAt");

  const quote = (data && String(data.quote||"").trim()) || CEO_FALLBACK.quote;
  const sign  = (data && String(data.sign||"").trim())  || CEO_FALLBACK.sign;

  let bodyLines = [];
  if (data && Array.isArray(data.body)) {
    bodyLines = data.body.map(s=>String(s||"").trim()).filter(Boolean);
  } else {
    const raw = data ? String(data.body||"").trim() : "";
    bodyLines = raw ? raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean) : CEO_FALLBACK.body;
  }

  quoteEl.textContent = quote;
  bodyEl.innerHTML = bodyLines.map(p=>`<p class="mt-2">${escapeHtml(p)}</p>`).join("");
  signEl.textContent = sign;

  const updatedAtRaw = data && data.updatedAt ? String(data.updatedAt).trim() : "";
  const display = formatUpdatedAtKST(updatedAtRaw);

  if (display) {
    updEl.style.display = "block";
    updEl.textContent = "업데이트: " + display;
  } else {
    updEl.style.display = "none";
  }
}

async function loadCEOFromGoogleSheet(){
  try{
    const url = CEO_SHEET_API + (CEO_SHEET_API.includes("?") ? "&" : "?") + "t=" + Date.now();
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();
    if (data && data.error) throw new Error(data.error);
    renderCEOFromData(data);
  }catch(err){
    console.warn("[CEO] sheet fetch failed:", err);
    renderCEOFromData(null);
  }
}

/* ================== (B) 샘플(JSON) ================== */
const SECTION1_SAMPLE = {
  "section1": {
    "kmiSalesSummary": {
      "currentCumulativeSales": "387,686,968,305",
      "changeFromPrevYear": "41265263983",
      "yearOverYearChangeRate": "11.9%",
      "kmiReservCount": 1242374,
      "otherCenterReservCount": 52916,
      "totalReservCount": 1295290,
      "prevTotalReservCount": 1222398
    },
    "kmiSalesByRegionList": [
      {"name":"광화문","summarySalesPrice":53285695937,"prevYearPrice":10907400560,"goalsSalesPrice":53000000000,"totalSalesPrice":106285695937},
      {"name":"여의도","summarySalesPrice":61008849652,"prevYearPrice":4113408576,"goalsSalesPrice":63900000000,"totalSalesPrice":124908849652},
      {"name":"강남","summarySalesPrice":66246179006,"prevYearPrice":6898741116,"goalsSalesPrice":68700000000,"totalSalesPrice":134946179006},
      {"name":"수원","summarySalesPrice":64863541879,"prevYearPrice":6499281983,"goalsSalesPrice":66300000000,"totalSalesPrice":131163541879},
      {"name":"대구","summarySalesPrice":44617977823,"prevYearPrice":4139694489,"goalsSalesPrice":46650000000,"totalSalesPrice":91267977823},
      {"name":"부산","summarySalesPrice":44705140202,"prevYearPrice":2665810503,"goalsSalesPrice":47600000000,"totalSalesPrice":92305140202},
      {"name":"광주","summarySalesPrice":40530362396,"prevYearPrice":3495797702,"goalsSalesPrice":41750000000,"totalSalesPrice":82280362396},
      {"name":"제주","summarySalesPrice":9115232746,"prevYearPrice":2209188680,"goalsSalesPrice":9600000000,"totalSalesPrice":18715232746},
      {"name":"수도권출장","summarySalesPrice":3313988664,"prevYearPrice":335940374,"goalsSalesPrice":2500000000,"totalSalesPrice":5813988664}
    ],
    "omniSalesSummary": {
      "expectedTotalSalesPrice": null,
      "expectedOtherServiceUsingSalesPrice": 5228986318,
      "expectedWithkmiServiceUsingSalesPrice": 1771490000,
      "expectedEtcSalesPrice": 590500000,
      "otherServiceUsingSalesPrice": 4894059272,
      "withkmiServiceUsingSalesPrice": 1719822727,
      "etcSalesPrice": 304500000,
      "totalSalesPrice": null
    },
    "omniSalesByRegionList": [
      {"name":"1본부","otherSalesPrice":1676746818,"withkmiSalesPrice":394306363,"etcSalesPrice":0},
      {"name":"2본부","otherSalesPrice":1896188000,"withkmiSalesPrice":522207272,"etcSalesPrice":0},
      {"name":"수원지사","otherSalesPrice":459350909,"withkmiSalesPrice":27586363,"etcSalesPrice":0},
      {"name":"대구지사","otherSalesPrice":119692727,"withkmiSalesPrice":321623181,"etcSalesPrice":28500000},
      {"name":"부산지사","otherSalesPrice":533028636,"withkmiSalesPrice":287047272,"etcSalesPrice":5636363},
      {"name":"광주지사","otherSalesPrice":205712181,"withkmiSalesPrice":166275000,"etcSalesPrice":36363636},
      {"name":"제휴사업","otherSalesPrice":1554545,"withkmiSalesPrice":572727,"etcSalesPrice":124500000}
    ]
  }
};

/* ================== 유틸 ================== */
function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function toThousandWon(v){ return Math.round((Number(v)||0) / 1000); }  // 원 → 천원

/* ================== overlay bar chart ================== */
function renderOverlayBarChart_EqualCols(data, wrapId, mode, opts){
  const wrap = document.getElementById(wrapId);
  if (!wrap) return;

  const options = Object.assign({ hideGoal: false }, (opts||{}));

  wrap.classList.add("chart-equal");
  wrap.style.gridTemplateColumns = `repeat(${data.length}, minmax(0, 1fr))`;

  wrap.innerHTML = "";
  const maxGoal = Math.max(...data.map(d=>d.goal||0), 1);

  data.forEach(d=>{
    const goalH = (d.goal/maxGoal)*100;
    const actualH = (d.actual/maxGoal)*100;

    const col = document.createElement("div");
    col.className = "bar-col";

    const goalClass = (mode==="omni") ? "bar-goal omni-goal" : "bar-goal";
    const actualClass = (mode==="omni") ? "bar-actual omni-actual" : "bar-actual kmi-actual";

    col.innerHTML = `
      <div class="top-num">${(d.goal||0).toLocaleString()}</div>
      <div class="bar-area">
        ${options.hideGoal ? "" : `<div class="${goalClass}" style="height:${goalH}%"></div>`}
        <div class="${actualClass}" style="height:${actualH}%"></div>
      </div>
      <div class="bottom-num">${(d.actual||0).toLocaleString()}</div>
      <div class="bar-label" title="${escapeHtml(d.name||"-")}">${escapeHtml(d.name||"-")}</div>
    `;
    wrap.appendChild(col);
  });
}

/* ================== Omni: 스택 (최소 폭 보장) ================== */
function setStack(segId, value, total){
  const el = document.getElementById(segId);
  if (!el) return;

  let pct = total>0 ? (value/total)*100 : 0;
  pct = clamp(pct, 0, 100);
  if (value > 0 && pct < 1) pct = 1;
  el.style.width = pct + "%";
}

/* ================== (C) Main - 국보급 소식(대표님 추천) 연동 ================== */
function todayYMD(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${dd}`;
}

function renderExecutiveNews(items, meta){
  const el = document.getElementById("executiveNews");
  const metaEl = document.getElementById("executiveNewsMeta");
  if(!el) return;

  el.innerHTML = "";

  if(metaEl){
    metaEl.textContent = meta || "";
  }

  if(!items || items.length === 0){
    const div = document.createElement("div");
    div.className = "text-slate-500 text-sm";
    div.textContent = "대표님 추천 기사가 없습니다. (news_ceo에서 3개 선택 후 저장해 주세요)";
    el.appendChild(div);
    return;
  }

  items.slice(0,3).forEach(it=>{
    const title = escapeHtml(it.title || "(제목 없음)");
    const link = it.link || it.url || "#";
    const date = escapeHtml(it.date || "");
    const summary = escapeHtml(it.summary || it.desc || "");

    const box = document.createElement("div");
    box.className = "newsItem";
    box.innerHTML = `
      <a class="newsLink newsTitle" href="${link}" target="_blank" rel="noopener">${title}</a>
      <div class="newsMeta">${date ? `${date} · ` : ""}${summary}</div>
    `;
    el.appendChild(box);
  });
}

async function loadExecutiveNewsFromCEO(){
  // ✅ Main은 “오늘 날짜 저장분”을 가져오도록 구성
  // (원하면 특정 날짜로 바꾸거나, 시트의 최신행을 가져오려면 GAS doGet에 date 없을 때 latest 반환 추가하면 됨)
  const reqDate = todayYMD();

  try{
    renderExecutiveNews([], "불러오는 중…");
    const url = EXEC_NEWS_API
      + (EXEC_NEWS_API.includes("?") ? "&" : "?")
      + "date=" + encodeURIComponent(reqDate)
      + "&t=" + Date.now();

    const res = await fetch(url, { cache:"no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);

    const data = await res.json();
    const items = data && data.items ? data.items : [];

    // 디버깅 메타(있으면 보여줌)
    const dbg = data && data.debug ? data.debug : null;
    const meta = dbg
      ? `불러온 날짜: ${dbg.requestedDate || reqDate} · 사용 행 날짜: ${dbg.usedRowDate || "-"}`
      : `불러온 날짜: ${reqDate}`;

    renderExecutiveNews(items, meta);
  }catch(err){
    console.warn("[EXEC] load failed:", err);
    renderExecutiveNews([], "불러오기 실패: API/권한/네트워크 확인 필요");
  }
}

/* ================== 뉴스 RSS (기타 카테고리만) ================== */
const INDUSTRY_FEEDS = [
  // ✅ executive는 CEO 선정으로 대체하므로 제외
  { key:"healthcheck", targetUlId:"industry-healthcheck", rss:"https://news.google.com/rss/search?q=건강검진+OR+종합검진+OR+암검진+OR+대장내시경&hl=ko&gl=KR&ceid=KR:ko" },
  { key:"center", targetUlId:"industry-center", rss:"https://news.google.com/rss/search?q=KMI+OR+%22한국의학연구소%22+OR+%22건강관리협회%22+OR+%22하나로의료재단%22&hl=ko&gl=KR&ceid=KR:ko" },
  { key:"competitor", targetUlId:"industry-competitor", rss:"https://news.google.com/rss/search?q=GC케어+OR+카카오헬스케어+OR+유비케어+OR+레몬헬스케어+OR+케어랩스&hl=ko&gl=KR&ceid=KR:ko" },
  { key:"healthcare", targetUlId:"industry-healthcare", rss:"https://news.google.com/rss/search?q=헬스케어+OR+디지털헬스+OR+AI+건강+OR+웨어러블+건강&hl=ko&gl=KR&ceid=KR:ko" }
];

async function fetchRSS2JSON(rssUrl){
  const r = await fetch("https://api.rss2json.com/v1/api.json?rss_url=" + encodeURIComponent(rssUrl));
  return r.json();
}
function stripHtml(s){ return (s || "").replace(/<[^>]*>/g, " ").replace(/\s+/g, " ").trim(); }
function toYMD(dateStr){
  const d = new Date(dateStr);
  if (Number.isNaN(d.getTime())) return "";
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${dd}`;
}
function renderNewsIntoTarget(targetId, items, fallbackMsg){
  const el = document.getElementById(targetId);
  if (!el) return;
  el.innerHTML = "";

  if (!items || items.length === 0){
    const div = document.createElement("div");
    div.className = "text-slate-500 text-sm";
    div.textContent = fallbackMsg || "표시할 소식이 없습니다.";
    el.appendChild(div);
    return;
  }

  items.slice(0,3).forEach(it=>{
    const li = document.createElement("li");
    li.className = "newsItem";
    li.innerHTML = `
      <a class="newsLink newsTitle" href="${it.link}" target="_blank" rel="noopener">${escapeHtml(it.title)}</a>
      <div class="newsMeta">${escapeHtml(it.date || "-")} · ${escapeHtml(it.summary)}</div>
    `;
    el.appendChild(li);
  });
}

async function loadIndustryNewsToMain(){
  INDUSTRY_FEEDS.forEach(cfg=> renderNewsIntoTarget(cfg.targetUlId, [], "불러오는 중…"));

  const blocks = await Promise.all(
    INDUSTRY_FEEDS.map(async (cfg) => {
      try{
        const data = await fetchRSS2JSON(cfg.rss);
        const items = (data.items || []).slice(0, 3).map(it => {
          const desc = stripHtml(it.description);
          return {
            title: it.title,
            date: toYMD(it.pubDate),
            summary: desc.slice(0,70)+(desc.length>70?"...":""),
            link: it.link
          };
        });
        return { ...cfg, items };
      }catch(e){
        return { ...cfg, items: [], error: true };
      }
    })
  );

  blocks.forEach(b=>{
    if (b.error) return renderNewsIntoTarget(b.targetUlId, [], "불러오기에 실패했습니다. (네트워크/쿼터 이슈 가능)");
    renderNewsIntoTarget(b.targetUlId, b.items, "해당 카테고리 소식 없음");
  });
}

/* ================== section1 fetch ================== */
async function fetchSection1(){
  return SECTION1_SAMPLE.section1;
}

/* ================== 초기 렌더 ================== */
(async function init(){
  await loadCEOFromGoogleSheet();

  // ✅ 대표님 추천(국보급 소식) = news_ceo 저장 기사로 채움
  await loadExecutiveNewsFromCEO();

  // ✅ 나머지 카테고리 뉴스만 RSS로 채움
  loadIndustryNewsToMain();

  const s1 = await fetchSection1();

  // ===== Omni (좌: 큰 숫자 + 구성) =====
  const omni = s1.omniSalesSummary;

  const eThird = Math.round((Number(omni.expectedOtherServiceUsingSalesPrice)||0)/1000);
  const eWith  = Math.round((Number(omni.expectedWithkmiServiceUsingSalesPrice)||0)/1000);
  const eEtc   = Math.round((Number(omni.expectedEtcSalesPrice)||0)/1000);
  const expectedTotal = eThird + eWith + eEtc;

  const cThird = Math.round((Number(omni.otherServiceUsingSalesPrice)||0)/1000);
  const cWith  = Math.round((Number(omni.withkmiServiceUsingSalesPrice)||0)/1000);
  const cEtc   = Math.round((Number(omni.etcSalesPrice)||0)/1000);
  const currentTotal = cThird + cWith + cEtc;

  document.getElementById("omniExpectedTotal").textContent = expectedTotal.toLocaleString() + "천원";
  document.getElementById("omniCurrentTotal").textContent  = currentTotal.toLocaleString() + "천원";

  setStack("expThird", eThird, expectedTotal);
  setStack("expWith",  eWith,  expectedTotal);
  setStack("expEtc",   eEtc,   expectedTotal);
  document.getElementById("expThirdTxt").textContent = eThird.toLocaleString() + "천원";
  document.getElementById("expWithTxt").textContent  = eWith.toLocaleString() + "천원";
  document.getElementById("expEtcTxt").textContent   = eEtc.toLocaleString() + "천원";

  setStack("curThird", cThird, currentTotal);
  setStack("curWith",  cWith,  currentTotal);
  setStack("curEtc",   cEtc,   currentTotal);
  document.getElementById("curThirdTxt").textContent = cThird.toLocaleString() + "천원";
  document.getElementById("curWithTxt").textContent  = cWith.toLocaleString() + "천원";
  document.getElementById("curEtcTxt").textContent   = cEtc.toLocaleString() + "천원";

  // ===== Omni (우: 본부/지사별 차트) =====
  const orgBars = (s1.omniSalesByRegionList||[]).map(r=>{
    const total = Math.round((Number(r.otherSalesPrice)||0)/1000)
               + Math.round((Number(r.withkmiSalesPrice)||0)/1000)
               + Math.round((Number(r.etcSalesPrice)||0)/1000);
    return { name:r.name, goal: total, actual: total };
  });
  renderOverlayBarChart_EqualCols(orgBars, "omniChartByOrg", "omni", { hideGoal: true });

  // ===== KMI KPI =====
  const ksum = String(s1.kmiSalesSummary.currentCumulativeSales || "0").replaceAll(",","");
  document.getElementById("kmiSumSales").textContent = Math.round(Number(ksum)/1000).toLocaleString() + "천원";
  document.getElementById("kmiTotalReserv").textContent = (Number(s1.kmiSalesSummary.totalReservCount||0)).toLocaleString();
  document.getElementById("kmiReserv").textContent = (Number(s1.kmiSalesSummary.kmiReservCount||0)).toLocaleString();
  document.getElementById("otherReserv").textContent = (Number(s1.kmiSalesSummary.otherCenterReservCount||0)).toLocaleString();

  // ===== KMI 차트 =====
  const kmiBars = (s1.kmiSalesByRegionList||[]).map(r=>({
    name: r.name,
    goal: Math.round((Number(r.goalsSalesPrice)||0)/1000),
    actual: Math.round((Number(r.summarySalesPrice)||0)/1000)
  }));
  renderOverlayBarChart_EqualCols(kmiBars, "kmiChart", "kmi");
})();
</script>

</body>
</html>
