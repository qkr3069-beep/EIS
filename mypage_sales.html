<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>OmniCare EIS · MyPage (Sales)</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css" />

<style>
  html,body{ font-family:"Pretendard Variable", system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
  .card{ border:1px solid #e5e7eb; border-radius:16px; background:#fff; box-shadow:0 8px 24px rgba(15,23,42,.06); }
  .muted{ color:#64748b; }
  .divider{ height:1px; background:#e5e7eb; }
  .chip{ border:1px solid #e5e7eb; border-radius:999px; padding:.25rem .6rem; font-size:.8rem; color:#334155; background:#f8fafc; }
  .btn2{ border:1px solid #e5e7eb; background:#fff; color:#0f172a; border-radius:12px; padding:.55rem .9rem; font-weight:800; }
  .small{ font-size:.85rem; }

  .kpiBox{ border:1px solid #e5e7eb; border-radius:16px; padding:14px; background:#fff; }
  .kpiLabel{ color:#64748b; font-size:.85rem; font-weight:700; }
  .kpiValue{ font-size:1.6rem; font-weight:900; color:#0f172a; margin-top:4px; }
  .kpiSub{ color:#64748b; font-size:.8rem; margin-top:4px; }

  table{ width:100%; border-collapse:collapse; }
  thead th{ text-align:left; font-size:.85rem; color:#334155; padding:10px 10px; border-bottom:1px solid #e5e7eb; }
  tbody td{ padding:12px 10px; border-bottom:1px solid #eef2f7; vertical-align:top; font-size:.92rem; color:#0f172a; }
  tbody tr:hover{ background:#f8fafc; }
  .num{ text-align:right; font-variant-numeric: tabular-nums; }
  .link{ color:#0f172a; text-decoration:none; font-weight:900; }
  .link:hover{ text-decoration:underline; }

  .iconBtn{
    display:inline-flex; align-items:center; justify-content:center;
    width:34px; height:34px; border-radius:12px;
    border:1px solid #e5e7eb; background:#fff;
    transition: transform .12s ease, background .12s ease;
  }
  .iconBtn:hover{ background:#f8fafc; transform: translateY(-1px); }

  /* 거래처 소식 카드 스타일 */
  .newsItem{
    padding:10px 12px;
    border:1px solid #e5e7eb;
    border-radius:14px;
    background:#f8fafc;
  }
  .newsTitle{ font-weight:900; color:#0f172a; }
  .newsMeta{ color:#64748b; font-size:.8rem; margin-top:2px; }
  .newsLink{ color:#0f172a; text-decoration:none; }
  .newsLink:hover{ text-decoration:underline; }

  input[type="date"]{ color:#0f172a; }

  /* ✅ 구성 그래프(스택 바) 공통 */
  .stackWrap{
    border:1px solid #e5e7eb;
    border-radius:999px;
    overflow:hidden;
    height:12px;
    background:#f1f5f9;
  }
  .stackSeg{ height:12px; display:block; float:left; }
  .legendDot{
    width:10px; height:10px; border-radius:999px; display:inline-block;
    border:1px solid #e5e7eb;
  }

  /* ✅ 계약형태 뱃지 */
  .pill{
    display:inline-flex; align-items:center; gap:6px;
    border:1px solid #e5e7eb;
    border-radius:999px;
    padding:4px 10px;
    font-size:.78rem;
    font-weight:900;
    background:#fff;
    white-space:nowrap;
  }
  .pill i{ width:8px; height:8px; border-radius:999px; display:inline-block; }
  .pill-3p i{ background:#0ea5e9; }
  .pill-with i{ background:#22c55e; }
  .pill-etc i{ background:#a855f7; }

  /* ✅ 상태 뱃지(최근 방문 기준 2개월) */
  .statusPill{
    display:inline-flex; align-items:center; gap:6px;
    border:1px solid #e5e7eb;
    border-radius:999px;
    padding:4px 10px;
    font-size:.78rem;
    font-weight:900;
    background:#fff;
    white-space:nowrap;
  }
  .statusPill i{ width:8px; height:8px; border-radius:999px; display:inline-block; }
  .status-on i{ background:#0ea5e9; }    /* 활성 */
  .status-off i{ background:#64748b; }   /* 비활성 */

  /* ✅ KMI 매출 구성(종검/종검 외/국가) 전용 색상 */
  .kmiA{ background:#f97316; }   /* 종검 */
  .kmiB{ background:#f59e0b; }   /* 종검 외 */
  .kmiC{ background:#eab308; }   /* 국가 */
</style>
</head>

<body class="bg-slate-50">

<header class="sticky top-0 z-20 bg-white/90 backdrop-blur border-b border-slate-200">
  <div class="max-w-[1440px] mx-auto px-2 py-3 flex items-center gap-3">
    <a href="https://qkr3069-beep.github.io/EIS/" aria-label="메인으로 이동">
      <img src="omnicare_logo.png" alt="옴니케어 로고" class="h-12 object-contain cursor-pointer" />
    </a>

    <div class="flex-1">
      <div class="font-semibold text-slate-900">OmniCare Intelligence Hub</div>
      <div class="text-sm muted">마이페이지 · 영업자 개요</div>
    </div>
    <button onclick="location.href='https://qkr3069-beep.github.io/EIS/'" class="btn2">메인</button>
    <a href="accounts_by_customer.html" class="btn2" aria-label="거래처별 정보" title="거래처별 정보">거래처별 정보</a>
  </div>
</header>

<main class="max-w-[1440px] mx-auto px-2 py-6 space-y-6">

  <section class="card p-5">
    <div class="flex items-start justify-between gap-3 flex-wrap">
      <div>
        <div class="text-lg font-extrabold text-slate-900">마이페이지 (영업자)</div>
        <div class="muted small" id="userLine">-</div>
      </div>
      <span class="chip">Sales Overview</span>
    </div>
  </section>

  <!-- KPI -->
  <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3">
    <div class="kpiBox">
      <div class="kpiLabel">담당 거래처 수</div>
      <div class="kpiValue" id="kpiTotalAccounts">-</div>
      <div class="kpiSub">내 명의(담당자 기준)</div>
    </div>

    <div class="kpiBox">
      <div class="kpiLabel">활성 거래처 수</div>
      <div class="kpiValue" id="kpiActiveAccounts">-</div>
      <div class="kpiSub">최근 방문일 2개월 이내</div>
    </div>

    <div class="kpiBox">
      <div class="kpiLabel">비활성 거래처 수</div>
      <div class="kpiValue" id="kpiInactiveAccounts">-</div>
      <div class="kpiSub">최근 방문일 2개월 초과</div>
    </div>

    <div class="kpiBox">
      <div class="kpiLabel">금년도 누적 수검자 수</div>
      <div class="kpiValue" id="kpiYtdExaminees">-</div>
      <div class="kpiSub">내 담당 거래처 누적 합계</div>
    </div>

    <div class="kpiBox">
      <div class="kpiLabel">신규 거래처 수</div>
      <div class="kpiValue" id="kpiNewAccounts">-</div>
      <div class="kpiSub">이번달 신규 등록</div>
    </div>
  </section>

  <!-- 매출 2개 -->
  <section class="grid grid-cols-1 lg:grid-cols-2 gap-4">
    <!-- ✅ KMI 매출 -->
    <div class="card p-5">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="font-extrabold text-slate-900 text-lg">KMI 검진 매출액</div>
          <div class="muted small">내 담당 거래처 기준 (샘플 합산)</div>
        </div>
        <span class="chip">단위: 천원</span>
      </div>

      <div class="divider my-4"></div>

      <div class="text-3xl font-black text-slate-900" id="kpiKmiRevenue">-</div>

      <div class="mt-3">
        <div class="stackWrap" aria-label="KMI 매출 구성 그래프">
          <span id="kmiSegA" class="stackSeg kmiA" style="width:0%"></span>
          <span id="kmiSegB" class="stackSeg kmiB" style="width:0%"></span>
          <span id="kmiSegC" class="stackSeg kmiC" style="width:0%"></span>
        </div>
        <div class="flex items-center justify-between mt-2 muted small">
          <span id="kmiPctA">종검 0%</span>
          <span id="kmiPctB">종검 외 0%</span>
          <span id="kmiPctC">국가 0%</span>
        </div>
      </div>

      <div class="mt-3 space-y-1">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span class="legendDot" style="background:#f97316;"></span>
            <span class="muted small">종검</span>
          </div>
          <div class="font-extrabold text-slate-900 small" id="kmiAVal">-</div>
        </div>
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span class="legendDot" style="background:#f59e0b;"></span>
            <span class="muted small">종검 외</span>
          </div>
          <div class="font-extrabold text-slate-900 small" id="kmiBVal">-</div>
        </div>
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span class="legendDot" style="background:#eab308;"></span>
            <span class="muted small">국가</span>
          </div>
          <div class="font-extrabold text-slate-900 small" id="kmiCVal">-</div>
        </div>
      </div>

      <div class="muted small mt-2" id="kpiKmiRevenueSub">-</div>
    </div>

    <!-- 옴니케어 매출 -->
    <div class="card p-5">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="font-extrabold text-slate-900 text-lg">옴니케어 매출액</div>
          <div class="muted small">내 담당 거래처 기준 (샘플 합산)</div>
        </div>
        <span class="chip">단위: 천원</span>
      </div>

      <div class="divider my-4"></div>

      <div class="text-3xl font-black text-slate-900" id="kpiOmniRevenue">-</div>

      <div class="mt-3">
        <div class="stackWrap" aria-label="옴니케어 매출 구성 그래프">
          <span id="seg3p" class="stackSeg" style="background:#0ea5e9; width:0%"></span>
          <span id="segWith" class="stackSeg" style="background:#22c55e; width:0%"></span>
          <span id="segEtc" class="stackSeg" style="background:#a855f7; width:0%"></span>
        </div>
        <div class="flex items-center justify-between mt-2 muted small">
          <span id="pct3p">3자 0%</span>
          <span id="pctWith">WITH KMI 0%</span>
          <span id="pctEtc">기타 0%</span>
        </div>
      </div>

      <div class="mt-3 space-y-1">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span class="legendDot" style="background:#0ea5e9;"></span>
            <span class="muted small">3자 매출</span>
          </div>
          <div class="font-extrabold text-slate-900 small" id="omni3pVal">-</div>
        </div>
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span class="legendDot" style="background:#22c55e;"></span>
            <span class="muted small">WITH KMI 매출</span>
          </div>
          <div class="font-extrabold text-slate-900 small" id="omniWithVal">-</div>
        </div>
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span class="legendDot" style="background:#a855f7;"></span>
            <span class="muted small">기타 매출</span>
          </div>
          <div class="font-extrabold text-slate-900 small" id="omniEtcVal">-</div>
        </div>
      </div>

      <div class="muted small mt-2" id="kpiOmniRevenueSub">-</div>
    </div>
  </section>

  <!-- 거래처 현황 -->
  <section class="card p-5">
    <div class="flex items-start justify-between gap-3 flex-wrap">
      <div>
        <div class="text-lg font-extrabold text-slate-900">거래처 현황</div>
        <div class="muted small">최근 방문 흐름 확인용 · 내 담당 기준 (샘플)</div>
      </div>

      <div class="flex items-center gap-2">
        <input id="q" class="border border-slate-200 rounded-xl px-3 py-2 bg-white w-64"
               placeholder="거래처 검색 (전체에서 검색 후 TOP5 표시)" />
        <a href="accounts_sales_all.html" class="iconBtn" aria-label="거래처 현황 전체보기" title="거래처 현황 전체보기">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/>
          </svg>
        </a>
      </div>
    </div>

    <div class="divider my-4"></div>

    <div class="overflow-auto">
      <table>
        <thead>
          <tr>
            <th style="min-width:240px;">거래처명</th>
            <th style="min-width:120px;">상태</th>
            <th style="min-width:140px;">계약 형태</th>
            <th class="num" style="min-width:160px;">금년도 누적 매출</th>
            <th class="num" style="min-width:160px;">금년도 누적 수검자</th>
            <th style="min-width:140px;">첫 방문일</th>
            <th style="min-width:140px;">마지막 방문일</th>
          </tr>
        </thead>
        <tbody id="accountsTbody"></tbody>
      </table>
    </div>

    <div class="mt-3 muted small" id="scopeHint"></div>
  </section>

  <!-- 거래처 소식 -->
  <section class="card p-5">
    <div class="flex items-start justify-between gap-3 flex-wrap">
      <div>
        <div class="text-lg font-extrabold text-slate-900">거래처 소식</div>
        <div class="muted small" id="acctNewsSub">구글시트(omnicare_customer A열) 기반 뉴스 5건 · 조회 날짜 기준</div>
      </div>

      <div class="flex items-center gap-2">
        <input type="date" id="acctNewsDate" class="border border-slate-200 rounded-xl px-3 py-2 bg-white" />
        <button class="btn2" onclick="loadAccountNewsToMyPage(false)">조회</button>
        <button class="btn2" onclick="loadAccountNewsToMyPage(true)" title="시트 캐시 무시하고 새로고침">강제 새로고침</button>

        <a href="accounts_news_all.html" class="iconBtn" aria-label="거래처 소식 전체보기" title="거래처 소식 전체보기">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M9 5l7 7-7 7"/>
          </svg>
        </a>
      </div>
    </div>

    <div class="divider my-4"></div>

    <div id="acctNewsList" class="space-y-2"></div>
    <div class="mt-3 muted small" id="acctNewsHint"></div>
  </section>

  <footer class="text-center muted small py-6">
    샘플 화면입니다. 실제 서비스에서는 로그인/권한/DB 기준으로 자동 산출됩니다.
  </footer>
</main>

<script>
/** =========================
 *  ✅ 설정 (중요)
 * ========================= */
const API_BASE   = "https://eis.qkr3069.workers.dev"; // ✅ 시트 프록시(/sheet/names), RSS 프록시(/rss), gnews(/gnews) 모두 여기
const SHEET_ID   = "1kKsPK5Kxplgoutz4pkS8QqXTdC7Ai1jeaeaOJsZVgnI";
const SHEET_NAME = "omnicare_customer";

/** =========================
 *  로그인 사용자(샘플)
 * ========================= */
const CURRENT_USER = { id:"u1", name:"김영업", team:"A팀", role:"sales" };
const NOW_YM = "2025-12";

/** =========================
 *  유틸
 * ========================= */
const fmt = (n) => (n ?? 0).toLocaleString("ko-KR");
const toKRWThousand = (n) => (n ?? 0) * 10; // (만원) -> (천원)

function toYMD(d){
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const dd=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${dd}`;
}
function addDays(base, days){
  const d=new Date(base);
  d.setDate(d.getDate()+days);
  return d;
}
function seededRand(i){
  const x = Math.sin(i * 999) * 10000;
  return x - Math.floor(x);
}
function addMonths(date, months){
  const d = new Date(date);
  d.setMonth(d.getMonth() + months);
  return d;
}
function parseYMD(ymd){
  if (!ymd) return null;
  const [y,m,d] = ymd.split("-").map(Number);
  if (!y || !m || !d) return null;
  return new Date(y, m-1, d);
}
function isActiveByLastVisitYMD(lastVisitYMD){
  const dt = parseYMD(lastVisitYMD);
  if (!dt) return false;
  const today = new Date();
  const cutoff = addMonths(today, -2);
  return dt >= cutoff;
}
function statusPillHTMLByLastVisit(lastVisitYMD){
  const on = isActiveByLastVisitYMD(lastVisitYMD);
  if (on) return `<span class="statusPill status-on"><i></i>활성</span>`;
  return `<span class="statusPill status-off"><i></i>비활성</span>`;
}
function pct(part, total){
  if (!total || total <= 0) return 0;
  return Math.max(0, Math.round((part / total) * 100));
}
function fixWidth(p){ return p <= 0 ? 0 : p; }
function stripHtml(s){
  return (s || "").replace(/<[^>]*>/g, " ").replace(/\s+/g, " ").trim();
}
function toYMDFromStr(dateStr){
  const d = new Date(dateStr);
  if (Number.isNaN(d.getTime())) return "";
  return toYMD(d);
}

/** =========================
 *  샘플 데이터
 * ========================= */
function pickContractType(omni3p, omniWith, omniEtc){
  const maxV = Math.max(omni3p||0, omniWith||0, omniEtc||0);
  if (maxV === (omni3p||0)) return "3자";
  if (maxV === (omniWith||0)) return "WITH KMI";
  return "기타";
}
function contractPillHTML(t){
  if (t === "3자") return `<span class="pill pill-3p"><i></i>3자</span>`;
  if (t === "WITH KMI") return `<span class="pill pill-with"><i></i>WITH KMI</span>`;
  return `<span class="pill pill-etc"><i></i>기타</span>`;
}
function makeSampleAccounts(n=100){
  const owners = ["김영업","박영업","이영업","최영업"];
  const prefixes = ["메디컬","종합","헬스","케어","바이오","메디","건강","연구","검진","파트너"];
  const cities = ["대구","수성","달서","동구","서구","중구","수원","부산","광주","제주","여의도","강남","광화문"];

  const baseDate = new Date("2025-12-15T00:00:00");
  const out = [];

  for(let i=1;i<=n;i++){
    const r1 = seededRand(i);
    const r2 = seededRand(i+100);
    const r3 = seededRand(i+200);
    const r4 = seededRand(i+300);
    const r5 = seededRand(i+400);
    const r6 = seededRand(i+500);
    const r7 = seededRand(i+700);
    const r8 = seededRand(i+800);

    const owner = owners[Math.floor(r1*owners.length)];
    const name = `${cities[Math.floor(r2*cities.length)]}${prefixes[Math.floor(r3*prefixes.length)]}센터 ${String(i).padStart(3,"0")}`;

    const ytdRevenue = Math.round( (2000 + r1*48000) / 10 ) * 10; // (만원)
    const ytdExaminees = Math.round( 20 + r3*980 );
    const lastTouchDays = Math.floor(r1*70);

    const statusPick = r2 < 0.08 ? "해지" : (r2 < 0.18 ? "휴면" : "진행");
    const createdYM = r3 < 0.15 ? NOW_YM : (r3 < 0.45 ? "2025-11" : "2025-10");

    const examBooked = Math.round(20 + r2*280);
    const examDone = Math.min(examBooked, Math.round(examBooked*(0.45 + r3*0.50)));

    const kmiRevenue = Math.round(ytdRevenue * (0.55 + r1*0.25)); // (만원)
    const omniRevenue = Math.max(0, ytdRevenue - kmiRevenue);     // (만원)

    const p3 = 0.25 + r4*0.45;
    const pWith = 0.10 + r5*0.40;

    let omniRev3p = Math.round(omniRevenue * p3 / 10) * 10;
    let omniRevWithKmi = Math.round(omniRevenue * pWith / 10) * 10;
    let omniRevEtc = omniRevenue - omniRev3p - omniRevWithKmi;
    if (omniRevEtc < 0){
      omniRevEtc = 0;
      omniRevWithKmi = Math.max(0, omniRevenue - omniRev3p);
    }

    const contractType = pickContractType(omniRev3p, omniRevWithKmi, omniRevEtc);

    const pA = 0.35 + r7*0.40;   // 종검
    const pB = 0.10 + r8*0.35;   // 종검 외
    let kmiRevA = Math.round(kmiRevenue * pA / 10) * 10;
    let kmiRevB = Math.round(kmiRevenue * pB / 10) * 10;
    let kmiRevC = kmiRevenue - kmiRevA - kmiRevB; // 국가
    if (kmiRevC < 0){
      kmiRevC = 0;
      kmiRevB = Math.max(0, kmiRevenue - kmiRevA);
    }

    const lastVisitDate = toYMD(addDays(baseDate, -lastTouchDays));
    const firstGap = 30 + Math.floor(r6 * 330);
    const firstVisitDate = toYMD(addDays(new Date(lastVisitDate + "T00:00:00"), -firstGap));

    out.push({
      id:`a${i}`,
      name,
      owner,
      createdYM,
      status: statusPick,
      lastTouchDays,
      examBooked,
      examDone,

      kmiRevenue,
      kmiRevA, kmiRevB, kmiRevC,

      omniRevenue,
      omniRev3p,
      omniRevWithKmi,
      omniRevEtc,

      ytdRevenue,
      ytdExaminees,
      contractType,
      firstVisitDate,
      lastVisitDate
    });
  }
  return out;
}
const ACCOUNTS = makeSampleAccounts(100);

/** =========================
 *  KPI 산출
 * ========================= */
function scopedAccounts(){
  return ACCOUNTS.filter(a => a.owner === CURRENT_USER.name);
}
function calcKPIs(){
  const list = scopedAccounts();
  const total = list.length;
  const active = list.filter(a => isActiveByLastVisitYMD(a.lastVisitDate)).length;
  const inactive = total - active;
  const 신규 = list.filter(a => a.createdYM === NOW_YM).length;

  const kmiRev = list.reduce((s,a)=> s + (a.kmiRevenue || 0), 0);   // (만원)
  const omniRev = list.reduce((s,a)=> s + (a.omniRevenue || 0), 0); // (만원)

  const kmiA = list.reduce((s,a)=> s + (a.kmiRevA || 0), 0);
  const kmiB = list.reduce((s,a)=> s + (a.kmiRevB || 0), 0);
  const kmiC = list.reduce((s,a)=> s + (a.kmiRevC || 0), 0);

  const omni3p = list.reduce((s,a)=> s + (a.omniRev3p || 0), 0);
  const omniWith = list.reduce((s,a)=> s + (a.omniRevWithKmi || 0), 0);
  const omniEtc = list.reduce((s,a)=> s + (a.omniRevEtc || 0), 0);

  const ytdExamineesTotal = list.reduce((s,a)=> s + (a.ytdExaminees || 0), 0);
  const booked = list.reduce((s,a)=> s + (a.examBooked || 0), 0);
  const done   = list.reduce((s,a)=> s + (a.examDone || 0), 0);

  return {
    total, active, inactive, 신규,
    kmiRev, kmiA, kmiB, kmiC,
    omniRev, omni3p, omniWith, omniEtc,
    ytdExamineesTotal, booked, done
  };
}

/** =========================
 *  구성 그래프 렌더(옴니)
 * ========================= */
function renderOmniBreakdown(k){
  const total = k.omniRev || 0;
  const v3 = k.omni3p || 0;
  const vW = k.omniWith || 0;
  const vE = Math.max(0, total - v3 - vW);

  const p3 = pct(v3, total);
  const pW = pct(vW, total);
  const pE = Math.max(0, 100 - p3 - pW);

  document.getElementById("seg3p").style.width = fixWidth(p3) + "%";
  document.getElementById("segWith").style.width = fixWidth(pW) + "%";
  document.getElementById("segEtc").style.width = fixWidth(pE) + "%";

  document.getElementById("pct3p").textContent = `3자 ${p3}%`;
  document.getElementById("pctWith").textContent = `WITH KMI ${pW}%`;
  document.getElementById("pctEtc").textContent = `기타 ${pE}%`;

  document.getElementById("omni3pVal").textContent = `${fmt(toKRWThousand(v3))} 천원`;
  document.getElementById("omniWithVal").textContent = `${fmt(toKRWThousand(vW))} 천원`;
  document.getElementById("omniEtcVal").textContent = `${fmt(toKRWThousand(vE))} 천원`;
}

/** =========================
 *  구성 그래프 렌더(KMI: 종검/종검 외/국가)
 * ========================= */
function renderKmiBreakdown(k){
  const total = k.kmiRev || 0;
  const a = k.kmiA || 0;
  const b = k.kmiB || 0;
  const c = Math.max(0, total - a - b);

  const pA = pct(a, total);
  const pB = pct(b, total);
  const pC = Math.max(0, 100 - pA - pB);

  document.getElementById("kmiSegA").style.width = fixWidth(pA) + "%";
  document.getElementById("kmiSegB").style.width = fixWidth(pB) + "%";
  document.getElementById("kmiSegC").style.width = fixWidth(pC) + "%";

  document.getElementById("kmiPctA").textContent = `종검 ${pA}%`;
  document.getElementById("kmiPctB").textContent = `종검 외 ${pB}%`;
  document.getElementById("kmiPctC").textContent = `국가 ${pC}%`;

  document.getElementById("kmiAVal").textContent = `${fmt(toKRWThousand(a))} 천원`;
  document.getElementById("kmiBVal").textContent = `${fmt(toKRWThousand(b))} 천원`;
  document.getElementById("kmiCVal").textContent = `${fmt(toKRWThousand(c))} 천원`;
}

/** =========================
 *  거래처 표: TOP5
 * ========================= */
function getTop5ByLastVisitFrom(list){
  const x = list.slice();
  x.sort((a,b)=> (b.lastVisitDate || "").localeCompare(a.lastVisitDate || ""));
  return x.slice(0,5);
}
function renderAccountsTop5(){
  const tbody = document.getElementById("accountsTbody");
  const q = (document.getElementById("q").value || "").trim().toLowerCase();

  const base = scopedAccounts();
  const filtered = q ? base.filter(a => a.name.toLowerCase().includes(q)) : base;
  const list = getTop5ByLastVisitFrom(filtered);

  tbody.innerHTML = "";

  if (!list.length){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="7" class="muted" style="padding:14px;">표시할 거래처가 없습니다.</td>`;
    tbody.appendChild(tr);
    document.getElementById("scopeHint").textContent =
      q
        ? `검색: “${q}” · 검색 결과 0건`
        : `내 담당 거래처 ${fmt(base.length)}곳 중 최근 방문 기준 TOP5만 노출됩니다. (전체는 우측 아이콘)`;
    return;
  }

  list.forEach(a=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="font-weight:900;">
        <a class="link" href="#" onclick="alert('거래처 상세(예정)'); return false;">${a.name}</a>
        <div class="muted small mt-1">담당: ${a.owner}</div>
      </td>

      <td>${statusPillHTMLByLastVisit(a.lastVisitDate)}</td>

      <td>${contractPillHTML(a.contractType)}</td>

      <td class="num">${fmt(toKRWThousand(a.ytdRevenue))} 천원</td>

      <td class="num">${fmt(a.ytdExaminees || 0)} 명</td>

      <td>${a.firstVisitDate || "-"}</td>
      <td>${a.lastVisitDate || "-"}</td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById("scopeHint").textContent =
    q
      ? `검색: “${q}” · 검색 결과 ${fmt(filtered.length)}곳 중 최근 방문 기준 TOP5 표시 (전체는 우측 아이콘)`
      : `내 담당 거래처 ${fmt(scopedAccounts().length)}곳 중 최근 방문 기준 TOP5만 노출됩니다. (전체는 우측 아이콘)`;
}

/** =========================
 *  ✅ Google Sheet 키워드 캐시
 * ========================= */
const SHEET_CACHE_KEY = "omni.sheet.names.cache.v1";
const SHEET_CACHE_TTL_MS = 1000 * 60 * 60 * 6; // 6시간

function saveCachedSheetNames(names){
  try{
    localStorage.setItem(SHEET_CACHE_KEY, JSON.stringify({ t: Date.now(), names }));
  }catch(_e){}
}
function loadCachedSheetNames(){
  try{
    const raw = localStorage.getItem(SHEET_CACHE_KEY);
    if (!raw) return null;
    const obj = JSON.parse(raw);
    if (!obj?.t || !Array.isArray(obj?.names)) return null;
    if (Date.now() - obj.t > SHEET_CACHE_TTL_MS) return null;
    return obj.names;
  }catch(_e){
    return null;
  }
}
function normalizeCompanyName(s){
  let x = (s || "").toString().trim();
  if (!x) return "";
  x = x.replace(/\u00A0/g, " ");
  x = x.replace(/\s+/g, " ").trim();
  // 너무 길면 검색 품질 떨어져서 컷
  if (x.length > 30) x = x.slice(0,30);
  return x;
}

/** =========================
 *  ✅ 시트(A2:A)에서 회사명 가져오기 (Worker 프록시)
 *  - Worker: /sheet/names?sheet_id=...&sheet_name=...&range=A2:A
 * ========================= */
async function fetchCompanyNamesFromSheet(force=false){
  if (force){
    try{ localStorage.removeItem(SHEET_CACHE_KEY); }catch(_e){}
  }
  if (!force){
    const cached = loadCachedSheetNames();
    if (cached && cached.length) return cached;
  }

  const proxyUrl =
    `${API_BASE}/sheet/names?sheet_id=${encodeURIComponent(SHEET_ID)}` +
    `&sheet_name=${encodeURIComponent(SHEET_NAME)}` +
    `&range=${encodeURIComponent("A2:A")}` +
    `&_=${Date.now()}`;

  const r = await fetch(proxyUrl, { cache:"no-store" });
  const data = await r.json().catch(()=> ({}));

  if (!r.ok || !data?.ok) {
    throw new Error(data?.error || `Sheet proxy failed: ${r.status}`);
  }

  const set = new Set();
  const cleaned = [];
  for (const v of (data.names || [])){
    const nn = normalizeCompanyName(v);
    if (!nn) continue;
    if (set.has(nn)) continue;
    set.add(nn);
    cleaned.push(nn);
  }

  saveCachedSheetNames(cleaned);
  return cleaned;
}

/** =========================
 *  ✅ RSS 가져오기 (Worker /rss 프록시 사용)
 *  - rss2json.com 미사용 (쿼터/차단 회피)
 * ========================= */
async function fetchRssXmlViaWorker(rssUrl){
  const u = `${API_BASE}/rss?url=${encodeURIComponent(rssUrl)}&_=${Date.now()}`;
  const r = await fetch(u, { cache:"no-store" });
  if (!r.ok) throw new Error(`RSS proxy failed: ${r.status}`);
  return await r.text();
}
function parseRssItemsFromXml(xmlText){
  const doc = new DOMParser().parseFromString(xmlText, "text/xml");
  const items = Array.from(doc.querySelectorAll("item")).map(it => ({
    title: (it.querySelector("title")?.textContent || "").trim(),
    link: (it.querySelector("link")?.textContent || "").trim(),
    pubDate: (it.querySelector("pubDate")?.textContent || "").trim(),
    description: (it.querySelector("description")?.textContent || "").trim(),
    source: (it.querySelector("source")?.textContent || "").trim(),
  })).filter(x => x.title && x.link);
  return items;
}

/** =========================
 *  거래처 소식(뉴스 5개) - 시트 기반
 * ========================= */
function buildGoogleNewsRssByTerms(terms){
  // OR 조건
  const q = terms.map(t => `"${t}"`).join(" OR ");
  return `https://news.google.com/rss/search?q=${encodeURIComponent(q)}&hl=ko&gl=KR&ceid=KR:ko`;
}
function buildAccountNewsRSSFallback(){
  // fallback: 내 담당 TOP(기존 샘플 로직 유지)
  const base = scopedAccounts().slice();
  base.sort((a,b)=> (b.lastVisitDate || "").localeCompare(a.lastVisitDate || ""));
  const top = base.slice(0,8).map(a => a.name.replace(/\s*센터\s*\d+\s*$/,"").trim());
  const terms = top.length ? top : ["검진센터","건강검진"];
  return { rss: buildGoogleNewsRssByTerms(terms), usedTerms: terms, from: "fallback(내 담당 TOP)" };
}

function renderAccountNewsItems(items, selectedYMD, meta){
  const wrap = document.getElementById("acctNewsList");
  const hint = document.getElementById("acctNewsHint");
  wrap.innerHTML = "";

  // pubDate 변환
  const mapped = items.map(it => ({
    ...it,
    ymd: toYMDFromStr(it.pubDate) || "",
    desc: stripHtml(it.description || "")
  }));

  const byDate = mapped.filter(it => it.ymd === selectedYMD);
  const show = (byDate.length ? byDate : mapped).slice(0,5);

  if (!show.length){
    wrap.innerHTML = `<div class="muted">표시할 소식이 없습니다.</div>`;
    hint.textContent = "뉴스를 불러오지 못했거나 결과가 없습니다.";
    return;
  }

  show.forEach(it=>{
    const clean = (it.desc || "").slice(0, 90);
    const ymd = it.ymd || "-";
    const div = document.createElement("div");
    div.className = "newsItem";
    div.innerHTML = `
      <a class="newsLink newsTitle" href="${it.link}" target="_blank" rel="noopener">${it.title}</a>
      <div class="newsMeta">${ymd} · ${clean}${clean.length>=90?"...":""}</div>
    `;
    wrap.appendChild(div);
  });

  const used = meta?.usedTerms || [];
  const from = meta?.from || "-";

  hint.textContent = byDate.length
    ? `조회일 ${selectedYMD} 기준 ${Math.min(5, byDate.length)}건 표시 · 키워드 ${used.length}개 사용 (${from})`
    : `조회일 ${selectedYMD} 기사가 부족하여 최신 기사로 대체 표시 · 키워드 ${used.length}개 사용 (${from})`;
}

async function loadAccountNewsToMyPage(force=false){
  const dateEl = document.getElementById("acctNewsDate");
  const selectedYMD = dateEl.value;

  const wrap = document.getElementById("acctNewsList");
  const hint = document.getElementById("acctNewsHint");

  wrap.innerHTML = `<div class="muted">불러오는 중…</div>`;
  hint.textContent = "";

  try{
    // 1) 시트 기반 키워드
    const names = await fetchCompanyNamesFromSheet(force);

    // 너무 길어지면 RSS가 빈 결과/에러가 날 수 있어 상한
    const terms = (names && names.length ? names : []).slice(0, 10);
    const rss = buildGoogleNewsRssByTerms(terms);

    // 2) RSS 프록시로 XML 가져와 파싱
    const xml = await fetchRssXmlViaWorker(rss);
    const items = parseRssItemsFromXml(xml);

    // 3) 렌더
    renderAccountNewsItems(items, selectedYMD, { from:"sheet(A열)", usedTerms: terms });

    // 상단 보조문구도 업데이트
    document.getElementById("acctNewsSub").textContent =
      `구글시트(${SHEET_NAME} A열) 기반 뉴스 5건 · 조회 날짜 기준 · 키워드 ${terms.length}개`;
  }catch(e){
    // 실패 시 fallback
    try{
      const meta2 = buildAccountNewsRSSFallback();
      const xml2 = await fetchRssXmlViaWorker(meta2.rss);
      const items2 = parseRssItemsFromXml(xml2);
      renderAccountNewsItems(items2, selectedYMD, meta2);

      document.getElementById("acctNewsSub").textContent =
        `구글시트 조회 실패로 대체 표시 · ${meta2.from}`;
      // 에러는 힌트 뒤에 살짝 남김
      hint.textContent += ` (시트 오류: ${String(e?.message || e)})`;
    }catch(_e2){
      wrap.innerHTML = `<div class="muted">불러오기에 실패했습니다. (네트워크 이슈 가능)</div>`;
      hint.textContent = `오류: ${String(e?.message || e)}`;
    }
  }
}

/** =========================
 *  렌더
 * ========================= */
function render(){
  document.getElementById("userLine").textContent =
    `${CURRENT_USER.name} · ${CURRENT_USER.team} · ${NOW_YM} 기준`;

  const k = calcKPIs();

  document.getElementById("kpiTotalAccounts").textContent  = `${fmt(k.total)}`;
  document.getElementById("kpiActiveAccounts").textContent = `${fmt(k.active)}`;
  document.getElementById("kpiInactiveAccounts").textContent = `${fmt(k.inactive)}`;
  document.getElementById("kpiYtdExaminees").textContent = `${fmt(k.ytdExamineesTotal)}명`;
  document.getElementById("kpiNewAccounts").textContent    = `${fmt(k.신규)}`;

  document.getElementById("kpiKmiRevenue").textContent     = `${fmt(toKRWThousand(k.kmiRev))} 천원`;
  document.getElementById("kpiOmniRevenue").textContent    = `${fmt(toKRWThousand(k.omniRev))} 천원`;

  document.getElementById("kpiKmiRevenueSub").textContent  =
    `수검 완료 ${fmt(k.done)} / 예약 ${fmt(k.booked)} 건(샘플)`;
  document.getElementById("kpiOmniRevenueSub").textContent =
    `내 담당 거래처 ${fmt(k.total)}곳 합산 · 구성(3자/WITH KMI/기타) 포함(샘플)`;

  renderKmiBreakdown(k);
  renderOmniBreakdown(k);
  renderAccountsTop5();

  const today = new Date();
  document.getElementById("acctNewsDate").value = toYMD(today);
  loadAccountNewsToMyPage(false);
}

document.getElementById("q").addEventListener("input", renderAccountsTop5);
render();
</script>
</body>
</html>
