<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>OmniCare EIS · Accounts News (Sales · All)</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css" />

<style>
  html,body{ font-family:"Pretendard Variable", system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
  .card{ border:1px solid #e5e7eb; border-radius:16px; background:#fff; box-shadow:0 8px 24px rgba(15,23,42,.06); }
  .muted{ color:#64748b; }
  .divider{ height:1px; background:#e5e7eb; }
  .chip{ border:1px solid #e5e7eb; border-radius:999px; padding:.25rem .6rem; font-size:.8rem; color:#334155; background:#f8fafc; }
  .btn2{ border:1px solid #e5e7eb; background:#fff; color:#0f172a; border-radius:12px; padding:.55rem .9rem; font-weight:800; }
  .small{ font-size:.85rem; }

  .newsItem{
    padding:12px 14px;
    border:1px solid #e5e7eb;
    border-radius:16px;
    background:#fff;
  }
  .newsTitle{ font-weight:900; color:#0f172a; }
  .newsMeta{ color:#64748b; font-size:.82rem; margin-top:4px; }
  .newsLink{ color:#0f172a; text-decoration:none; }
  .newsLink:hover{ text-decoration:underline; }

  input, select{
    border:1px solid #e5e7eb;
    border-radius:14px;
    padding:.6rem .8rem;
    background:#fff;
    color:#0f172a;
  }
  input[type="date"]{ color:#0f172a; }

  .pill{
    display:inline-flex; align-items:center; gap:6px;
    border:1px solid #e5e7eb;
    border-radius:999px;
    padding:4px 10px;
    font-size:.78rem;
    font-weight:900;
    background:#f8fafc;
    white-space:nowrap;
  }
</style>
</head>

<body class="bg-slate-50">

<header class="sticky top-0 z-20 bg-white/90 backdrop-blur border-b border-slate-200">
  <div class="max-w-[1440px] mx-auto px-2 py-3 flex items-center gap-3">
    <a href="https://qkr3069-beep.github.io/EIS/" aria-label="메인으로 이동">
      <img src="omnicare_logo.png" alt="옴니케어 로고" class="h-12 object-contain cursor-pointer" />
    </a>
    <div class="flex-1">
      <div class="font-semibold text-slate-900">OmniCare Intelligence Hub</div>
      <div class="text-sm muted">거래처 소식 · 전체보기 (영업자)</div>
    </div>
    <button onclick="location.href='mypage_sales.html'" class="btn2">마이페이지</button>
    <button onclick="location.href='https://qkr3069-beep.github.io/EIS/'" class="btn2">메인</button>
  </div>
</header>

<main class="max-w-[1440px] mx-auto px-2 py-6 space-y-6">

  <section class="card p-5">
    <div class="flex items-start justify-between gap-3 flex-wrap">
      <div>
        <div class="text-lg font-extrabold text-slate-900">거래처 소식 전체보기</div>
        <div class="muted small" id="userLine">-</div>
      </div>
      <span class="chip">Account News</span>
    </div>

    <div class="divider my-4"></div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-3 items-center">
      <div class="lg:col-span-3">
        <label class="muted small block mb-1">조회 날짜</label>
        <input type="date" id="datePicker" class="w-full"/>
      </div>

      <div class="lg:col-span-5">
        <label class="muted small block mb-1">검색(제목/요약)</label>
        <input id="q" class="w-full" placeholder="예: KMI, 검진, 계약, 미수금, 대구…" />
      </div>

      <div class="lg:col-span-2">
        <label class="muted small block mb-1">표시 건수</label>
        <select id="limitSel" class="w-full">
          <option value="20">20</option>
          <option value="40">40</option>
          <option value="60">60</option>
          <option value="100">100</option>
        </select>
      </div>

      <div class="lg:col-span-2 flex items-end gap-2">
        <button class="btn2 w-full" onclick="loadAccountNewsAll(false)">조회</button>
        <button class="btn2 w-full" onclick="loadAccountNewsAll(true)" title="시트 캐시 무시하고 새로고침">강제</button>
      </div>
    </div>

    <div class="mt-3 flex flex-wrap gap-2 items-center">
      <span class="pill" id="sheetPill">Sheet: -</span>
      <span class="pill" id="kwPill">키워드: -</span>
      <span class="pill" id="dupPill">중복 제거: -</span>
    </div>

    <div class="mt-3 muted small" id="hint">-</div>
  </section>

  <section class="card p-5">
    <div id="list" class="space-y-3"></div>
  </section>

  <footer class="text-center muted small py-6">
    샘플 화면입니다. 실제 서비스에서는 “관리자 추천/거래처 선택” 기반으로 정교화 가능합니다.
  </footer>
</main>

<script>
/** =========================
 *  ✅ 설정
 * ========================= */
const API_BASE   = "https://eis.qkr3069.workers.dev"; // ✅ /sheet/names, /rss 사용
const SHEET_ID   = "1kKsPK5Kxplgoutz4pkS8QqXTdC7Ai1jeaeaOJsZVgnI";
const SHEET_NAME = "omnicare_customer";

/** 샘플 로그인 */
const CURRENT_USER = { id:"u1", name:"김영업", team:"A팀", role:"sales" };
const NOW_YM = "2025-12";

/** =========================
 *  유틸
 * ========================= */
function toYMD(d){
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const dd=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${dd}`;
}
function stripHtml(s){ return (s || "").replace(/<[^>]*>/g, " ").replace(/\s+/g, " ").trim(); }
function ymdFromStr(dateStr){
  const d = new Date(dateStr);
  if (Number.isNaN(d.getTime())) return "";
  return toYMD(d);
}
function normalizeCompanyName(s){
  let x = (s || "").toString().trim();
  if (!x) return "";
  x = x.replace(/\u00A0/g, " ");
  x = x.replace(/\s+/g, " ").trim();
  if (x.length > 30) x = x.slice(0,30);
  return x;
}

/** =========================
 *  ✅ 시트(A2:A)에서 회사명 가져오기 (Worker 프록시)
 *  - GET /sheet/names?sheet_id=...&sheet_name=...&range=A2:A
 * ========================= */
const SHEET_CACHE_KEY = "omni.sheet.names.cache.v1";
const SHEET_CACHE_TTL_MS = 1000 * 60 * 60 * 6;

function saveCachedSheetNames(names){
  try{ localStorage.setItem(SHEET_CACHE_KEY, JSON.stringify({ t: Date.now(), names })); }catch(_e){}
}
function loadCachedSheetNames(){
  try{
    const raw = localStorage.getItem(SHEET_CACHE_KEY);
    if (!raw) return null;
    const obj = JSON.parse(raw);
    if (!obj?.t || !Array.isArray(obj?.names)) return null;
    if (Date.now() - obj.t > SHEET_CACHE_TTL_MS) return null;
    return obj.names;
  }catch(_e){
    return null;
  }
}
async function fetchCompanyNamesFromSheet(force=false){
  if (force){
    try{ localStorage.removeItem(SHEET_CACHE_KEY); }catch(_e){}
  }
  if (!force){
    const cached = loadCachedSheetNames();
    if (cached && cached.length) return cached;
  }

  const proxyUrl =
    `${API_BASE}/sheet/names?sheet_id=${encodeURIComponent(SHEET_ID)}` +
    `&sheet_name=${encodeURIComponent(SHEET_NAME)}` +
    `&range=${encodeURIComponent("A2:A")}` +
    `&_=${Date.now()}`;

  const r = await fetch(proxyUrl, { cache:"no-store" });
  const data = await r.json().catch(()=> ({}));
  if (!r.ok || !data?.ok) throw new Error(data?.error || `Sheet proxy failed: ${r.status}`);

  const set = new Set();
  const cleaned = [];
  for (const v of (data.names || [])){
    const nn = normalizeCompanyName(v);
    if (!nn) continue;
    if (set.has(nn)) continue;
    set.add(nn);
    cleaned.push(nn);
  }

  saveCachedSheetNames(cleaned);
  return cleaned;
}

/** =========================
 *  ✅ RSS 프록시로 XML 가져오기 + 파싱
 * ========================= */
async function fetchRssXmlViaWorker(rssUrl){
  const u = `${API_BASE}/rss?url=${encodeURIComponent(rssUrl)}&_=${Date.now()}`;
  const r = await fetch(u, { cache:"no-store" });
  if (!r.ok) throw new Error(`RSS proxy failed: ${r.status}`);
  return await r.text();
}
function parseRssItemsFromXml(xmlText){
  const doc = new DOMParser().parseFromString(xmlText, "text/xml");
  const items = Array.from(doc.querySelectorAll("item")).map(it => ({
    title: (it.querySelector("title")?.textContent || "").trim(),
    link: (it.querySelector("link")?.textContent || "").trim(),
    pubDate: (it.querySelector("pubDate")?.textContent || "").trim(),
    description: (it.querySelector("description")?.textContent || "").trim(),
    source: (it.querySelector("source")?.textContent || "").trim(),
  })).filter(x => x.title && x.link);
  return items;
}

/** =========================
 *  ✅ Google News RSS 생성
 * ========================= */
function buildGoogleNewsRssByTerms(terms){
  const q = terms.map(t => `"${t}"`).join(" OR ");
  return `https://news.google.com/rss/search?q=${encodeURIComponent(q)}&hl=ko&gl=KR&ceid=KR:ko`;
}

/** =========================
 *  ✅ 중복 제거 로직
 *  - link 기준(1차) + title 정규화(2차)로 중복 제거
 * ========================= */
function normTitleKey(s){
  return (s||"")
    .toLowerCase()
    .replace(/\s+/g," ")
    .replace(/[^\p{L}\p{N}\s]/gu,"") // 문자/숫자/공백만
    .trim();
}
function dedupeItems(items){
  const seenLink = new Set();
  const seenTitle = new Set();
  const out = [];
  for (const it of items){
    const link = (it.link || "").trim();
    const tk = normTitleKey(it.title);
    if (link && seenLink.has(link)) continue;
    if (tk && seenTitle.has(tk)) continue;
    if (link) seenLink.add(link);
    if (tk) seenTitle.add(tk);
    out.push(it);
  }
  return out;
}

/** =========================
 *  렌더
 * ========================= */
function render(items){
  const date = document.getElementById("datePicker").value;
  const q = (document.getElementById("q").value || "").trim().toLowerCase();
  const limit = parseInt(document.getElementById("limitSel").value,10) || 20;

  let list = items.slice();

  // 날짜 필터(해당 날짜만)
  const byDate = list.filter(it => ymdFromStr(it.pubDate) === date);
  list = byDate.length ? byDate : list;

  // 텍스트 검색(제목+요약)
  if (q){
    list = list.filter(it => {
      const t = (it.title||"").toLowerCase();
      const s = stripHtml(it.description||"").toLowerCase();
      return t.includes(q) || s.includes(q);
    });
  }

  list = list.slice(0, limit);

  const wrap = document.getElementById("list");
  const hint = document.getElementById("hint");
  wrap.innerHTML = "";

  if (!list.length){
    wrap.innerHTML = `<div class="muted">표시할 소식이 없습니다.</div>`;
    hint.textContent = "조건에 맞는 뉴스가 없습니다.";
    return;
  }

  list.forEach(it=>{
    const clean = stripHtml(it.description).slice(0, 140);
    const ymd = ymdFromStr(it.pubDate) || "-";
    const div = document.createElement("div");
    div.className = "newsItem";
    div.innerHTML = `
      <a class="newsLink newsTitle" href="${it.link}" target="_blank" rel="noopener">${it.title}</a>
      <div class="newsMeta">${ymd} · ${clean}${clean.length>=140?"...":""}</div>
    `;
    wrap.appendChild(div);
  });

  hint.textContent =
    `조회일 ${date} 기준 · 표시 ${list.length}건 (시트 키워드 기반 · 해당 날짜 기사가 부족하면 최신 기사로 대체될 수 있음)`;
}

let CACHE_ITEMS = [];
let LAST_META = { keywords:0, raw:0, deduped:0 };

/** =========================
 *  메인 로더
 * ========================= */
async function loadAccountNewsAll(force=false){
  const wrap = document.getElementById("list");
  const hint = document.getElementById("hint");
  wrap.innerHTML = `<div class="muted">불러오는 중…</div>`;
  hint.textContent = "";

  document.getElementById("sheetPill").textContent = `Sheet: ${SHEET_NAME} (A2:A)`;
  document.getElementById("kwPill").textContent = `키워드: -`;
  document.getElementById("dupPill").textContent = `중복 제거: -`;

  try{
    // 1) 시트 키워드
    const names = await fetchCompanyNamesFromSheet(force);

    // Google News RSS는 너무 길면 결과가 이상해질 수 있어 상한(안전)
    const terms = (names && names.length ? names : []).slice(0, 10);

    document.getElementById("kwPill").textContent = `키워드: ${terms.length}개`;

    // 2) RSS -> XML -> items
    const rss = buildGoogleNewsRssByTerms(terms);
    const xml = await fetchRssXmlViaWorker(rss);
    const rawItems = parseRssItemsFromXml(xml);

    // 3) 중복 제거
    const deduped = dedupeItems(rawItems);

    CACHE_ITEMS = deduped;

    LAST_META = { keywords: terms.length, raw: rawItems.length, deduped: deduped.length };
    document.getElementById("dupPill").textContent = `중복 제거: ${rawItems.length} → ${deduped.length}`;

    render(CACHE_ITEMS);
  }catch(e){
    wrap.innerHTML = `<div class="muted">불러오기에 실패했습니다.</div>`;
    hint.textContent = `오류: ${String(e?.message || e)}`;
  }
}

/** =========================
 *  init
 * ========================= */
function init(){
  document.getElementById("userLine").textContent =
    `${CURRENT_USER.name} · ${CURRENT_USER.team} · ${NOW_YM} 기준`;

  document.getElementById("datePicker").value = toYMD(new Date());

  document.getElementById("q").addEventListener("input", ()=> render(CACHE_ITEMS));
  document.getElementById("limitSel").addEventListener("change", ()=> render(CACHE_ITEMS));
  document.getElementById("datePicker").addEventListener("change", ()=> render(CACHE_ITEMS));

  loadAccountNewsAll(false);
}

init();
</script>
</body>
</html>
